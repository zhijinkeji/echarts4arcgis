// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/reportContainerStack/utils/ComparisonSectionProcessor","dojo/_base/lang ../../supportClasses/templateJsonUtils/query/TemplateJsonQueryUtil ../../sections/sectionUtils/SectionJsonUtil ../../supportClasses/tableJson/TableJsonUtil ../../infographics/InfographicTypes ../../infographics/utils/InfographicJsonConversionUtil ../../infographics/utils/InfographicLayoutResizer ../../infographics/utils/InfographicVariableLayoutUtil ../../infographics/utils/InfographicThemeUtil ../../grid/coreUtils/GridDataUtil esri/dijit/geoenrichment/ReportPlayer/config".split(" "),
function(t,m,l,v,p,w,x,r,y,z,A){function B(a){a=t.mixin({},a.getComparisonSettings());a.preserveRelativeSize=!1;a.equalizeVariableText=a.splitPanels;a.equalizeDescriptionText=a.splitPanels;(a.equalizeLayout=a.splitPanels)?(a.spaceOutFactor=null,a.scale=a.scaleSplit):(a.spaceOutFactor=1/a.scale,a.scale=null);return a}var f={getProcessor:function(a){return function(c){var b=B(a);c=f._filterSectionJsons(c,a.viewModel);c=c.map(function(a){var c=l.getSectionJsonInfographic(a);return c&&c.type===p.STATIC?
t.clone(a):a});b.spaceOutFactor&&1!==b.spaceOutFactor&&f._spaceOutSectionJsons(c,b);b.splitPanels&&(c=f._splitSectionJsons(c));c=f._equalizeSectionJsons(c,b,a.viewModel);b.hideBackgroundImage&&(c=f._hideBackgroundElements(c));b.scale&&1!==b.scale&&(c=f._zoomOutSectionJsons(c,b));return c}},_filterSectionJsons:function(a,c){var b=0;a.forEach(function(a){b+=m.calcNumberOfMapsInSectionJson(a)});var k=c.dynamicReportInfo.analysisAreas.filter(function(a){return!a.hidden}).length*b<=A.maps.maxNumberOfMapsShownAtTheSameTime;
return a.filter(function(a){if(a.stack&&a.stack.some(function(a){return a.isMap}))return k;var b=!1,g=!1;m.processSectionFieldInfos(a,function(a){a.isMap&&(g=!0);b=f._isComparableFieldInfo(a,c)||b});return g?k:b})},_isComparableFieldInfo:function(a,c){return a.isChart?!0:a.isInfographic?a.infographicJson.type===p.ATTACHMENTS?!1:a.infographicJson.type===p.AREA_DETAILS?c.dynamicReportInfo.attachmentsStore&&c.dynamicReportInfo.attachmentsStore.supportsMultipleAreas:!0:a.isMap||a.hasVariable?!0:!1},_spaceOutSectionJsons:function(a,
c){a.forEach(function(a){var b=l.getSectionJsonInfographic(a);if(b&&b.type===p.STATIC&&!(2>b.variableTables.length)){var d=c.spaceOutFactor,e=b.style.width,g=e*d,n=(g-e)/2;b.header&&(b.header.data.columns[0].style.width="100%",b.header.style.left=-n,b.header.style.width=g);b.variableTables.forEach(function(a){a.style.left=a.style.left*d-n+(a.style.width*d-a.style.width)/2});b=m.getParentBox(a);f._applyParentBoxWidth(a,b.w*d)}})},_splitSectionJsons:function(a){var c=[];a.forEach(function(a){var b=
l.getSectionJsonInfographic(a);if(b&&b.type===p.STATIC){var d=b.variableTables;if(b.header){var e=b.header;if(e.data.data[0][e.data.columns[0].field]||e.data.data[0].fieldInfos&&e.data.data[0].fieldInfos[e.data.columns[0].field]){e=t.clone(a);b=l.getSectionJsonInfographic(e);b.variableTables=[];var b=v.calcTableBox(b.header),g=m.getParentBox(e);g.y+=b.y;g.h=b.h;m.setParentBox(e,g);c.push(e)}}d.forEach(function(b,g){b=t.clone(a);var n=l.getSectionJsonInfographicTable(b),e=l.getSectionJsonInfographic(b);
delete e.header;e.variableTables=[e.variableTables[g]];var h=e.variableTables[0];g=w.variableTableToNormalTables(h);e=l.wrapInDetailsSectionJson(g.tableJsons);e.style=h.style;var d=l.calcSectionJsonBox(e),e=h.variable.style.horizontalAlign||"left";g=Math.min(1.75,(d.contentW+(g.isVariableInShape||"left"===e?2*h.variable.style.width:h.variable.style.width))/d.contentW);z.isNumericVariableFieldCell(h.variable.fieldInfo)||(g=1);var k=n.style.left+(d.x+d.contentLeft)-d.contentW*(g-1)/2,f=n.style.top+
(d.y+d.contentTop);n.style.left=0;n.style.top=0;h.style.left=d.contentW*(g-1)/2;h.style.top=0;x.VARIABLE_TABLE_ELEMENTS.forEach(function(a){h[a]&&(h[a].style.left-=d.contentLeft,h[a].style.top-=d.contentTop)});b.stack.filter(function(a){return a!==n}).forEach(function(a){a.style.left-=k;a.style.top-=f});e=m.getParentBox(b);e.x+=k;e.y+=f;e.w=d.contentW*g;e.h=d.contentH;m.setParentBox(b,e);c.push(b)})}else c.push(a)});return c},_zoomOutSectionJsons:function(a,c){return a.map(function(a){var b=l.getSectionJsonInfographic(a);
b&&b.type===p.STATIC&&(b=m.getParentBox(a),f._applyParentBoxWidth(a,b.w/c.scale));return a})},_equalizeSectionJsons:function(a,c,b){var k=[],d=[];a=a.map(function(a){var b=l.getSectionJsonInfographic(a);b&&b.type===p.STATIC&&(c.splitPanels?b.header?k.push(a):d.push(a):d.push(a));return a});c.preserveRelativeSize&&(f._equalizeBox(k),f._equalizeBox(d));c.equalizeVariableText&&(f._equalizeVariableAndHeaderText(k,b,!0),f._equalizeVariableAndHeaderText(d,b,!1));c.equalizeDescriptionText&&f._equalizeDescriptionText(d,
b);c.equalizeIcons&&f._equalizeIcons(d,b);c.equalizeLayout&&f._equalizeLayout(d,b);return a},_equalizeBox:function(a){var c=0;a.forEach(function(a){a=m.getParentBox(a);c=Math.max(c,a.w)});a.forEach(function(a){f._applyParentBoxWidth(a,c)})},_equalizeVariableAndHeaderText:function(a,c,b){function k(a){return f._getFont(a,c,d,b?"header":"variable")}var d=0;a.forEach(function(a){a=m.getParentBox(a);d=Math.max(d,a.w)});var e=Infinity,g;a.forEach(function(a){if(a=k(a))e=Math.min(e,a.fontSize),a.isBold||
(g=!0)});a.forEach(function(a){var c=k(a);c&&(c=m.getParentBox(a).w*c.fontSize/e,f._applyParentBoxWidth(a,c),!b&&g&&(l.getSectionJsonInfographic(a).variableTables[0].variable.style.fontWeight="normal"))})},_applyParentBoxWidth:function(a,c){var b=m.getParentBox(a),k=(b.w-c)/2,d=l.getSectionJsonInfographicTable(a);d.style.left-=k;a.stack.filter(function(a){return a!==d}).forEach(function(a){a.style.left-=k});b.x+=k;b.w=c;m.setParentBox(a,b)},_equalizeDescriptionText:function(a,c){var b=0;a.forEach(function(a){a=
m.getParentBox(a);b=Math.max(b,a.w)});var k=Infinity,d;a.forEach(function(a){if(a=f._getFont(a,c,b,"description"))k=Math.min(k,a.fontSize),a.isBold||(d=!0)});a.forEach(function(a){var g=l.getSectionJsonInfographic(a).variableTables[0].description;g&&(a=m.getParentBox(a).w/b,g.style.fontSize=k*a,d&&(g.style.fontWeight="normal"))})},_getFont:function(a,c,b,k){var d=m.getParentBox(a);a=l.getSectionJsonInfographic(a);y.applyThemeSettingsToJson(a,c.getInfographicDefaultStyles().staticInfographic);var e,
g;if("header"===k)g=a.header.data.data[0],c=a.header.data.columns[0].field,e=g.style.fields[c].fontSize||g.themeStyle&&g.themeStyle.fields[c].fontSize,g=g.style.fields[c].fontWeight||g.themeStyle&&g.themeStyle.fields[c].fontWeight;else if(c=a.variableTables[0][k])e=c.style.fontSize||c.themeStyle&&c.themeStyle.fontSize,g=c.style.fontWeight||c.themeStyle&&c.themeStyle.fontWeight;b/=d.w;return e&&{fontSize:(e||0)*b,isBold:"bold"===g}},_equalizeIcons:function(a,c){function b(a,b){if(d[b])return d[b];
var g=m.getParentBox(a);a=l.getSectionJsonInfographic(a).variableTables[0];a=r.hasIcon(a)&&a.shape;return a&&a.shapeJson&&!a.shapeJson.showAsBar?(a=r.getActualShapeBox(a,c))?d[b]={areaFactor:k/g.w*Math.sqrt(a.w*a.h)}:null:null}a=a.filter(function(a){a=l.getSectionJsonInfographic(a);return!r.isVariableInShape(a.variableTables[0])});var k=0;a.forEach(function(a){a=m.getParentBox(a);k=Math.max(k,a.w)});var d=[],e=Infinity;a.forEach(function(a,c){(a=b(a,c))&&(e=Math.min(e,a.areaFactor))});a.forEach(function(a,
c){var h=l.getSectionJsonInfographic(a).variableTables[0];if(a=(h=r.hasIcon(h)&&h.shape)&&b(a,c)){a=e/a.areaFactor;c=(h.style.width-h.style.width*a)/2;var d=(h.style.height-h.style.height*a)/2;h.style.width*=a;h.style.height*=a;h.style.left+=c;h.style.top+=d}})},_equalizeLayout:function(a,c){a=a.filter(function(a){a=l.getSectionJsonInfographic(a).variableTables[0];var b=r.hasIcon(a)&&a.shape;if(b&&b.shapeJson&&b.shapeJson.showAsBar)return!1;a=r.getClosestId(a,"custom");return"v1"===a||"v4"===a});
var b=0;a.forEach(function(a){a=m.getParentBox(a);b=Math.max(b,a.w)});var k=0,d=0,e=0,g=0;a.forEach(function(a,c){c=m.getParentBox(a);c=b/c.w;a=l.getSectionJsonInfographic(a).variableTables[0];a=r.getBoxes(a);a.iconBox&&(k=Math.max(k,a.iconBox.h*c),d=Math.max(d,a.iconBox.w*c));e=Math.max(e,a.variableBox.h*c);g=Math.max(g,a.descriptionBox.h*c)});a.forEach(function(a,c){c=m.getParentBox(a);var h=b/c.w,f=l.getSectionJsonInfographic(a).variableTables[0],p=r.getBoxes(f),q=r.hasIcon(f)&&(f.shape||f.image);
if(q&&(q.style.height=k/h,q.style.width=d/h,f.image&&f.image.imageJson)){var n=f.image.imageJson.style=f.image.imageJson.style||{};n.left=0;n.top=0;n.width=q.style.width;n.height=q.style.height}f.variable.style.height=e/h;f.description.style.height=g/h;q?(q.style.top=0,f.variable.style.top=q.style.top+q.style.height):f.variable.style.top=0;f.description.style.top=f.variable.style.top+f.variable.style.height;var f=r.getBoxes(f),n=0,u=-10/h;q&&(q.style.left-=(f.iconBox.w-p.iconBox.w)/2,u+=f.iconBox.y-
p.iconBox.y,n=-u);n+=f.descriptionBox.y+f.descriptionBox.h-p.descriptionBox.y-p.descriptionBox.h;c.y+=u;c.h+=n;m.setParentBox(a,c);var t=l.getSectionJsonInfographicTable(a);t.style.top-=u;a.stack.filter(function(a){return a!==t}).forEach(function(a){a.style.top-=u})})},_hideBackgroundElements:function(a){return a.map(function(a){var b=l.getSectionJsonInfographic(a);b&&b.type===p.STATIC&&(a.stack=[l.getSectionJsonInfographicTable(a)]);return a})}};return f});