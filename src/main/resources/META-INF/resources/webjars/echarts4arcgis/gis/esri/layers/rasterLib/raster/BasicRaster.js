// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterLib/raster/BasicRaster","require dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/config dojo/_base/json dojo/sniff dojo/DeferredList dojo/when ../../../kernel ../../../Evented ../../../request ../../../geometry/Extent ../../../geometry/Point ../../../SpatialReference ../../../deferredUtils ../../../urlUtils ../../MosaicRule ../../ImageServiceParameters ../../PixelBlock ../../rasterFormats/rasterCodec ../tile/RasterHandler ./rasterProjectionHelper ./RasterInfo".split(" "),
function(y,q,h,l,z,A,B,C,D,E,m,r,t,n,F,G,k,u,H,I,v,w,x,e,J){return q([r],{url:null,dataType:null,rasterInfo:null,tileInfo:null,serviceInfo:null,loaded:null,constructor:function(b){if(b){var a=b.url;a&&(a=u.urlToObject(a),this.url=a.path,this._query=a.query);this.dataType=b.dataType;this.serviceInfo=b.serviceInfo;this.rasterInfo=b.rasterInfo;this.tileInfo=b.tileInfo;this.serviceInfo=b.serviceInfo}},open:function(){},read:function(b){},identify:function(b){var a=new l,d=this.rasterInfo.extent,f;e.requirePE(d.spatialReference,
b.spatialReference)?e.load().then(h.hitch(this,function(){f=e.project(b,d.spatialReference);a.resolve(f)}),function(){a.reject(Error("cannot project into this spatial reference"))}):(f=e.project(b,d.spatialReference),a.resolve(f));return a.then(h.hitch(this,function(b){var a=this.tileInfo,c=a.origin,g=a.lods[a.lods.length-1],f=(b.x-c.x)/a.cols/g.resolution;b=(c.y-b.y)/a.rows/g.resolution;var e=Math.round((b-Math.floor(b))*a.rows)*a.cols+Math.round((f-Math.floor(f))*a.cols),c=new n(c.x+g.resolution*
a.cols*f,c.y-g.resolution*a.rows*(b+1),c.x+g.resolution*a.cols*(f+1),c.y-g.resolution*a.rows*b,d.spatialReference),h=this.getMemberRasters?this.getMemberRasters()[0]:this;return h.read({level:g.level,row:Math.floor(b),col:Math.floor(f),extent:c,width:a.cols,height:a.rows,virtual:h.tileInfo.virtual,tileType:h.tileInfo.tileType}).then(function(a){return(a=a&&a.pixelBlock)&&a.pixels&&0<a.pixels.length&&!a.mask||a.mask[e]?{pixelValue:a.pixels.map(function(a){return a[e]})}:{pixelValue:null}})}))},getProjectedFullExtent:function(b,
a){var d=new l;if(this.projectedFullExtent&&!a)return d.resolve(this.projectedFullExtent),d.promise;var f=this.rasterInfo.extent,c;e.requirePE(this.rasterInfo.extent.spatialReference,b)?e.load().then(h.hitch(this,function(){c=e.project(f,b);this.projectedFullExtent=c=new n(c.toJson());d.resolve(c)}),function(){d.reject(Error("cannot project into this spatial reference"))}):(c=e.project(f,b),d.resolve(c));return d.promise},setFetchParameters:function(b,a){},_setRasterHandler:function(b){this._rasterHandler=
b;this.getMemberRasters&&this.getMemberRasters().forEach(h.hitch(this,function(a){a._rasterHandler=b}))},_findCredential:function(){this.url&&((this._credential=m.id&&m.id.findCredential(this.url))&&this._credential.ssl||this.serviceInfo&&this.serviceInfo._ssl)&&(this.url=this.url.replace(/^http:/i,"https:"))},_initWorker:function(){this._rasterHandler=new x;this._rasterHandler.start().then(function(){this._rasterHandlerInitialized=!0}.bind(this))},_requestPixels:function(b){var a=b.url,d=b.payload,
f=b.decodeParams,c=b.tileOptions,e=new l(k._dfdCanceller);this._rasterHandler||this._initWorker();var p=this._rasterHandler,g={},a={url:a,handleAs:"arraybuffer",content:d};b.headers&&(a.headers=b.headers);e._pendingDfd=t(a).then(h.hitch(this,function(a){(p&&this._rasterHandlerInitialized?p.decode({encodedData:a,decodeParams:f}):w.decode(a,f)).then(function(a){g.pixelBlock=new v(a);g.extent=c.extent;g.level=c.level;g.row=c.row;g.col=c.col;g.width=c.width;g.height=c.height;k._resDfd(e,[g])},function(a){k._resDfd(e,
[a],!0)})}),function(a){k._resDfd(e,[a],!0)});return e},_computeSignature:function(b){if("string"===typeof b){for(var a=new Uint8Array(b.length),d=0;d<b.length;d++)a[d]=b.charCodeAt(d);b=a}for(var d=a=65535,f=b.length,c=Math.floor(f/2),e=0;c;){var h=359<=c?359:c,c=c-h;do a+=b[e++]<<8,d+=a+=b[e++];while(--h);a=(a&65535)+(a>>>16);d=(d&65535)+(d>>>16)}f&1&&(d+=a+=b[e]<<8);return((d&65535)+(d>>>16)<<16|(a&65535)+(a>>>16))>>>0}})});