// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/commands/CreateHTMLCommand","require dojo/_base/declare esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when ./createHTML/CommandMode ../../PlayerCommands ./supportClasses/ProgressSteps ../../core/supportClasses/images/ImageDataHolder ../supportClasses/GEUtil dojo/i18n!esri/nls/jsapi".split(" "),function(A,B,C,d,p,D,f,E,r,g){function F(){var c=new C;A(["dijit/Dialog","./createHTML/HTMLToSVGBuilder","./createHTML/HTMLStringBuilder",
"esri/dijit/geoenrichment/utils/FileUtil","./mapToImage/MapToImageUtil"],function(b,d,a,f,e){l=b;t=d;q=a;w=f;h=e;c.resolve()});return c.promise}g=g.geoenrichment.dijit.ReportPlayer.ReportPlayer;var l,t,q,w,h;return B(null,{id:D.HTML,errorMessage:g.exportInfographicError,exportMapErrorMessage:g.exportMapError,_player:null,_saveFiles:!0,_stopPrintableContainer:!0,_printableContainer:null,_mode:p.SVG_IN_HTML,_requestSizeLimit:0,_mergePageIndexes:!0,_convertUrlImages:!1,_hideUrlImages:!1,_replaceImagesWithItemResources:!1,
_replaceMapsWithJson:!1,_currentProgressBack:null,execute:function(c,b,g){var a=this;return F().then(function(){function l(){return d(k&&k.undo(),function(){return d(a._stopPrintableContainer&&e&&e.stop(),function(b){a._stepFinished(f.UNSET_LAYOUT);return b})})}this._player=c;var e,k;this._currentProgressBack=g;var n={svgInHtmlString:null,svgStrings:null,documentOptions:null,additionalFiles:null};return d(function(){e=b.printableContainer;a._printableContainer=e;h.enableCaching();var m=a._replaceMapsWithJson&&
(c.isPlayerOnServer||r.getClient().hasCapability("FormatInfographicsMaps"));return d(h.replaceMapWithImage(c,{replaceWithJson:m,saveImagesAsDataUrl:!m,printMapTaskUrl:b.printMapTaskUrl}),function(b){k=b;h.clearCaching();a._stepFinished(f.REPLACE_MAPS)})}(),function(){if(e)return d(q.buildHtmlStringForPlayer(e,a._mergePageIndexes),function(m){function g(c,x){if(!b.returnAsHtmlText&&!b.returnAsSvgText&&a._saveFiles&&c)return a._confirmSaveFile(x,function(){return w.saveTextFile(c,x)})}function k(){var b=
h+".svg";return d(t.htmlToSvg(m.domString,e.getFitParams(),a._requestSizeLimit,y,v,a._hideUrlImages,q&&z),function(a){n.svgStrings=a;return g(a[0],b)})}function l(){var b=h+".html";return d(t.htmlToSvgInHtml(m.domString,h,e.getFitParams(),a._requestSizeLimit,y,v,a._hideUrlImages,q&&z),function(a){n.svgInHtmlString=a;return g(a,b)})}if(m.domString){a._stepFinished(f.PREPARE_DOM);var h=c.getReportTitle(),v=a._convertUrlImages||!r.getClient().hasCapability("FormatInfographicsImageUrls"),q=a._replaceImagesWithItemResources&&
r.getClient().hasCapability("FormatInfographicsImageUrls"),y=function(b,c){a._stepFinished(f.RENDER_PAGE,b+1,c)},z=function(a){a=E.findFileNameByData(a);var b=c.getReportData().reportObject;return a&&b.templateData&&b.templateData.getItemResourceUrl(a,!0)};n.documentOptions=e.getDocumentOptions();var u=a._mode;b.returnAsHtmlText&&(u=p.SVG_IN_HTML);b.returnAsSvgText&&(u=p.SVG);switch(u){case p.SVG:return k();case p.SVG_IN_HTML:return l()}}})}).otherwise(function(c){return!b.skipErrorNotification&&
a._handleError(c)}).always(function(){return d(l(),function(){return k&&k.errors.length?(!b.skipErrorNotification&&a._handleExportMapError(k.errors[0]),null):b.returnAsHtmlText?n.svgInHtmlString:b.returnAsSvgText?n.svgStrings:n})})}.bind(this))},_stepFinished:function(c,b,d){if(this._currentProgressBack){var a=0;switch(c){case f.REPLACE_MAPS:a=10;break;case f.PREPARE_DOM:a=20;break;case f.RENDER_PAGE:a=20+70*b/d;break;case f.UNSET_LAYOUT:a=100}this._currentProgressBack(a/100)}},_handleError:function(c){console.log(c);
(new l({title:"Error",content:this.errorMessage})).show()},_handleExportMapError:function(c){console.log(c);(new l({title:"Error",content:this.exportMapErrorMessage})).show()},_confirmSaveFile:function(c,b,d){return b()}})});