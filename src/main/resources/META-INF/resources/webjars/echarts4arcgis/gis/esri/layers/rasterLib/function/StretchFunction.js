// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterLib/function/StretchFunction","dojo/_base/declare dojo/_base/lang ./RasterFunctionX ../../PixelBlock ./vertexShaders ./pixelShaders ./RasterFunctionWebGLMixin".split(" "),function(A,y,B,C,H,z,D){return A([B,D],{declaredClass:"esri.layers.rasterLib.function.StretchFunction",functionName:"Stretch",supportWebGL:!0,support2D:!0,constructor:function(a){this.functionArguments=this.mixinIgnoreCase({stretchType:0,min:0,max:255,numberOfStandardDeviations:2,statistics:null,histograms:null,
dra:!1,minPercent:.25,maxPercent:.5,useGamma:!1,gamma:null,raster:null,computeGamma:!1},a);this.functionArguments.statistics=this._convertStats(this.functionArguments.statistics);-1===[0,3,5,6].indexOf(this.functionArguments.stretchType)&&(console.error("The specific stretch type has not been implemented: "+this.functionArguments.stretchType),this.functionArguments.stretchType=5);this.min=null==this.min?0:this.min;this.max=null==this.max?255:this.max},bind:function(a){a=this.getSourceRasterInfo(a);
if(!a.raster)return Error("The raster input to stretch function is invalid.");a.raster.statistics&&(this.srcStatistics=a.raster.statistics);a.raster.histograms&&(this.srcHistograms=a.raster.histograms);this.rasterInfo=y.mixin(a.raster,{bandCount:a.raster.bandCount,pixelType:this._calculatePixelType(this.pixelType,"U8"),statistics:null,histograms:null});this.rasterInfo.keyProperties=this.rasterInfo.keyProperties||{};this.rasterInfo.keyProperties.DataType="Generic";return!0},read2D:function(a){a=a.raster;
this._stretch(a);return a},hasTilingEffects:function(a){a=a||this.functionArguments;return!!(a.dra||a.raster&&"object"===typeof a.raster&&a.raster.dra)},_convertStats:function(a){return a?a.map(function(a){return a&&null!=a.min?[a.min,a.max,a.mean,a.stddev]:a}):null},_updateStatistisHistograms:function(a){var e=this.functionArguments,c=e.histograms||this.srcHistograms;if(a&&a.pixelBlock&&a.pixelBlock.pixels){if(0===e.stretchType)this._statistics=e.statistics&&0<e.statistics.length?e.statistics:this.srcStatistics,
this._histograms=c;else{var b=a.pixelBlock,l=b.pixels.length,k=6===e.stretchType&&(e.dra||!c)||3===e.stretchType&&e.dra;k&&(b.statistics||b.calculateStatistics(),this._calculateStatisticsHistograms(a));if(e.dra)if(b.statistics||b.calculateStatistics(),k)this._statistics=b.statistics,this._histograms=b.histograms;else for(e=b.statistics,this._statistics=[],a=0;a<l;a++)this._statistics[a]=[e[a].minValue,e[a].maxValue,0,0];else this._statistics=e.statistics&&0<e.statistics.length?e.statistics:this.srcStatistics,
this._histograms=c}this._statistics=this._convertStats(this._statistics);this._gammaCorrection=this._getGammaCorrection()}else this._statistics=e.statistics&&0<e.statistics.length?e.statistics:this.srcStatistics,this._histograms=c,this._gammaCorrection=this._getGammaCorrection(),this._statistics=this._convertStats(this._statistics)},_getGammaCorrection:function(){var a=this.functionArguments.gamma;if(a){var e=[],c;for(c=0;c<a.length;c++)e[c]=1<a[c]?2<a[c]?6.5+Math.pow(a[c]-2,2.5):6.5+100*Math.pow(2-
a[c],4):1;return e}},_stretch:function(a){if(null!==a&&null!==a.pixelBlock&&null!==a.pixelBlock.pixels&&0!==this.functionArguments.stretchType){this._updateStatistisHistograms(a);var e=a.pixelBlock,c=e.pixels,e=e.width*e.height,b=c.length,l,k;this._createLUT(a);if(null==this.LUT)return this._filterNoLUT(a);var h=this.LUT,g=this.LUTOffset,d,f;for(l=0;l<b;l++)for(f=h[l],k=0;k<e;k++)d=c[l][k],c[l][k]=f[d-g];a.pixelBlock.pixelType="U8"}},_calculateStatisticsHistograms:function(a){a=a.pixelBlock;var e=
a.pixelType,c=a.pixels,b=a.mask,l=c.length,k,h,g,d,f=function(a){this.min=-.5;this.max=255.5;this.size=256;y.mixin(this,a);this.counts=this.counts||new Uint32Array(this.size)},m=[],n,q,p,r,t,u;for(g=0;g<l;g++){n=new f;q=n.counts;r=c[g];if("U8"===e)if(b)for(d=0;d<a.width*a.height;d++)b[d]&&q[r[d]]++;else for(d=0;d<a.width*a.height;d++)q[r[d]]++;else{k=a.statistics[g].minValue;h=a.statistics[g].maxValue;n.min=k;n.max=h;h=(h-k)/256;p=new Uint32Array(257);if(b)for(d=0;d<a.width*a.height;d++)b[d]&&p[Math.floor((r[d]-
k)/h)]++;else for(d=0;d<a.width*a.height;d++)p[Math.floor((r[d]-k)/h)]++;for(d=0;255>d;d++)q[d]=p[d];q[255]=p[255]+p[256]}m.push(n);r=[];k=a.statistics[g].minValue;h=a.statistics[g].maxValue;for(d=u=t=p=0;d<n.size;d++)p+=q[d],t+=d*q[d];t/=p;for(d=0;d<n.size;d++)u+=q[d]*Math.pow(d-t,2);q=Math.sqrt(u/(p-1));d=(t+.5)*(n.max-n.min)/n.size+n.min;n=q*(n.max-n.min)/n.size;r.push(k);r.push(h);r.push(d);r.push(n);a.statistics[g]={min:k,minValue:k,max:h,maxValue:h,mean:d,stddev:n}}a.histograms=m},_getCutOffPoints:function(a){var e=
this.functionArguments,c=999;a&&a.pixelBlock?c=a.pixelBlock.pixels.length:a&&a.texture&&(c=3);a=Math.min(c,this._statistics.length);var b=[],l=[],k,h,g,d,f,m;switch(e.stretchType){case 5:for(f=0;f<a;f++)b[f]=this._statistics[f][0],l[f]=this._statistics[f][1];break;case 3:for(f=0;f<a;f++)b[f]=this._statistics[f][2]-e.numberOfStandardDeviations*this._statistics[f][3],l[f]=this._statistics[f][2]+e.numberOfStandardDeviations*this._statistics[f][3],b[f]<this._statistics[f][0]&&(b[f]=this._statistics[f][0]),
l[f]>this._statistics[f][1]&&(l[f]=this._statistics[f][1]);break;case 6:for(f=0;f<a;f++){c=this._histograms[f];g=new Uint32Array(c.size);h=c.counts;k=0;d=-.5===c.min&&1===(c.max-c.min)/h?.5:0;for(m=0;m<c.size;m++)k+=h[m],g[m]=k;h=e.minPercent*k/100;for(m=0;m<c.size;m++)if(g[m]>h){b[f]=c.min+(c.max-c.min)/c.size*(m+d);break}h=(1-e.maxPercent/100)*k;for(m=c.size-2;0<=m;m--)if(g[m]<h){l[f]=c.min+(c.max-c.min)/c.size*(m+2-d);break}}break;default:for(f=0;f<c;f++)b[f]=0,l[f]=255}return{minCutOff:b,maxCutOff:l}},
_createLUT:function(a){var e=this.functionArguments,c=a.pixelBlock,b=c.pixelType;if("U8"===b||"U16"===b||"S8"===b||"S16"===b){if(this._LUTSignature&&(b=this._computeLutSignature(),b.length===this._LUTSignature.length&&!b.some(function(a,b){return a!==this._LUTSignature[b]}.bind(this))))return;var b=c.pixels.length,l=[],k=[],h,g,d=e.max,f=e.min,m=e.gamma,n=d-f,q=this._getCutOffPoints(a);a=q.minCutOff;var q=q.maxCutOff,p=0,r=256,t;"S8"===c.pixelType?p=-127:"S16"===c.pixelType&&(p=-32767);if("U16"===
c.pixelType||"S16"===c.pixelType)r=65536;for(c=0;c<b;c++)l[c]=q[c]-a[c];var u=this._gammaCorrection;if(e.useGamma)for(var v,c=0;c<b;c++){t=[];for(e=0;e<r;e++)h=e+p,v=(h-a[c])/l[c],g=1,1<m[c]&&(g-=Math.pow(1/n,v*u[c])),h<q[c]&&h>a[c]?t[e]=Math.floor(g*n*Math.pow(v,1/m[c]))+f:h>q[c]?t[e]=d:h<a[c]&&(t[e]=f);k[c]=t}else for(c=0;c<b;c++){t=[];for(e=0;e<r;e++)h=e+p,t[e]=h<a[c]?f:h>q[c]?d:Math.floor((h-a[c])/l[c]*n)+f;k[c]=t}this.LUT=k;this.LUTOffset=p;this._LUTSignature=this._computeLutSignature()}},_computeLutSignature:function(){var a=
this.functionArguments,e=[],c,b;e.push(a.stretchType);e.push(a.min);e.push(a.max);e.push(a.numberOfStandardDeviations);if(this._statistics)for(c=0;c<this._statistics.length;c++)for(b=0;b<this._statistics[c].length;b++)e.push(this._statistics[c][b]);e.push(a.dra?1:0);e.push(a.minPercent);e.push(a.maxPercent);if(a.gamma)for(c=0;c<this._statistics.length;c++)e.push(a.gamma[c]);e.push(a.useGamma?1:0);return e},_filterNoLUT:function(a){if(null!==a&&null!==a.pixelBlock&&null!==a.pixelBlock.pixels){var e=
this.functionArguments,c=a.pixelBlock,b=c.pixels,l=c.mask,c=c.width*c.height,k=b.length,h=[],g=[],d,f,m,n,q=e.max,p=e.min,r=e.gamma,t=q-p;d=this._getCutOffPoints(a);var u=d.minCutOff,v=d.maxCutOff;for(d=0;d<k;d++)h[d]=v[d]-u[d];if(e.useGamma&&null!==r&&r.length>=k)for(d=0;d<k;d++)g[d]=1<r[d]?2<r[d]?6.5+Math.pow(r[d]-2,2.5):6.5+100*Math.pow(2-r[d],4):1;if(e.useGamma)if(void 0!==l&&null!==l)for(e=0;e<c;e++){if(l[e])for(d=0;d<k;d++)f=b[d][e],n=(f-u[d])/h[d],m=1,1<r[d]&&(m-=Math.pow(1/t,n*g[d])),f<v[d]&&
f>u[d]?b[d][e]=Math.floor(m*t*Math.pow(n,1/r[d]))+p:f>v[d]?b[d][e]=q:f<u[d]&&(b[d][e]=p)}else for(e=0;e<c;e++)for(d=0;d<k;d++)f=b[d][e],n=(f-u[d])/h[d],m=1,1<r[d]&&(m-=Math.pow(1/t,n*g[d])),f<v[d]&&f>u[d]?b[d][e]=Math.floor(m*t*Math.pow(n,1/r[d]))+p:f>v[d]?b[d][e]=q:f<u[d]&&(b[d][e]=p);else if(void 0!==l&&null!==l)for(e=0;e<c;e++){if(l[e])for(d=0;d<k;d++)f=b[d][e],f<v[d]&&f>u[d]?b[d][e]=Math.floor((f-u[d])/h[d]*t)+p:f>v[d]?b[d][e]=q:f<u[d]&&(b[d][e]=p)}else for(e=0;e<c;e++)for(d=0;d<k;d++)f=b[d][e],
f<v[d]&&f>u[d]?b[d][e]=Math.floor((f-u[d])/h[d]*t)+p:f>v[d]?b[d][e]=q:f<u[d]&&(b[d][e]=p);a.pixelBlock.pixelType="U8";return a}},_computeGammaValues:function(a){var e=this._statistics.length,c,b=[],l;for(c=0;c<e;c++)l=this._statistics[c][2],"U8"!==a&&(l=255*(l-this._statistics[c][0])/(this._statistics[c][1]-this._statistics[c][0])),b.push(this._computeGammaValue(l));return b},_computeGammaValue:function(a){if(0!==a&&!(255<a||0>a)){var e=0;0<a&&150!=a&&255>a&&(e=150>=a?45*Math.cos(.01047*a):17*Math.sin(.021*
a));e=Math.log((a+e)/255);if(0!==e&&(a=Math.log(a/255)/e,!isNaN(a)))return Math.min(9.9,Math.max(.01,a))}},readGL:function(a){return this._stretchGL(a.raster)},_stretchGL:function(a){this._performance.start();var e=this.renderTexture,c,b,l,k=this.sourceRasterInfo.raster.bandCount,h=a.pixelBlock,g=this.gl,d=g.drawingBufferWidth,f=g.drawingBufferHeight;if(!h&&this.functionArguments.dra){var m=new Float32Array(d*f*4);b=new Uint8Array(d*f);l=new Float32Array(d*f);var n=new Float32Array(d*f),q=new Float32Array(d*
f);g.checkFramebufferStatus(g.FRAMEBUFFER)==g.FRAMEBUFFER_COMPLETE&&g.readPixels(0,0,d,f,g.RGBA,g.FLOAT,m);for(c=0;c<d*f;c++)l[c]=m[4*c],n[c]=m[4*c+1],q[c]=m[4*c+2],b[c]=m[4*c+3];a.pixelBlock=new C({width:d,height:f,pixels:[l,n,q],mask:b});a.pixelBlock.calculateStatistics()}!h&&this.functionArguments.dra&&this._useGPUStats?(b=new Float32Array(k),l=new Float32Array(k)):(this._updateStatistisHistograms(a),c=this._getCutOffPoints(a),b=new Float32Array(k),l=new Float32Array(k),b.set(c.minCutOff.slice(0,
k)),l.set(c.maxCutOff.slice(0,k)));this._initializeProgram({fragment:z.stretch,fragmentName:"Stretch"});m=this._setupTextureData(a);this.renderTexture=!1;c=g.getUniformLocation(this.rasterProgram,"u_image");g.uniform1i(c,0);g.activeTexture(g.TEXTURE0);var p,r;this._performance.start();!h&&this.functionArguments.dra&&this._useGPUStats&&(this._setUniforms({u_sourceDim:[d,f],u_bandCount:k}),1===k?p=this._readMinMax(m,2):(p=this._readMinMax(m,0),r=this._readMinMax(m,1)),6===this.functionArguments.stretchType||
3===this.functionArguments.stretchType&&this.functionArguments.dra)&&(c=this._readHistogram(p,r,a),b=c.minCutOff||b,l=c.minCutOff||l);n=this.functionArguments.max-this.functionArguments.min;a=new Float32Array(k);for(c=0;c<k;c++)a[c]=n/(l[c]-b[c]);this._initializeProgram({fragment:z.stretch,fragmentName:"Stretch"});g.blendFunc(g.SRC_ALPHA,g.ZERO);n=new Float32Array(3);q=new Float32Array(3);for(c=0;3>c;c++)n[c]=this.functionArguments.min,q[c]=this.functionArguments.max;this._setUniforms({u_sourceDim:[d,
f],u_bandCount:k,u_minOutput:n,u_maxOutput:q,u_minCutOff:b,u_maxCutOff:l,u_factor:a,u_state:100,u_useGamma:this.functionArguments.useGamma,u_gamma:this.functionArguments.gamma,u_scaled:!e,u_gammaCorrection:this._gammaCorrection,u_minMaxTexture:!h&&this.functionArguments.dra&&this._useGPUStats?!0:!1});this.renderTexture=e;g.viewport(0,0,d,f);g.activeTexture(g.TEXTURE0);g.bindTexture(g.TEXTURE_2D,m.texture);!h&&this.functionArguments.dra&&this._useGPUStats&&(e=g.getUniformLocation(this.rasterProgram,
"u_image1"),g.uniform1i(e,1),g.activeTexture(g.TEXTURE1),g.bindTexture(g.TEXTURE_2D,p.texture),1<k&&(k=g.getUniformLocation(this.rasterProgram,"u_image2"),g.uniform1i(k,2),g.activeTexture(g.TEXTURE2),g.bindTexture(g.TEXTURE_2D,r.texture)));g=this.bindFrameBuffer();this._drawGL();return{extent:m.extent,texture:g.texture}},_readMinMax:function(a,e){var c=this.gl,b=a.width||c.drawingBufferWidth,l=a.height||c.drawingBufferHeight;this._setUniforms({u_state:e});this.renderTexture=!1;var k,h,g=a.texture;
for(c.activeTexture(c.TEXTURE0);1<b||1<l;)k=this._createTexture(),e=Math.max(Math.ceil(b/2),1),h=Math.max(Math.ceil(l/2),1),c.getExtension("OES_texture_float"),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,e,h,0,c.RGBA,c.FLOAT,null),a=c.createFramebuffer(),c.bindFramebuffer(c.FRAMEBUFFER,a),c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,k,0),c.viewport(0,0,e,h),c.bindTexture(c.TEXTURE_2D,g),this._setUniforms({u_sourceDim:[b,l]}),b=e,l=h,this._drawGL(!0),g=k;a=new Float32Array(b*l*4);c.checkFramebufferStatus(c.FRAMEBUFFER)==
c.FRAMEBUFFER_COMPLETE&&c.readPixels(0,0,b,l,c.RGBA,c.FLOAT,a);return{texture:k,minmax:a}},_readHistogram:function(a,e,c){if(a)try{var b=this.gl,l=b.drawingBufferWidth,k=b.drawingBufferHeight,h,g,d,f,m,n,q;if(a.texture instanceof WebGLTexture)q=!0,f=[1,0,0,1],e?(m=a.minmax,n=e.minmax):(m=[a.minmax[0]],n=[a.minmax[1]]);else for(n=e,m=a,f=new Float32Array(n.length),h=0;h<n.length;h++)f[h]=256/(n[h]-m[h]);var p=new Float32Array(l*k);for(d=0;d<p.length;d++)p[d]=d;if(!this.histogramProgram){var r=H.getShader(b,
H.histogram),t=z.getShader(b,z.constant);this.histogramProgram=this._loadProgram(r,t)}b.blendFunc(b.ONE,b.ONE);b.enable(b.BLEND);b.useProgram(this.histogramProgram);var u=b.getAttribLocation(this.histogramProgram,"a_pixelIndex"),v=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,v);b.bufferData(b.ARRAY_BUFFER,p,b.STATIC_DRAW);b.enableVertexAttribArray(u);b.vertexAttribPointer(u,1,b.FLOAT,!1,0,0);var y=this._setupHistTexture(c),A=this._createTexture();b.getExtension("OES_texture_float");b.texImage2D(b.TEXTURE_2D,
0,b.RGBA,257,1,0,b.RGBA,b.FLOAT,null);var B=b.createFramebuffer();b.bindFramebuffer(b.FRAMEBUFFER,B);b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,A,0);b.viewport(0,0,257,1);var C=b.getUniformLocation(this.histogramProgram,"u_image");b.uniform1i(C,0);b.activeTexture(b.TEXTURE0);b.bindTexture(b.TEXTURE_2D,y);var D=b.getUniformLocation(this.histogramProgram,"u_sourceDim");b.uniform2f(D,l,k);var M=b.getUniformLocation(this.histogramProgram,"u_bandCount");b.uniform1i(M,3);var N=
b.getUniformLocation(this.histogramProgram,"u_halfPixel");b.uniform2f(N,.5/l,.5/k);var I=b.getUniformLocation(this.histogramProgram,"u_minMaxTexture");if(q){b.uniform1i(I,1);var O=b.getUniformLocation(this.histogramProgram,"u_image1");b.uniform1i(O,1);b.activeTexture(b.TEXTURE1);b.bindTexture(b.TEXTURE_2D,a.texture);if(e){var P=b.getUniformLocation(this.histogramProgram,"u_image2");b.uniform1i(P,2);b.activeTexture(b.TEXTURE2);b.bindTexture(b.TEXTURE_2D,e.texture)}}else{var Q=b.getUniformLocation(this.histogramProgram,
"u_mins");b.uniform4f(Q,m[0],m[0],m[0],m[0]);b.uniform1i(I,0)}var E=b.getUniformLocation(this.histogramProgram,"u_color"),F=b.getUniformLocation(this.histogramProgram,"u_factors"),R=b.getUniformLocation(this.histogramProgram,"u_size");b.uniform1f(R,256);a=[];e=[];var w;b.uniform4fv(E,[1,0,0,1]);b.uniform4fv(F,[f[0],0,0,1]);b.drawArrays(b.POINTS,0,p.length);var J=this.sourceRasterInfo.raster.bandCount;1<J&&(b.uniform4fv(E,[0,1,0,1]),b.uniform4fv(F,[0,f[0],0,1]),b.drawArrays(b.POINTS,0,p.length),b.uniform4fv(E,
[0,0,1,1]),b.uniform4fv(F,[0,0,f[0],1]),b.drawArrays(b.POINTS,0,p.length));if(b.checkFramebufferStatus(b.FRAMEBUFFER)==b.FRAMEBUFFER_COMPLETE){w=new Float32Array(1028);b.readPixels(0,0,257,1,b.RGBA,b.FLOAT,w);var x,b=0,K=-.5===m[0]&&1===(n[0]-m[0])/256?.5:0;for(h=0;h<J;h++){x=new Float32Array(257);var L=new Float32Array(257);for(d=b=0;256>d;d++)b+=w[4*d+h],x[d]=b,L[d]=w[4*d+h];L[256]=w[1024+h];x[256]=b+w[1024+h];var G=this.functionArguments.minPercent*b/100;if(n){for(g=0;256>g;g++)if(x[g]>G){a[h]=
m[0]+(n[0]-m[0])/256*(g+K);break}G=(1-this.functionArguments.maxPercent/100)*b;for(g=254;0<=g;g--)if(x[g]<G){e[h]=m[0]+(n[0]-m[0])/256*(g+2-K);break}}}}return{histogram:w,minCutOff:a,maxCutOff:e}}catch(S){console.debug("webgl filter exception: "+S.message)}},_setupHistTexture:function(a){if(a instanceof WebGLTexture)return a;var e=this.originalHistTexture=this._createTexture(),c=this.gl;a=a.pixelBlock;var b=a.width,l=a.height;c.getExtension("OES_texture_float");this.rgbaFloatData=a.getAsRGBAFloat();
c.texImage2D(c.TEXTURE_2D,0,c.RGBA,b,l,0,c.RGBA,c.FLOAT,this.rgbaFloatData);return e}})});