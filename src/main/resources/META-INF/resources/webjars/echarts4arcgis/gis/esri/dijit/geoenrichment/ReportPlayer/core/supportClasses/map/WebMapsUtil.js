// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/map/WebMapsUtil","dojo/_base/lang dojo/_base/Deferred esri/dijit/geoenrichment/promise/all esri/dijit/geoenrichment/when esri/kernel esri/arcgis/utils esri/geometry/Extent esri/request esri/dijit/geoenrichment/utils/UrlUtil ./UrlToItemUtil".split(" "),function(g,v,w,k,x,p,q,y,n,z){var f={};n.isPageRunOnWebService()||(x.id.getCredential=function(){var a=new v;a.reject(Error("Can't get credentials"));return a});var t={_itemsCache:{},
_siCache:{},loadItem:function(a){this._itemsCache[a]||(this._itemsCache[a]=p.getItem(a));return k(this._itemsCache[a],function(a){return a&&g.clone(a)})},loadServiceInfo:function(a,c){this._siCache[a]||(this._siCache[a]=c({url:a,content:{f:"json"}}));return this._siCache[a]}};f.getItem=function(a){return t.loadItem(a)};f.isWebMapType=function(a){return a&&"Web Map"===a.type};f.createMap=function(a,c,b){b=b||{};if(a&&a.item)return k(f.isWebMapType(a.item)&&b.additionalLayerInfos&&f._addAdditionalLayerInfosToOperationalLayers(a.itemData.operationalLayers,
b.additionalLayerInfos,b.requestFunc),function(){return k(!f.isWebMapType(a.item)&&f.createItemDataForNonWebMapItem(a,{defaultBasemapId:b.defaultBasemapId,additionalLayerInfos:b.additionalLayerInfos}),function(){return p.createMap(a,c,{usePopupManager:!0,mapOptions:b.mapOptions||{}})})})};f.createItemDataForNonWebMapItem=function(a,c){function b(){return f.executeItemUrl(e,c.requestFunc)}function h(d){a.itemData={baseMap:null,operationalLayers:d};return k(c.additionalLayerInfos&&f._addAdditionalLayerInfosToOperationalLayers(d,
c.additionalLayerInfos,c.requestFunc),function(){return k(!1!==c.defaultBasemapId&&f.provideDefaultBaseMapForItemData(a.itemData,c),function(){return a})})}function u(d,a){return-1!==d.indexOf(a)?d.substr(d.lastIndexOf(a)+a.length,d.length):null}function r(d,a){var b=d.id;return{url:n.combine(e.url,b),capabilities:a.capabilities||"Query",id:a.idPrefix+b,visibility:a.visibility||d.defaultVisibility,mode:1,title:d.title||d.name,description:d.description}}function p(d,a){var b;d.layers.some(function(d){a==
d.id&&(b=d);return a==d.id});return b}c=c||{};var e=a.item,l=a.itemData;if("Feature Service"===e.type){var m=u(e.url,"FeatureServer/");return b().then(function(d){var a=[],b=m&&p(d,m);if(b)a.push(r(b,{capabilities:d.capabilities,idPrefix:"featureServiceLayer_",visibility:!0}));else for(b=0;b<d.layers.length;b++)a.unshift(r(d.layers[b],{capabilities:d.capabilities,idPrefix:"featureServiceLayer_"}));return h(a)})}if("Map Service"===e.type)return m=u(e.url,"MapServer/"),b().then(function(a){a=m&&a.layers[m]?
r(a.layers[m],{capabilities:a.capabilities,idPrefix:"mapServiceLayer_",visibility:!0}):{url:e.url,id:"mapServiceLayer01",visibility:!0,title:a.title||a.name};a=[g.mixin(a,{opacity:1},l)];return h(a)});if("Image Service"===e.type)return b().then(function(a){a=[g.mixin({url:e.url,id:"imageServiceLayer01",visibility:!0,opacity:1,title:a.title||a.name},l)];return h(a)});if("Vector Tile Service"===e.type)return b().then(function(a){a=[g.mixin({url:e.url,id:"vectorTileServiceLayer01",visibility:!0,opacity:1,
title:a.title||a.name,styleUrl:n.combineMulti([e.url,a.defaultStyles,"root.json"]),type:"VectorTileLayer",layerType:"VectorTileLayer"},l)];return h(a)});if("WMSServer"===e.type)return b().then(function(a){a=[g.mixin({url:e.url,id:"wmsLayer01",visibility:!0,opacity:1,title:a.title||a.name},l)];return h(a)});if("WMTS"===e.type)return b().then(function(a){a=[g.mixin({url:e.url,id:"wmtsLayer01",visibility:!0,opacity:1,title:a.title||a.name},l)];return h(a)});if("WFS"===e.type)return b().then(function(a){a=
[g.mixin({url:e.url,id:"wfsLayer01",visibility:!0,opacity:1,title:a.title||a.name},l)];return h(a)});if("KML"===e.type){n.registerCORS(e.url);var q=[g.mixin({url:e.url,id:"kmlLayer01",visibility:!0,opacity:1,title:"KML Layer",type:"KML"},l)];return h(q)}};f.executeItemUrl=function(a,c){a.url=function(a){["FeatureServer","MapServer","ImageServer"].some(function(b){if(-1!==a.indexOf(b))return a=a.substr(0,a.lastIndexOf(b)+b.length),!0});return a}(a.url);c=c||y;n.registerCORS(a.url);return t.loadServiceInfo(a.url,
c).then(function(b){return k(function(a,b){a.extent||(b=b.initialExtent||b.fullExtent||b.extent,!b||b instanceof q||(b=new q(b)),a.extent=b)}(a,b),function(){return b})})};f.provideDefaultBaseMapForItemData=function(a,c){c=c||{};if(!a.baseMap)return k(function(){var a={title:"My basemap",baseMapLayers:[{id:"basemapLayer01",opacity:c.hideBasemap?0:1,visibility:!c.hideBasemap,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"}]};return c.defaultBasemapId?f.getItem(c.defaultBasemapId).then(function(b){return b&&
b.itemData&&b.itemData.baseMap||a}):a}(),function(b){a.baseMap=b;return a})};f._addAdditionalLayerInfosToOperationalLayers=function(a,c,b){return w(c.map(function(a,c){return/Server$/.test(a.url)?f.createItemDataForNonWebMapItem({item:z.tryCreateItemFromServerUrl(a.url)},{requestFunc:b}).then(function(a){return a.itemData.operationalLayers}):[{url:a.url,id:"additionalLayer"+c,visibility:!0,opacity:1}]})).then(function(b){b.forEach(function(b){b.forEach(function(b){a.push(b)})})})};return f});