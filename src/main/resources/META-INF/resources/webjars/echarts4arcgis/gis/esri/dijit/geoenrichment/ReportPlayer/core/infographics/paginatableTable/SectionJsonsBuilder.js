// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/infographics/paginatableTable/SectionJsonsBuilder","dojo/_base/lang ../../sections/SectionTypes ../../grid/coreUtils/GridDataUtil ../../supportClasses/tableJson/TableJsonResizeUtil ../../supportClasses/templateJsonUtils/fieldInfo/FieldInfoFormatUtil esri/dijit/geoenrichment/utils/DateUtil esri/dijit/geoenrichment/utils/FieldUtil".split(" "),function(g,y,t,p,z,A,u){function v(b,a){return u.isNumericField(b)&&"number"===typeof a&&!isNaN(a)}var e={buildSectionJsonsAndStat:function(b){var a=
e._collectGridDataObjectsAndStats(b);if(!a)return null;if(a.gridDataObjects.length)var c=e._splitRowsByPages(a.gridDataObjects,b).map(function(a){return e._buildSectionJsonForPage(a,b)});return{sectionJsons:c,stats:a.stats,unitedSectionJson:e._buildSectionJsonForPage(a.gridDataObjects,b)}},buildStats:function(b){return(b=e._collectGridDataObjectsAndStats(b,!0))&&b.stats},_collectGridDataObjectsAndStats:function(b,a){var c=b.calculatorDataArray,e=b.searchTextRe;if(!c||!c.length)if(b.allowNoResults)c=
[];else return null;var d=b.dataSectionJson.stack[0],k=d.data.data[0],l=d.data.data[1],h={numAttributesTotal:0,numAttributesShown:0,ranges:{}},q;b.filterRanges&&(q={},b.filterRanges.forEach(function(b){q[b.fieldName]=b}));for(var p in k.fieldInfos){var m=k.fieldInfos[p];u.isNumericField(m)&&(h.ranges[m.name]={fieldName:m.name,alias:m.alias,min:Infinity,max:-Infinity,sumTotal:0,sumShown:0,decimals:m.decimals,dataArray:[]})}var r=[];c.forEach(function(c,x){var n={style:null,fieldInfos:{}};h.numAttributesTotal++;
var l=!1,g=!1,w=!1;d.data.columns.forEach(function(b){var a=k.fieldInfos[b.field],f=c[a.name];if(v(a,f)){var d=h.ranges[a.name];d.min=Math.min(d.min,f);d.max=Math.max(d.max,f);d.dataArray.push(f)}(d="esriFieldTypeDate"===a.type)?n[b.field]=f&&!isNaN(Number(f))?A.formatDateShort(Number(f)):"":void 0===f||"string"===typeof f?n[b.field]=f||"":(n[b.field]=z.formatNumber(f,a),t.setNumericDataValue(f,n,b.field));n.__attributeIndex=x;(b=q&&q[a.name])&&(f<b.min||f>b.max)&&(l=!0);e&&"string"===typeof f&&!d&&
(g=!0,e.test(f)&&(w=!0))});var m=l||g&&!w;m||a||(r.push(n),h.numAttributesShown++);d.data.columns.forEach(function(b){var a=k.fieldInfos[b.field];b=c[a.name];v(a,b)&&(a=h.ranges[a.name],a.sumTotal+=b,m||(a.sumShown+=b))});b.setAttributeVisibleAt&&b.setAttributeVisibleAt(x,!m)});b.sorting&&r.sort(function(a,c){var d=t.getNumericDataValue(a,b.sorting.field),d=void 0!==d?d:a[b.sorting.field];a=t.getNumericDataValue(c,b.sorting.field);a=void 0!==a?a:c[b.sorting.field];c="number"===typeof d?d-a:d.localeCompare(a);
return"desc"===b.sorting.order?-c:c});r.forEach(function(a,b){a.style=g.clone((0!==b%2?l||k:k).style);a.style.height=k.style.height});h.ranges=Object.keys(h.ranges).map(function(a){return h.ranges[a]});return{stats:h,gridDataObjects:r}},getAttributeIndexForGridData:function(b){return b.__attributeIndex},_splitRowsByPages:function(b,a){var c=e._getHeaderHeight(a),g=e._getDataRowHeight(a),d=e._getDataListHeight(b,a),k=[],l,h=0;b.forEach(function(a){l||(l=[],k.push(l),h+=c);l.push(a);h+=g;h+g>d&&(l=
null,h=0)});return k},_getHeaderHeight:function(b){return b.scaleToFitHeight?b.minRowHeight:b.headerSectionJson?b.headerSectionJson.stack[0].data.data[0].style.height:0},_getDataRowHeight:function(b){return b.scaleToFitHeight?b.minRowHeight:b.dataSectionJson.stack[0].data.data[0].style.height},_getDataListHeight:function(b,a){var c=e._getHeaderHeight(a),g=e._getDataRowHeight(a),d=a.height-(a.hasFooter?a.footerHeight:0)-(a.hasTitle?a.titleHeight:0);a=a.height-a.footerHeight-(a.hasTitle?a.titleHeight:
0);return c+g*b.length<=d?d:a},_buildSectionJsonForPage:function(b,a){var c;a.headerSectionJson?(c=a.headerSectionJson.stack[0],c={id:"table",attributes:{},style:{width:a.width},data:{columns:g.clone(c.data.columns),data:[g.clone(c.data.data[0])].concat(g.clone(b))}}):c={id:"table",attributes:{},style:{width:a.width},data:{columns:g.clone(a.dataSectionJson.stack[0].data.columns),data:g.clone(b)}};c.data.data.forEach(function(b,c){b.style.height=0===c&&a.headerSectionJson?e._getHeaderHeight(a):e._getDataRowHeight(a)});
a.scaleToFitHeight&&(b=e._getDataListHeight(b,a),p.resizeTableJsonToFitHeight(c,b));p.resizeTableJsonToFitWidth(c,a.width);return{type:y.DETAILS,stack:[c]}}};return e});