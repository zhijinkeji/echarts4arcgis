// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/grid/coreUtils/sorting/GridSortUtil","dojo/_base/lang dojo/dom-class dojo/dom-construct ./GridRowStyler ../GridDataUtil ../GridQueryUtil ../gridLayoutCalcUtils/GridLayoutCalculatorQueryUtil esri/dijit/geoenrichment/utils/DnDUtil esri/dijit/geoenrichment/utils/TooltipUtil dojo/i18n!esri/nls/jsapi".split(" "),function(r,k,t,n,u,p,v,q,m,l){l=l.geoenrichment.dijit.ReportPlayer.Grid;var d={ORDER_ASC:"asc",ORDER_DES:"desc",isGridSortable:function(a){return!(!a.allowSorting||
!(a.viewModel.dynamicReportInfo||a.presetSorting&&!a.ignorePresetSorting)||!d.isGridSortableInStructure(a))},isGridSortableInStructure:function(a){return!(a.isEmptyTable()||3>a.store.data.length||!d.collectHeaderRowInfoFromData(a))},getSorting:function(a){return(a=a._sortInfo||a.presetSorting)&&{field:a.field,order:a.order}},applySortingToStoreData:function(a){d.isGridSortable(a)&&d._applySortingToStoreData(a)},setSorting:function(a,c,b){if(d.isGridSortable(a)&&c)if(a.presetSorting=null,a._sortInfo=
{field:c.field,order:c.order},b&&b.doNotRefresh)d._makeSortable(a);else return a.refresh()},buildSortControls:function(a){d.isGridSortable(a)&&d._makeSortable(a)},getSortRowIndexMapping:function(a){var c=d.getSorting(a);if(!c||!c.order)return null;var b={},g={};a._getOriginalData().forEach(function(a,b){g[a.id]=b});a.store.data.forEach(function(a,e){b[e]=g[a.id]});return b},getSortableDataInfo:function(a){function c(b){var c=[],e=d.collectHeaderRowInfoFromData(a,b);if(!e)return null;b=b?a._getOriginalData().slice():
r.clone(a.store.data);for(var g=0;g<e.headerRowIndex+1;g++)c.push(b.shift());return{topData:c,sortableData:b}}var b=c();b&&(b.styleInfo=n.getStyleInfo(c(!0).sortableData,a.columns));return b},_applySortingToStoreData:function(a){var c=d.getSorting(a);if(c&&c.order){a._saveOriginalData();var b=d.getSortableDataInfo(a),g=c.field,f=a.columns.filter(function(a){return a.field===g})[0];f&&b.sortableData.sort(function(b,g){function e(b){b=u.getRenderedValue(a,b,f);return"number"===typeof b.numericValue?
b.numericValue:b.formattedValue}b=e(b);var h=e(g);g=c.order===d.ORDER_DES;"number"===typeof b||"number"===typeof h?(b=Number(b),h=Number(h),b=b>h?1:b<h?-1:0):(b=String(b),h=String(h),b=b.localeCompare(h));return g?-b:b});b.styleInfo&&n.setAlternatingColors(b.sortableData,a.columns,b.styleInfo);a.store.data=b.topData.concat(b.sortableData)}},collectHeaderRowInfoFromData:function(a,c){function b(b){b=g[b];for(var c=0,d=0;d<a.columns.length;d++){var e=v.getColumnSpannedFields(a,b,a.columns[d].field),
d=d+(e&&e.length?e.length-1:0);c++}return c}var g=c?a._getOriginalData():a.store.data;c=g.length-2;for(var d,e=0;e<c;e++)if(b(e)===a.columns.length){d=e;break}if(0<=d)for(e=d+1;e<g.length;e++){if(b(e)!==a.columns.length)return null}else return null;return{headerRowIndex:d}},_makeSortable:function(a){var c=d._collectHeaderRowInfoWithCells(a);c&&(c.cells.forEach(function(b){if(!b._sortArrow){var c=t.create("div",{"class":"sortArrow sortArrowHoverIndicator"},b.domNode),f=b.getFullStyle();c.style[f&&
"left"===f.horizontalAlign?"right":"left"]="5px";b._sortArrow=c;a.viewModel.dynamicReportInfo&&(k.add(b.domNode,"esriGEClickable"),q.addNoDragClickHandler(b.contentBlock,function(c){a&&a.canSortCellFunc&&!a.canSortCellFunc(b)||d._checkCanSortOnHeaderClick(c)&&d._toggleSortForCell(b)}),q.addNoDragClickHandler(c,function(a){d._toggleSortForCell(b)}))}}),d._updateArrows(a,c))},_collectHeaderRowInfoWithCells:function(a){for(var c=a.store.data.length-2,b,d,f=0;f<c;f++){var e=p.queryCells(a,{rowIndex:f});
if(e&&e.length===a.columns.length){b=e;d=f;break}}if(b)for(f=d+1;f<a.store.data.length;f++){if(e=p.queryCells(a,{rowIndex:f}),!e||e.length!==a.columns.length)return null}else return null;return{cells:b,headerRowIndex:d}},_toggleSortForCell:function(a){var c=a.parentGrid,b=d.getSorting(c),b=b&&b.field===a.column.field?b.order:null;c.presetSorting=null;c._sortInfo={field:a.column.field,order:null};b?b===d.ORDER_DES?c._sortInfo.order=d.ORDER_ASC:b===d.ORDER_ASC&&(c._sortInfo.order=null):c._sortInfo.order=
d.ORDER_DES;c.refresh();c.onSortingChanged(d.getSorting(c))},_checkCanSortOnHeaderClick:function(a){if(a&&a.path){if(a.path.some(function(a){return"A"===a.nodeName}))return!1}else if(a&&a.srcElement&&a.srcElement.parentNode&&"A"===a.srcElement.parentNode.nodeName)return!1;return!0},_updateArrows:function(a,c){c.cells.forEach(function(b){var c=b._sortArrow;if(c){k.remove(c,"sortArrowHoverIndicator sortArrowUp sortArrowDown");m.setTooltipToNode(c,null);var f=d.getSorting(a);f&&f.field===b.column.field?
f.order===d.ORDER_ASC?k.add(c,"sortArrowUp"):f.order===d.ORDER_DES?k.add(c,"sortArrowDown"):(m.setTooltipToNode(c,l.sortTable),k.add(c,"sortArrowHoverIndicator")):(m.setTooltipToNode(c,l.sortTable),k.add(c,"sortArrowHoverIndicator"));setTimeout(function(){c.style.top=(b.getHeight()-c.clientHeight)/2+"px"},100)}})}};return d});