// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
require({cache:{"dojo/debounce":function(){define([],function(){return function(t,v){var m;return function(){m&&clearTimeout(m);var f=this,p=arguments;m=setTimeout(function(){t.apply(f,p)},v)}}})},"esri/numberUtils":function(){define(["dojo/has","dojo/number","dojo/i18n!dojo/cldr/nls/number","./kernel"],function(t,v,m,f){var p=function(f,h){return f-h},y={_reNumber:/^-?(\d+)(\.(\d+))?$/i,getDigits:function(f){var h=String(f),k=h.match(y._reNumber);f={integer:0,fractional:0};k&&k[1]?(f.integer=k[1].split("").length,
f.fractional=k[3]?k[3].split("").length:0):-1<h.toLowerCase().indexOf("e")&&(k=h.split("e"),h=k[0],k=k[1],h&&k&&(h=Number(h),k=Number(k),(f=0<k)||(k=Math.abs(k)),h=y.getDigits(h),f?(h.integer+=k,h.fractional=k>h.fractional?0:h.fractional-k):(h.fractional+=k,h.integer=k>h.integer?1:h.integer-k),f=h));return f},getFixedNumbers:function(f,h){var k;k=Number(f.toFixed(h));k<f?f=k+1/Math.pow(10,h):(f=k,k-=1/Math.pow(10,h));k=Number(k.toFixed(h));f=Number(f.toFixed(h));return[k,f]},getPctChange:function(f,
h,k,m){var x={prev:null,next:null},p;null!=k&&(p=f-k,x.prev=Math.floor(Math.abs(100*(h-k-p)/p)));null!=m&&(p=m-f,x.next=Math.floor(Math.abs(100*(m-h-p)/p)));return x},round:function(f,h){f=f.slice(0);var k,m,x,t,v,z,d,w,q=h&&null!=h.tolerance?h.tolerance:2,u=h&&h.indexes,O=h&&null!=h.strictBounds?h.strictBounds:!1;if(u)u.sort(p);else for(u=[],v=0;v<f.length;v++)u.push(v);for(v=0;v<u.length;v++)if(w=u[v],h=f[w],k=0===w?null:f[w-1],m=w===f.length-1?null:f[w+1],x=y.getDigits(h),x=x.fractional){z=0;for(d=
!1;z<=x&&!d;)t=y.getFixedNumbers(h,z),t=O&&0===v?t[1]:t[0],d=y.hasMinimalChange(h,t,k,m,q),z++;d&&(f[w]=t)}return f},hasMinimalChange:function(f,h,k,m,p){f=y.getPctChange(f,h,k,m);h=null==f.prev||f.prev<=p;k=null==f.next||f.next<=p;return h&&k||f.prev+f.next<=2*p},_reAllZeros:new RegExp("\\"+m.decimal+"0+$","g"),_reSomeZeros:/(\d)0*$/g,format:function(f,h){h=h||{places:20,round:-1};(f=v.format(f,h))&&(f=f.replace(y._reSomeZeros,"$1").replace(y._reAllZeros,""));return f}};t("extend-esri")&&(f.numberUtils=
y);return y})},"esri/renderers/utils":function(){define("dojo/_base/lang dojo/_base/array dojo/has dojo/date/locale ../kernel ../numberUtils ../Color dojo/i18n!dojo/cldr/nls/gregorian".split(" "),function(t,v,m,f,p,y,x,h){function k(d){return d&&v.map(d,function(d){return new x(d)})}function R(d,f,h){var u="";0===f?u=G.lt+" ":f===h&&(u=G.gt+" ");return u+d}var D={},G={lte:"\x3c\x3d",gte:"\x3e\x3d",lt:"\x3c",gt:"\x3e",pct:"%"},I={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},z={millisecond:{dateOptions:{formatLength:"long"},
timeOptions:{formatLength:"medium"}},second:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},minute:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},hour:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},day:{selector:"date",dateOptions:{formatLength:"long"}},month:{selector:"date",dateOptions:{formatLength:"long"}},year:{selector:"date",dateOptions:{selector:"year"}}},d={formatLength:"short",fullYear:!0},w={formatLength:"short"};t.mixin(D,
{timelineDateFormatOptions:{selector:"date",dateOptions:{formatLength:"short",fullYear:!0}},formatDate:function(q,u){var m=[];null==q||q instanceof Date||(q=new Date(q));u=u||{};u=t.mixin({},u);var k=u.selector?u.selector.toLowerCase():null,A=!k||-1<k.indexOf("time"),k=!k||-1<k.indexOf("date");A&&(u.timeOptions=u.timeOptions||w,u.timeOptions&&(u.timeOptions=t.mixin({},u.timeOptions),u.timeOptions.selector=u.timeOptions.selector||"time",m.push(u.timeOptions)));k&&(u.dateOptions=u.dateOptions||d,u.dateOptions&&
(u.dateOptions=t.mixin({},u.dateOptions),u.dateOptions.selector=u.dateOptions.selector||"date",m.push(u.dateOptions)));m&&m.length?(m=v.map(m,function(d){return f.format(q,d)}),u=1==m.length?m[0]:h["dateTimeFormat-medium"].replace(/\'/g,"").replace(/\{(\d+)\}/g,function(d,f){return m[f]})):u=f.format(q);return u},createColorStops:function(d){var f=d.values,q=d.colors,m=d.labelIndexes,k=d.isDate,h=d.dateFormatOptions;d=[];return d=v.map(f,function(d,u){var A=null;if(!m||-1<v.indexOf(m,u)){var p;(p=
k?D.formatDate(d,h):y.format(d))&&(A=R(p,u,f.length-1))}return{value:d,color:q[u],label:A}})},updateColorStops:function(d){var f=d.stops,q=d.changes,m=d.isDate,k=d.dateFormatOptions,h=[],p,t=v.map(f,function(d){return d.value});v.forEach(q,function(d){h.push(d.index);t[d.index]=d.value});p=y.round(t,{indexes:h});v.forEach(f,function(d,u){d.value=t[u];if(null!=d.label){var q,h=null;(q=m?D.formatDate(p[u],k):y.format(p[u]))&&(h=R(q,u,f.length-1));d.label=h}})},createClassBreakLabel:function(d){var f=
d.minValue,q=d.maxValue,m=d.isFirstBreak?"":G.gt+" ";d="percent-of-total"===d.normalizationType?G.pct:"";f=null==f?"":y.format(f);q=null==q?"":y.format(q);return m+f+d+" \u2013 "+q+d},setLabelsForClassBreaks:function(d){var f=d.classBreaks,q=d.classificationMethod,m=d.normalizationType,h=[];f&&f.length&&("standard-deviation"===q?console.log("setLabelsForClassBreaks: cannot set labels for class breaks generated using 'standard-deviation' method."):d.round?(h.push(f[0].minValue),v.forEach(f,function(d){h.push(d.maxValue)}),
h=y.round(h),v.forEach(f,function(d,f){d.label=D.createClassBreakLabel({minValue:0===f?h[0]:h[f],maxValue:h[f+1],isFirstBreak:0===f,normalizationType:m})})):v.forEach(f,function(d,f){d.label=D.createClassBreakLabel({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===f,normalizationType:m})}))},updateClassBreak:function(d){var f=d.classBreaks,m=d.normalizationType,h=d.change,k=h.index,h=h.value,q=-1,p=-1,t=f.length;"standard-deviation"===d.classificationMethod?console.log("updateClassBreak: cannot update labels for class breaks generated using 'standard-deviation' method."):
(0===k?q=k:k===t?p=k-1:(p=k-1,q=k),-1<q&&q<t&&(d=f[q],d.minValue=h,d.label=D.createClassBreakLabel({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===q,normalizationType:m})),-1<p&&p<t&&(d=f[p],d.maxValue=h,d.label=D.createClassBreakLabel({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===p,normalizationType:m})))},calculateDateFormatInterval:function(d){var f,h,m=d.length,k,q,p,t,w,z,x=Infinity,y;d=v.map(d,function(d){return new Date(d)});for(f=0;f<m-1;f++){k=d[f];p=[];w=Infinity;z=
"";for(h=f+1;h<m;h++)q=d[h],q=k.getFullYear()!==q.getFullYear()&&"year"||k.getMonth()!==q.getMonth()&&"month"||k.getDate()!==q.getDate()&&"day"||k.getHours()!==q.getHours()&&"hour"||k.getMinutes()!==q.getMinutes()&&"minute"||k.getSeconds()!==q.getSeconds()&&"second"||"millisecond",t=I[q],t<w&&(w=t,z=q),p.push(q);w<x&&(x=w,y=z)}return y},createUniqueValueLabel:function(d){var f=d.value,h=d.fieldInfo,m=d.domain;d=d.dateFormatInterval;var k=String(f);(m=m&&m.codedValues?m.getName(f):null)?k=m:"number"===
typeof f&&(k=h&&"esriFieldTypeDate"===h.type?D.formatDate(f,d&&z[d]):y.format(f));return k},cloneColorInfo:function(d){var f;d&&(f=t.mixin({},d),f.colors=k(f.colors),f.stops=f.stops&&v.map(f.stops,function(d){d=t.mixin({},d);d.color&&(d.color=new x(d.color));return d}),f.legendOptions&&(f.legendOptions=t.mixin({},f.legendOptions)));return f},cloneOpacityInfo:function(d){var f;if(d){f=t.mixin({},d);if(d=f.opacityValues)f.opacityValues=d.slice(0);if(d=f.stops)f.stops=v.map(d,function(d){return t.mixin({},
d)});if(d=f.legendOptions)f.legendOptions=t.mixin({},d)}return f},cloneSizeInfo:function(d){var f;d&&(f=t.mixin({},d),f.stops&&(f.stops=v.map(f.stops,function(d){return t.mixin({},d)})),(d=f.minSize)&&"object"===typeof d&&(f.minSize=D.cloneSizeInfo(d)),(d=f.maxSize)&&"object"===typeof d&&(f.maxSize=D.cloneSizeInfo(d)),d=f.legendOptions)&&(f.legendOptions=t.mixin({},d),d=d.customValues)&&(f.legendOptions.customValues=d.slice(0));return f},getClassCodesForRelationship:function(){return t.clone({2:["L",
"H"],3:["L","M","H"],4:["L","M1","M2","H"]})},getClassValuesForRelationship:function(){return t.clone({2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]})}});m("extend-esri")&&t.setObject("renderer.utils",D,p);return D})},"*noref":1}});
define("esri/dijit/Legend","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/json dojo/_base/Color dojo/debounce dojo/has dojo/sniff dojo/Deferred dojo/DeferredList dojo/json dojo/dom dojo/dom-construct dojo/dom-style dojo/dom-class dijit/_Widget dojox/gfx dojox/gfx/matrix dojox/html/entities ../kernel ../config ../request ../lang ../numberUtils ../renderers/utils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/ClassBreaksRenderer ../renderers/ScaleDependentRenderer ../renderers/DotDensityRenderer ../renderers/TemporalRenderer ../renderers/VectorFieldRenderer ../renderers/HeatmapRenderer ../symbols/PictureFillSymbol ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/utils ../symbols/jsonUtils ../renderers/jsonUtils ./_EventedWidget dojo/i18n!../nls/jsapi".split(" "),function(t,
v,m,f,p,y,x,h,k,R,D,G,I,z,d,w,q,u,O,J,A,Y,T,S,K,E,L,ha,ia,ja,ka,la,ma,U,na,Z,V,aa,ba,P,ca,da,W){var ea=L.getClassValuesForRelationship(),fa={defaultShape:{type:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15"},stroke:{width:1,color:"#555555"}},X={HH:315,HL:45,LL:135,LH:225},ga=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,F=v([da,u],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,transparencyRampColor:new x([64,
64,64]),defaultText:"Aa",sizeRampLightColor:new x([255,255,255]),sizeRampDarkColor:new x([128,128,128]),gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"\x3c",gt:"\x3e"},_ieTimer:100,_isRightToLeft:!1,_align:null,_legendAlign:null,_preserveCacheOnDestroy:!1,_layerConnects:null,_mapConnects:null,constructor:function(a,b){m.mixin(this,W.widgets.legend);this._i18n=W.widgets.legend;a=a||{};a.map?b?(this.map=a.map,this.layerInfos=a.layerInfos,this._respectCurrentMapScale=!1===a.respectCurrentMapScale?
!1:!0,this._respectVisibility=!1===a.respectVisibility?!1:!0,this._preserveCacheOnDestroy=a.preserveCacheOnDestroy?!0:!1,this.arrangement=a.arrangement===F.ALIGN_RIGHT?F.ALIGN_RIGHT:F.ALIGN_LEFT,this.arrangement===F.ALIGN_RIGHT&&(this.alignRight=!0),this.autoUpdate=!1===a.autoUpdate?!1:!0,this._surfaceItems=[],this.hideLayersInLegend={},this.refresh=h(this.refresh,0)):console.error("esri.dijit.Legend: must specify a container for the legend"):console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},
postMixInProperties:function(){this.inherited(arguments);var a=["ar","he"],b,c;for(b=0;b<a.length;b+=1)c=a[b],t.locale&&-1!==t.locale.indexOf(c)&&(-1!==t.locale.indexOf("-")?-1!==t.locale.indexOf(c+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);this._isRightToLeft?(this._align=this.alignRight?"left":"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},
startup:function(){this.inherited(arguments);this._initialize();9>k("ie")&&(this._repaintItems=m.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate();this._removeCachedLegendResponses();this._removeHoverHandlers();this.inherited(arguments)},_removeCachedLegendResponses:function(){this._preserveCacheOnDestroy||f.forEach(this.layers,function(a){delete a.legendResponse})},refresh:function(a){if(this.domNode){a?(this.layerInfos=a,this.layers=
[],f.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,this._addSubLayersToHide(a)):this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this)):this.useAllMapLayers&&(this.layers=this.layerInfos=null);for(a=
this.domNode.children.length-1;0<=a;a--)d.destroy(this.domNode.children[a]);this._removeHoverHandlers();this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){this.layerInfos&&(this.layers=[],f.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,this._addSubLayersToHide(a)):
this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this));this.useAllMapLayers=!1;if(!this.layers){this.useAllMapLayers=!0;this.layers=[];var a=[],b=[];f.forEach(this.map.layerIds,function(c){c=this.map.getLayer(c);var e;this._isSupportedLayerType(c)&&(c.arcgisProps&&c.arcgisProps.title&&(c._titleForLegend=c.arcgisProps.title),this.layers.push(c));"esri.layers.KMLLayer"==c.declaredClass&&
(e=c.getLayers(),f.forEach(e,function(b){a.push(b.id)},this));"esri.layers.GeoRSSLayer"==c.declaredClass&&(e=c.getFeatureLayers(),f.forEach(e,function(a){b.push(a.id)},this))},this);f.forEach(this.map.graphicsLayerIds,function(c){var e=this.map.getLayer(c);-1==f.indexOf(a,c)&&-1==f.indexOf(b,c)&&this._isSupportedLayerType(e)&&this._isLayerDrawingEnabled(e)&&(e.arcgisProps&&e.arcgisProps.title&&(e._titleForLegend=e.arcgisProps.title),this.layers.push(e))},this)}this._createLegend()},_isLayerDrawingEnabled:function(a){return a&&
(a._params&&a._params.drawMode||a.isFeatureReductionActive&&a.isFeatureReductionActive())},_activate:function(){this._deactivate();if(this.autoUpdate){this._mapConnects=[];this._layerConnects={};var a=this._mapConnects;this._respectCurrentMapScale&&a.push(p.connect(this.map,"onZoomEnd",this,"_refreshLayers"));this.useAllMapLayers&&(a.push(p.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers")),a.push(p.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers")),a.push(p.connect(this.map,"onLayersReordered",
this,"_updateAllMapLayers")));f.forEach(this.layers,function(a){var b=[p.connect(a,"onFeatureReductionRendererChange",this,"_refreshLayers"),p.connect(a,"onFeatureReductionChange",this,"_refreshLayers"),p.connect(a,"onVisibilityChange",this,"_refreshLayers"),p.connect(a,"onOpacityChange",this,"_refreshLayers"),p.connect(a,"onScaleRangeChange",this,"_refreshLayers")];"esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass&&a.supportsDynamicLayers&&b.push(p.connect(a,"_onDynamicLayersChange",m.hitch(this,
"_updateDynamicLayers",a)));"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&(b.push(p.connect(a,"onRenderingChange",m.partial(this._updateImageServiceLayers,this,a))),b.push(p.connect(a,"onRendererChange",m.partial(this._updateImageServiceLayers,this,a))));("esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||a.setWebGLEnabled)&&b.push(p.connect(a,"onRendererChange",m.hitch(this,"_refreshLayers")));this._layerConnects[a.id]=b},this)}},_deactivate:function(){f.forEach(this._mapConnects,
function(a){p.disconnect(a)});f.forEach(this.layers,function(a){var b=this._layerConnects;b&&f.forEach(b[a.id],function(a){p.disconnect(a)})},this);this._mapConnects=this._layerConnects=null},_updateDynamicLayers:function(a){delete a.legendResponse;this._refreshLayers()},_updateImageServiceLayers:function(a,b){delete b.legendResponse;a._refreshLayers()},_refreshLayers:function(){this.refresh()},_updateAllMapLayers:function(){this.layers=[];f.forEach(this.map.layerIds,function(a){a=this.map.getLayer(a);
this._isSupportedLayerType(a)&&this.layers.push(a)},this);f.forEach(this.map.graphicsLayerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&this._isLayerDrawingEnabled(a)&&this.layers.push(a)},this);this.refresh()},_createLegend:function(){var a=!1,b=!1;w.set(this.domNode,"position","relative");d.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var c=[];f.forEach(this.layers,function(g){if("esri.layers.KMLLayer"==
g.declaredClass||"esri.layers.GeoRSSLayer"==g.declaredClass){var e;g.loaded?("esri.layers.KMLLayer"==g.declaredClass?e=g.getLayers():"esri.layers.GeoRSSLayer"==g.declaredClass&&(e=g.getFeatureLayers(),this.hideLayersInLegend[g.id]&&(e=f.filter(e,function(a){return-1==f.indexOf(this.hideLayersInLegend[g.id],a.id)},this))),f.forEach(e,function(a){"esri.layers.FeatureLayer"==a.declaredClass&&g._titleForLegend&&(a._titleForLegend=g._titleForLegend+" - ","esriGeometryPoint"==a.geometryType?a._titleForLegend+=
this.NLS_points:"esriGeometryPolyline"==a.geometryType?a._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"==a.geometryType&&(a._titleForLegend+=this.NLS_areas),c.push(a))},this)):p.connect(g,"onLoad",m.hitch(this,function(){this.refresh(this.layerInfos)}))}else if("esri.layers.WMSLayer"===g.declaredClass)if(!g.loaded)p.connect(g,"onLoad",m.hitch(this,function(){this.refresh(this.layerInfos)}));else{if((!this._respectVisibility||this._respectVisibility&&g.visible)&&0<g.layerInfos.length&&f.some(g.layerInfos,
function(a){return a.legendURL})){var B=!1;f.forEach(g.layerInfos,function(b){if(b.legendURL&&-1<f.indexOf(g.visibleLayers,b.name)){B||(d.create("div",{innerHTML:"\x3cspan class\x3d'esriLegendServiceLabel'\x3e"+(g._titleForLegend||g.name||g.id)+"\x3c/span\x3e"},this.domNode),B=!0);var c;b=b.legendURL;if(g.customParameters||g.customLayerParameters){var e=m.clone(g.customParameters||{});m.mixin(e,g.customLayerParameters||{});for(c in e)b+=(-1===b.indexOf("?")?"?":"\x26")+c+"\x3d"+e[c]}d.create("div",
{innerHTML:"\x3cimg src\x3d'"+b+"'/\x3e"},this.domNode);a=!0}},this)}}else"esri.layers.WFSLayer"!==g.declaredClass||g.renderer?c.push(g):(e=d.create("div",{id:this.id+"_"+g.id,"class":"esriLegendService"}),d.create("span",{innerHTML:this._getServiceTitle(g),"class":"esriLegendServiceLabel"},d.create("td",{align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%"},e))))),d.place(e,this.id,"first"),e=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},
e),e=d.create("tbody",{},e),"esriGeometryComplex"===g.geometryType?(this._buildRow_Renderer(g,g._pointSymbol,null,this.NLS_points,null,e),this._buildRow_Renderer(g,g._lineSymbol,null,this.NLS_lines,null,e),this._buildRow_Renderer(g,g._polygonSymbol,null,this.NLS_areas,null,e)):"esriGeometryPoint"===g.geometryType?this._buildRow_Renderer(g,g._pointSymbol,null,"",null,e):"esriGeometryPolyline"===g.geometryType?this._buildRow_Renderer(g,g._lineSymbol,null,"",null,e):"esriGeometryPolygon"===g.geometryType&&
this._buildRow_Renderer(g,g._polygonSymbol,null,"",null,e),b=!0)},this);var e=[];f.forEach(c,function(a){if(!a.loaded)var b=p.connect(a,"onLoad",this,function(a){p.disconnect(b);b=null;this.refresh()});else if((!this._respectVisibility||this._respectVisibility&&a.visible)&&(a.layerInfos||a.renderer||"esri.layers.ArcGISImageServiceLayer"==a.declaredClass)){var c=d.create("div",{id:this.id+"_"+a.id,style:{display:"none"},"class":"esriLegendService"});d.create("span",{innerHTML:this._getServiceTitle(a),
"class":"esriLegendServiceLabel"},d.create("td",{align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%"},c)))));d.place(c,this.id,"first");a.legendResponse||a.renderer&&"esri.renderer.StretchRenderer"!==a.renderer.declaredClass||a.renderer&&"esri.renderer.StretchRenderer"===a.renderer.declaredClass&&1===a.bandCount?this._createLegendForLayer(a):this.isHostedTileService(a)?this._getLayerInfos(a).then(m.hitch(this,function(a){this._createLegendForLayer(a)}),m.hitch(this,
function(a){e.push(this._legendRequest(a))})):e.push(this._legendRequest(a))}},this);0!==e.length||a||b?(new G(e)).addCallback(m.hitch(this,function(c){a||b?z.byId(this.id+"_msg").innerHTML="":z.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate()})):(z.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate())},_createLegendForLayer:function(a){if(a.legendResponse||a.renderer||this.isHostedTileService(a)){var b=!1;if(a.legendResponse||this.isHostedTileService(a)){var c=a.dynamicLayerInfos||
a.layerInfos;c&&c.length?f.forEach(c,function(c,g){this.hideLayersInLegend[a.id]&&-1!==f.indexOf(this.hideLayersInLegend[a.id],c.id)||(c=this._buildLegendItems(a,c,g),b=b||c)},this):"esri.layers.ArcGISImageServiceLayer"==a.declaredClass&&(b=this._buildLegendItems(a,{id:0,name:null,title:a.name,subLayerIds:null,parentLayerId:-1},0))}else a.renderer&&(c=a.url?a.url.substring(a.url.lastIndexOf("/")+1,a.url.length):"fc_"+a.id,b=this._buildLegendItems(a,{id:c,name:null,subLayerIds:null,parentLayerId:-1},
0));b&&(w.set(z.byId(this.id+"_"+a.id),"display","block"),w.set(z.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(a){if(a.loaded)return 10.01<=a.version?this._legendRequestServer(a):this._legendRequestTools(a);p.connect(a,"onLoad",m.hitch(this,"_legendRequest"))},_legendRequestServer:function(a){var b=a.url,c=b.indexOf("?"),b=-1<c?b.substring(0,c)+"/legend"+b.substring(c):b+"/legend";(c=a._getToken())&&(b+="?token\x3d"+c);var e=m.hitch(this,"_processLegendResponse"),g={f:"json"};
a._params.dynamicLayers&&(g.dynamicLayers=I.stringify(this._createDynamicLayers(a)),"[{}]"===g.dynamicLayers&&(g.dynamicLayers="[]"));a._params.bandIds&&(g.bandIds=a._params.bandIds);a._params.renderingRule?g.renderingRule=a._params.renderingRule:a.rasterFunctionInfos&&0<a.rasterFunctionInfos.length&&f.forEach(a.rasterFunctionInfos,function(a){a&&a.name&&"none"===a.name.toLowerCase()&&(g.renderingRule=I.stringify({rasterFunction:a.name}))});return S({url:b,content:g,callbackParamName:"callback",load:function(b,
c){e(a,b,c)},error:T.defaults.io.errorHandler})},_legendRequestTools:function(a){var b=a.url.toLowerCase().indexOf("/rest/"),b=a.url.substring(0,b)+a.url.substring(b+5,a.url.length),b=this._legendUrl+"?soapUrl\x3d"+window.escape(b);if(!k("ie")||8<k("ie"))b+="\x26returnbytes\x3dtrue";var c=m.hitch(this,"_processLegendResponse");return S({url:b,content:{f:"json"},callbackParamName:"callback",load:function(b,g){c(a,b,g)},error:T.defaults.io.errorHandler})},_processLegendResponse:function(a,b){b&&b.layers?
(a.legendResponse=b,z.byId(this.id+"_"+a.id)&&d.empty(z.byId(this.id+"_"+a.id)),d.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},d.create("td",{align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%"},z.byId(this.id+"_"+a.id)))))),this._createLegendForLayer(a)):console.log("Legend could not get generated for "+a.url+": "+y.toJson(b))},_buildLegendItems:function(a,b,c){var e=!1,g=z.byId(this.id+"_"+a.id),n=b.parentLayerId;if(b.subLayerIds)a=
d.create("div",{id:this.id+"_"+a.id+"_"+b.id+"_group",style:{display:"none"},"class":-1==n?0<c?"esriLegendGroupLayer":"":this._legendAlign},-1==n?g:z.byId(this.id+"_"+a.id+"_"+n+"_group")),d.create("td",{innerHTML:A.encode(b.name),align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%","class":"esriLegendLayerLabel"},a))));else{if(this._respectVisibility&&a.visibleLayers)if(c=a.dynamicLayerInfos||a.layerInfos)if(a._params&&a._params.layers){if(-1===f.indexOf(a.visibleLayers,
b.id))return e}else{if(c=this._getReallyVisibleLayers(c,a.visibleLayers),-1===f.indexOf(c,b.id))return e}else if(-1===f.indexOf(a.visibleLayers,b.id))return e;g=d.create("div",{id:this.id+"_"+a.id+"_"+b.id,style:{display:"none"},"class":-1<n?this._legendAlign:""},-1==n?g:z.byId(this.id+"_"+a.id+"_"+n+"_group"));d.create("td",{innerHTML:A.encode(b.name)||"",align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%","class":"esriLegendLayerLabel"},g))));c=a.dynamicLayerInfos||
a.layerInfos;n=!1;c&&c.length&&(n=f.some(c,function(a){return!!a.drawingInfo}));if(a.legendResponse)e=e||this._buildLegendItems_Tools(a,b,g);else if(a.renderer||n)e=e||this._buildLegendItems_Renderer(a,b,g)}return e},_getReallyVisibleLayers:function(a,b){if(!a||!b||!b.length)return[];var c=[],e=[],g;for(g=0;g<a.length;g++)if(a[g].subLayerIds){if(-1===f.indexOf(b,a[g].id)||-1<f.indexOf(e,a[g].id))e=e.concat(a[g].subLayerIds)}else-1<f.indexOf(b,a[g].id)&&-1===f.indexOf(e,a[g].id)&&c.push(a[g].id);return c},
_buildLegendItems_Tools:function(a,b,c){var e=b.parentLayerId,g=this.map.getScale(),n=!1,B=function(a,b){var c,e;for(c=0;c<a.length;c++)if(b.dynamicLayerInfos)for(e=0;e<b.dynamicLayerInfos[e].length;e++){if(b.dynamicLayerInfos[e].mapLayerId==a[c].layerId)return a[c]}else if(b.id==a[c].layerId)return a[c];return{}};if(!this._respectCurrentMapScale||this._respectCurrentMapScale&&this._isLayerInScale(a,b,g)){var C=!0;if(this._respectCurrentMapScale&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||
"esri.layers.ArcGISMapServiceLayer"===a.declaredClass)){var r=this._getEffectiveScale(a,b);if(r.minScale&&r.minScale<g||r.maxScale&&r.maxScale>g)C=!1}if(C){var g=B(a.legendResponse.layers,b),l=g.legendType,h=g.layerType,m=g.legend;if(m){"esri.layers.ArcGISImageServiceLayer"!==a.declaredClass&&this._sanitizeLegendResponse(a,g,b);c=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);var k=d.create("tbody",{},c);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(c,
a,b);var p=[];f.forEach(m,function(c){if(!(10.1<=a.version&&!c.values&&1<m.length)||!a._hideDefaultSymbol&&"\x3call other values\x3e"!==c.label&&(c.label||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.3<=a.version||"Raster Layer"===h)){var e=c.label;if(c.url&&0===c.url.indexOf("http")||c.imageData&&0<c.imageData.length)n=!0,e&&-1!==f.indexOf(p,e)||(p.push(e),this._buildRow_Tools(c,k,a,b.id,l))}},this)}}}n&&(w.set(z.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<e&&(w.set(z.byId(this.id+
"_"+a.id+"_"+e+"_group"),"display","block"),this._findParentGroup(a.id,a,e)));return n},_getLayerInfos:function(a){var b=new D,c=a.dynamicLayerInfos||a.layerInfos;if(c&&c.length)if(f.some(c,function(a){return!!a.drawingInfo}))b.resolve(a);else{var e=a.url,g=e.indexOf("?"),e=-1==g?e+"/layers":e.substring(0,g)+"/layers"+e.substring(g,e.length);S({url:e,content:{f:"json"},callbackParamName:"callback",load:function(e,g){e.layers?(f.forEach(c,function(a){var b=f.filter(e.layers,function(b){return a.source?
b.id===a.source.mapLayerId:b.id===a.id});b&&b[0]&&b[0].drawingInfo&&(a.drawingInfo=b[0].drawingInfo,a.fields=b[0].fields)}),b.resolve(a)):b.reject(a)},error:function(c){b.reject(a)}})}return b},_sanitizeLegendResponse:function(a,b,c){var e=b.legend;if(10.1<=a.version&&1<e.length&&!b._sanitized){a=m.getObject("layerDefinition.drawingInfo.renderer",!1,c);var g,d;a||(a=m.getObject("drawingInfo.renderer",!1,c));f.some(e,function(a){if(a.values)return!0})&&f.some(e,function(a,b){a.values||(d=b,g=a);return!!g});
a?"uniqueValue"===a.type?g&&(e.splice(d,1),e.push(g)):"classBreaks"===a.type&&(g&&e.splice(d,1),e.reverse(),g&&e.push(g)):g&&(e.splice(d,1),e.push(g));b._sanitized=!0}},_buildRow_Tools:function(a,b,c,e,g){var f=d.create("tr",{},b),B;this.alignRight?(b=d.create("td",{align:this._isRightToLeft?"left":"right"},f),B=d.create("td",{align:this._isRightToLeft?"left":"right",width:35},f)):(B=d.create("td",{width:35,align:"center"},f),b=d.create("td",{},f));f=a.url;(!k("ie")||9<=k("ie")||9>k("ie")&&"esri.layers.ArcGISImageServiceLayer"===
c.declaredClass)&&a.imageData&&0<a.imageData.length?f="data:image/png;base64,"+a.imageData:0!==a.url.indexOf("http")&&(f=c.url+"/"+e+"/images/"+a.url,(e=c._getToken())&&(f+="?token\x3d"+e));e=d.create("img",{src:f,border:0,style:"opacity:"+c.opacity},B);a=d.create("td",{innerHTML:A.encode(a.label),align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%",dir:"ltr"},b))));g&&"Stretched"===g&&10.3<=c.version&&"esri.layers.ArcGISImageServiceLayer"===c.declaredClass&&(a.style.verticalAlign=
"top",a.style.lineHeight="1",e.style.marginBottom="-1px",e.style.display="block",b.style.verticalAlign="top");9>k("ie")&&(e.style.filter="alpha(opacity\x3d"+100*c.opacity+")")},_getVariable:function(a,b,c){var e;a&&(e=(a=a.getVisualVariablesForType(b,c))&&a[0]);return e},_getVariables:function(a,b,c){a=[this._getVariable(a,"colorInfo",!1),this._getVariable(a,"opacityInfo",!1),this._getVariable(a,"sizeInfo",!1)];return b?f.filter(a,function(a){return!(!a||a.field!==b||a.normalizationField!=c)}):a},
_getFieldAlias:function(a,b,c){var e=b.infoTemplate||(b.infoTemplates&&c&&b.infoTemplates[c.id]?b.infoTemplates[c.id].infoTemplate:null),e=e&&e.getFieldInfo&&e.getFieldInfo(a);a=m.isFunction(a)?null:this.getField(b,a,c);b=e||a;c="";b&&(c=e&&e.label||a&&a.alias||b.name||b.fieldName);return c},_getDomainName:function(a,b,c,e){var g;a&&!m.isFunction(a)&&(g=(c=(a=this.getField(c,a,e))&&c.getDomain?c.getDomain(a.name):null)&&c.codedValues?c.getName(b):null);return g},_getRampTitle:function(a,b,c){var e,
g=a.field,d=a.normalizationField,f=!1,C=!1,r=!1,g=m.isFunction(g)?null:g,d=m.isFunction(d)?null:d;if(a.legendOptions&&a.legendOptions.title)e=a.legendOptions.title;else if(a.valueExpressionTitle)e=a.valueExpressionTitle;else{if(b.renderer&&b.renderer.authoringInfo&&b.renderer.authoringInfo.visualVariables){var l=b.renderer.authoringInfo.visualVariables;for(a=0;a<l.length;a++){var h=l[a];if("colorInfo"===h.type&&"ratio"===h.style){f=!0;break}else if("colorInfo"===h.type&&"percent"===h.style){C=!0;
break}else if("colorInfo"===h.type&&"percentTotal"===h.style){r=!0;break}}}(f=r&&"showRatioPercentTotal"||C&&"showRatioPercent"||f&&"showRatio"||d&&"showNormField"||g&&"showField"||null)&&(e=K.substitute({field:g&&this._getFieldAlias(g,b,c),normField:d&&this._getFieldAlias(d,b,c)},"showField"===f?"${field}":this._i18n[f]))}return e},_getRendererTitle:function(a,b,c){var e;if(a){var g,d,f;"esri.renderer.ClassBreaksRenderer"===a.declaredClass&&(g=a.attributeField,d=a.normalizationField,f="percent-of-total"===
a.normalizationType);g=m.isFunction(g)?null:g;d=m.isFunction(d)?null:d;a.legendOptions&&a.legendOptions.title?e=a.legendOptions.title:a.valueExpressionTitle?e=a.valueExpressionTitle:(a=d&&"showNormField"||(f?"showNormPct":null)||g&&"showField"||null)&&(e=K.substitute({field:g&&this._getFieldAlias(g,b,c),normField:d&&this._getFieldAlias(d,b,c)},"showField"===a?"${field}":this._i18n[a]))}return e},_buildLegendItems_Renderer:function(a,b,c){var e=b.parentLayerId,g=this.map,n=g.getScale(),B,C=!1;if(!this._respectCurrentMapScale||
this._isLayerInScale(a,b,n)){var r,l,h,k,p,u,t;l="esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass?a.renderer.renderer:b&&b.drawingInfo?ca.fromJson(m.clone(b.drawingInfo.renderer)):a.isFeatureReductionActive&&a.isFeatureReductionActive()?a.getFeatureReductionRenderer():a.renderer;if("esri.renderer.ScaleDependentRenderer"===l.declaredClass&&(l=(g="zoom"===l.rangeType?l.getRendererInfoByZoom(g.getZoom()):l.getRendererInfoByScale(n))&&g.renderer,!l))return!1;g=l&&l.authoringInfo&&"relationship"===
l.authoringInfo.type;if("esri.renderer.StretchRenderer"!==l.declaredClass){var q=this._getVariables(l),v=f.filter(q,function(a){return!!a}).length,x=q[0],y=q[1],q=q[2],D,Q,E,F,M;x&&(h=this._getMedianColor(l,x),x.field&&(p=m.isFunction(x.field)?null:this.getField(a,x.field,b)),D=!(x.legendOptions&&!1===x.legendOptions.showLegend));y&&(y.field&&(t=m.isFunction(y.field)?null:this.getField(a,y.field,b)),Q=!(y.legendOptions&&!1===y.legendOptions.showLegend));q&&(q.field&&(u=m.isFunction(q.field)?null:
this.getField(a,q.field,b)),E=!(q.legendOptions&&!1===q.legendOptions.showLegend))}if("esri.renderer.HeatmapRenderer"===l.declaredClass)B=C=!0,this._showHeatRamp(a,b,l,c);else if("esri.renderer.DotDensityRenderer"===l.declaredClass)B=C=!0,this._showDotDensityLegend(a,b,l,c);else if("esri.renderer.TemporalRenderer"===l.declaredClass)B=C=!0,n=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),r=d.create("tbody",{},n),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(n,
a,b),l.latestObservationRenderer&&"esri.renderer.SimpleRenderer"===l.latestObservationRenderer.declaredClass&&this._buildRow_Renderer(a,l.latestObservationRenderer.symbol,h,A.encode(l.latestObservationRenderer.label)||this.NLS_currentObservations,null,r),l.observationRenderer&&"esri.renderer.SimpleRenderer"===l.observationRenderer.declaredClass&&this._buildRow_Renderer(a,l.observationRenderer.symbol,h,A.encode(l.observationRenderer.label)||this.NLS_previousObservations,null,r);else if("esri.renderer.UniqueValueRenderer"===
l.declaredClass){if(l.infos&&0<l.infos.length){B=C=!0;if(l.legendOptions&&l.legendOptions.title||l.valueExpressionTitle)n=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),r=d.create("tbody",{},n),v=l.legendOptions&&l.legendOptions.title?l.legendOptions.title:l.valueExpressionTitle,this._buildRow_Renderer(a,null,h,A.encode(v),null,r);n=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);r=d.create("tbody",{},n);(a._hoverLabel||
a._hoverLabels)&&this._createHoverAction(n,a,b);l.attributeField&&q&&this._addSubHeader(r,this._getFieldAlias(l.attributeField,a,b));if(g){var H=l.authoringInfo;M=H.focus;var v=H.numClasses,G=H.field1.field,n=H.field2.field;if(v&&G&&n){var N=H.field1.normalizationField,H=H.field2.normalizationField,J=N&&this._i18n.showNormField||G&&"${field}",O=H&&this._i18n.showNormField||n&&"${field}",G=K.substitute({field:this._getFieldAlias(G,a,b),normField:N&&this._getFieldAlias(N,a,b)},J),n=K.substitute({field:this._getFieldAlias(n,
a,b),normField:H&&this._getFieldAlias(H,a,b)},O),N={shapeDescriptor:fa,rotation:this._getRotationAngleForFocus(M)||0};this._buildRow_Renderer(a,null,null,A.encode(G),null,r,null,N);N.rotation+=90;this._buildRow_Renderer(a,null,null,A.encode(n),null,r,null,N);this._drawRelationshipLegend(c,{numClasses:v,focus:M,uvInfos:l.infos})}}else{var L=[];f.forEach(l.infos,function(c){var e=null;this._isLayerEditable(a)&&a.types&&(e=this._getTemplateFromTypes(a.types,c.value));var g=c.label;null==g&&(g=this._getDomainName(l.attributeField,
c.value,a,b)||c.value);-1===f.indexOf(L,g)&&(L.push(g),this._buildRow_Renderer(a,c.symbol,h,A.encode(g),e,r))},this)}}M=!g&&this._displayDefaultSymbol(a,l,c)}else if("esri.renderer.ClassBreaksRenderer"===l.declaredClass){if(l.infos&&0<l.infos.length||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass)B=C=!0,F=this._isUnclassedRenderer(l),x||1!==l.infos.length||(k=(k=l.infos[0])&&k.symbol),F||(n=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),r=d.create("tbody",
{},n),v=this._getRendererTitle(l,a,b),this._buildRow_Renderer(a,null,h,A.encode(v),null,r)),n=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),r=d.create("tbody",{},n),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(n,a,b),F&&q&&E||(g=l.infos.slice(0).reverse(),f.forEach(g,function(b){var c=b.label;null!=c||F||(c=b.minValue+" - "+b.maxValue);this._buildRow_Renderer(a,b.symbol,h,A.encode(c),null,r)},this)),"esri.layers.ArcGISImageServiceVectorLayer"!==
a.declaredClass||a.renderer.style!==U.STYLE_SCALAR&&a.renderer.style!==U.STYLE_SINGLE_ARROW||(this._buildRow_Renderer(a,l.defaultSymbol,null,"",null,r),a._hideDefaultSymbol=!0);F||(M=this._displayDefaultSymbol(a,l,c))}else if("esri.renderer.StretchRenderer"===l.declaredClass){B=C=!0;n=d.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},c);r=d.create("tbody",{},n);var I=this;a.renderingRule?a.getRenderingRuleServiceInfo(a.renderingRule).then(function(b){var c=b&&b.minValues&&
0<b.minValues.length&&b.maxValues&&0<b.maxValues.length;b&&1<b.bandCount||!c?I._legendRequest(a).then(function(b){I._processLegendResponse(a,b)}):I._createStretchLegend(r,l,b.minValues[0],b.maxValues[0])}):this.createStretchLegend(r,l,a.serviceInfo.minValues[0],a.serviceInfo.maxValues[0])}else"esri.renderer.SimpleRenderer"===l.declaredClass&&(B=C=!0,n=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),r=d.create("tbody",{},n),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(n,
a,b),k=null,this._isLayerEditable(a)&&a.templates&&0<a.templates.length&&(k=a.templates[0]),g=1<v?null:p&&D||t&&Q||u&&E,this._buildRow_Renderer(a,l.symbol,h,A.encode(g?this._getRampTitle(1<v?null:x||y||q,a,b):l.label),k,r),k=x?null:l.symbol,g&&(p=t=u=null));B&&(x&&D&&(x.field||x.valueExpression)&&this._showGradientRamp(a,b,l,null,c,x,p,null,q&&E?!0:!1),q&&E&&(q.field||q.valueExpression&&!ga.test(q.valueExpression))&&(B=x&&D||"esri.renderer.UniqueValueRenderer"===l.declaredClass?!1:!0,this._showSizeLegend(a,
b,l,q,h,c,u,null,B)),y&&Q&&(y.field||y.valueExpression)&&this._showGradientRamp(a,b,l,k&&!k.url&&k.color?k.color:this.transparencyRampColor,c,y,t,null,!1));M||F&&!D&&!E&&!Q||(M=this._displayDefaultSymbol(a,l,c));C=C||M}C&&(w.set(z.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<e&&(w.set(z.byId(this.id+"_"+a.id+"_"+e+"_group"),"display","block"),this._findParentGroup(a.id,e)));return C},_createStretchLegend:function(a,b,c,e){var g=d.create("tr",{},a),f;f=d.create("td",{rowspan:2,"class":"esriStretchLegend"},
g);b=d.toDom(this._addColorRamp(b.colorRamp));d.place(b,f);d.create("td",{},g).innerHTML=this._i18n.high+": "+Math.round(e*Math.pow(10,3))/Math.pow(10,3);a=d.create("tr",{},a);d.create("td",{},a).innerHTML=this._i18n.low+": "+Math.round(c*Math.pow(10,3))/Math.pow(10,3)},_addColorRamp:function(a){a||(a={algorithm:"hsv",fromColor:[0,0,0,1],toColor:[255,255,255,1]});var b=this._generateColorRampDivs(a);a.label="\x3cdiv class\x3d'esriStretchLegendGradientLabel'\x3e"+b+"\x3c/div\x3e";return a.label},_generateColorRampDivs:function(a){if(a){var b,
c="";"multipart"===a.type?(b=100/a.colorRamps.length,f.forEach(a.colorRamps.reverse(),function(a){c+=this._generateSingleGradientDiv(a.fromColor,a.toColor,b)},this)):c=this._generateSingleGradientDiv(a.fromColor,a.toColor,100);return c}},_generateSingleGradientDiv:function(a,b,c){if(a&&b){var e,g="";a=a.toRgb?a.toRgb():a;b=b.toRgb?b.toRgb():b;e="(0deg, rgb("+a.slice(0,3).join()+"), rgb("+b.slice(0,3).join()+"));";f.forEach(["-webkit-linear-gradient","-o-linear-gradient","-moz-linear-gradient","linear-gradient"],
function(a){g+="background: "+a+e});return"\x3cdiv class\x3d'esriStretchLegendSingleGradient' style\x3d'height:"+c+"%;"+g+"'\x3e\x3c/div\x3e"}},_isLayerEditable:function(a){return"function"===typeof a.isEditable&&a.isEditable()},_isUnclassedRenderer:function(a,b){var c;if("esri.renderer.ClassBreaksRenderer"===a.declaredClass&&a.infos&&1===a.infos.length){c=a.attributeField;var e=a.normalizationField;c=b?c===b:!!this._getVariables(a,c,e).length}return c},_displayDefaultSymbol:function(a,b,c){var e;
!a._hideDefaultSymbol&&b.defaultSymbol&&(e=!0,c=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),c=d.create("tbody",{},c),this._buildRow_Renderer(a,b.defaultSymbol,null,A.encode(b.defaultLabel)||"others",null,c));return e},_showGradientRamp:function(a,b,c,e,g,f,h,k,r){r=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(r?"":" esriLegendSubFragment")},g);g=d.create("tbody",{},r);(a._hoverLabel||a._hoverLabels||k)&&this._createHoverAction(r,
a,b,k);(h||f.valueExpression||f.legendOptions&&f.legendOptions.title)&&this._addSubHeader(g,this._getRampTitle(f,a,b));h=f.field;var l;h&&(l=m.isFunction(h)?null:this.getField(a,h,b));if(f=(b=this._getRampStops(c,f,e,l&&"esriFieldTypeDate"===l.type))?b.length:0)f=10<f,this._drawGradientRamp(g,b,!f,a,this._getRampBorderColor(c),!!e,f)},_getMedianColor:function(a,b){var c,e;b.colors?(c=b.minDataValue,e=b.maxDataValue):b.stops&&(c=b.stops[0].value,e=b.stops[b.stops.length-1].value);return a.getColor(c+
(e-c)/2,{colorInfo:b})},_getRampStops:function(a,b,c,e){var g,d,h,k,r=!1;b.colors||b.opacityValues?(d=b.maxDataValue-b.minDataValue,g=f.map([0,.25,.5,.75,1],function(a){h=b.minDataValue+a*d;return Number(h.toFixed(6))}),this._checkPrecision(0,4,g)):b.stops&&(g=f.map(b.stops,function(a){return a.value}),(r=f.some(b.stops,function(a){return!!a.label}))&&(k=f.map(b.stops,function(a){return a.label})));var l=g[0],m,p;d=g[g.length-1]-l;return f.map(g,function(f,n){c?(m=new x(c.toRgba()),p=a.getOpacity(f,
{opacityInfo:b}),null!=p&&(m.a=p)):m=a.getColor(f,{colorInfo:b});var h="";if(r)h=k[n];else{var h=e?L.formatDate(f,L.timelineDateFormatOptions):E.format(f),C="";0===n?C=this._specialChars.lt+" ":n===g.length-1&&(C=this._specialChars.gt+" ");h=C+h}return{value:f,color:m,offset:1-(f-l)/d,label:h}},this).reverse()},_checkPrecision:function(a,b,c){var e=a+(b-a)/2,g=c[a],d=c[e],f=c[b],h=Math.floor(g),r=Math.floor(d),l=Math.floor(f);h===g&&l===f&&r!==d&&h!==r&&l!==r&&(c[e]=r);a+1!==e&&this._checkPrecision(a,
e,c);e+1!==b&&this._checkPrecision(e,b,c)},_getRampBorderColor:function(a){var b;if("esri.renderer.SimpleRenderer"===a.declaredClass)b=a.symbol;else if("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)b=a.infos[0].symbol;return(a=b&&-1===b.type.indexOf("linesymbol")?b.getStroke():null)&&a.color},_drawGradientRamp:function(a,b,c,e,g,h,m){var n=d.create("tr",{},a),r,l,B,p,q,u=b.length-1,t;p=0;this.alignRight?(a=d.create("td",{align:this._isRightToLeft?
"left":"right"},n),r=d.create("td",{align:this._isRightToLeft?"left":"right",width:this.gradientWidth},n)):(r=d.create("td",{width:this.gradientWidth,align:"center"},n),a=d.create("td",{},n));n=g&&0<g.a&&!(240<=g.r&&240<=g.g&&240<=g.b);l=d.create("div",{"class":n?"":"esriLegendBorderLessColorRamp",style:"position: relative; width:"+this.gradientWidth+"px;"},r);r=d.create("div",{"class":"esriLegendColorRamp"+(h?" esriLegendTransparencyRamp":"")},l);h=w.get(r,"width");n&&(g=9>k("ie")?g.toHex():"rgba("+
g.toRgba().join(",")+")",w.set(r,"border",this.colorRampBorder+" "+g));c?(g=this.gradientHeight*u,w.set(r,"height",g+"px")):g=w.get(r,"height");w.set(l,"height",g+"px");n=O.createSurface(r,h,g);9>k("ie")&&(p=n.getEventSource(),w.set(p,"position","relative"),w.set(p.parentNode,"position","relative"),p=1);try{c&&f.forEach(b,function(a,b){a.offset=b/u}),q=n.createRect({x:-p,y:-p,width:h+p,height:g+p}),q.setFill({type:"linear",x1:0,y1:0,x2:0,y2:g,colors:b}).setStroke(null),n.createRect({width:h,height:g}).setFill(new x([255,
255,255,1-e.opacity])).setStroke(null),this._surfaceItems.push(n)}catch(pa){n.clear(),n.destroy()}f.forEach(b,function(a,c){a.label&&(t="top:"+100*a.offset+"%;",a="",0===c&&(a+=" esriLegendColorRampTickFirst"),c===b.length-1&&(a+=" esriLegendColorRampTickLast"),d.create("div",{"class":"esriLegendColorRampTick"+a,innerHTML:"\x26nbsp;",style:t},l))});B=d.create("div",{"class":"esriLegendColorRampLabels",style:{height:g+this.gradientHeight+"px"}},a);c?f.forEach(b,function(a){d.create("div",{"class":"esriLegendColorRampLabel",
innerHTML:A.encode(a.label)||"\x26nbsp;"},B)}):(d.create("div",{"class":"esriLegendColorRampLabel",innerHTML:m?A.encode(b[0].label)||"\x26nbsp;":this._i18n.high},B),d.create("div",{"class":"esriLegendColorRampLabel",innerHTML:m?A.encode(b[b.length-1].label)||"\x26nbsp;":this._i18n.low,style:"top: "+(g+this.gradientHeight-2*this.gradientHeight)+"px;"},B))},_showHeatRamp:function(a,b,c,e,g){var f,h=c.field;f=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);e=d.create("tbody",
{},f);(a._hoverLabel||a._hoverLabels||g)&&this._createHoverAction(f,a,b,g);(h=h&&this.getField(a,h,b))&&this._addSubHeader(e,this._getFieldAlias(h.name,a,b));b=this._getHeatmapStops(c);b.length&&this._drawGradientRamp(e,b,!1,a)},_getHeatmapStops:function(a){var b=a.colorStops;a=a.colors;var c,e,g,d;b&&b[0]?(c=b.length-1,(a=b[0]&&null!=b[0].ratio)?(a=b[c])&&1!==a.ratio&&(b=b.slice(0),b.push({ratio:1,color:a.color}),c++):(e=b[0].value,g=b[c].value-e,b=f.map(b,function(a){return{color:a.color,ratio:(a.value-
e)/g}}))):a&&a[0]&&(c=a.length-1,d=1/(a.length-1),b=f.map(a,function(a,b){return{color:a,ratio:b*d}}));b=f.map(b,function(a,b){var e="";0===b?e="Low":b===c&&(e="High");return{color:a.color,label:e,offset:1-a.ratio}});return b.reverse()},_showDotDensityLegend:function(a,b,c,e){var g=c.legendOptions,h,k,p,r,l,q,u,t=this.dotDensitySwatchSize,v=Math.round(t/2);g&&(k=g.backgroundColor,p=g.outline,r=g.valueUnit,l=g.dotCoverage);l=(l||this.dotCoverage)/100;u=Math.round(t*t/Math.pow(c.dotSize,2)*l);e=d.create("table",
{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);q=d.create("tbody",{},e);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(e,a,b);this._addSubHeader(q,K.substitute({value:c.dotValue,unit:r||""},this.NLS_dotValue));f.forEach(c.fields,function(e){e=m.mixin({},e);e.numPoints=u;h=new Z(c._generateImageSrc(t,t,[e],{x:0,y:0},{x:t,y:t},k),p||c.outline,t,t);e=this.getField(a,e.name,b)||e;this._buildRow_Renderer(a,h,null,A.encode(this._getFieldAlias(e.name,a,b)),null,q,{type:"path",
path:"M "+-v+","+-v+" L "+v+","+-v+" L "+v+","+v+" L "+-v+","+v+" L "+-v+","+-v+" E"})},this)},_showSizeLegend:function(a,b,c,e,g,f,h,k,r){var l=e.legendOptions,l=l&&l.customValues;g=this._getSizeSymbol(c,g);if((!e.valueUnit||"unknown"===e.valueUnit)&&g&&(l||null!=e.minSize&&null!=e.maxSize&&null!=e.minDataValue&&null!=e.maxDataValue||e.stops&&!(1>=e.stops.length))){r=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(r?"":" esriLegendSubFragment")},f);f=d.create("tbody",
{},r);(a._hoverLabel||a._hoverLabels||k)&&this._createHoverAction(r,a,b,k);(h||e.valueExpression||e.legendOptions&&e.legendOptions.title)&&this._addSubHeader(f,this._getRampTitle(e,a,b));h=(r=(k=e.field)&&!m.isFunction(k))&&"cluster_count"===k.toLowerCase();b=(b=r?a.isFeatureReductionActive&&a.isFeatureReductionActive()?a.getFeatureReductionField(k):this.getField(a,k,b):null)&&"esriFieldTypeDate"===b.type;var l=l||this._getDataValues(c,g,e,b,h),n,p=l.length-1;for(k=p;0<=k;k--)r=l[k],g=P.fromJson(g.toJson()),
this._applySize(g,c,e,r),r=b?L.formatDate(r,L.timelineDateFormatOptions):E.format(r),n="",k===p?n=this._specialChars.gt+" ":0===k&&(n=h&&1===l[k]?"":this._specialChars.lt+" "),n="\x3cspan class\x3d'esriLegendSizeRampLabel'\x3e"+A.encode(n+r)+"\x3c/span\x3e",this._buildRow_Renderer(a,g,null,n,null,f)}},_getSizeSymbol:function(a,b){var c,e;if("esri.renderer.SimpleRenderer"===a.declaredClass)c=a.symbol;else if("esri.renderer.VectorFieldRenderer"===a.declaredClass)c=a.defaultSymbol;else if("esri.renderer.UniqueValueRenderer"===
a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)c=a.infos[0].symbol,e=1<a.infos.length;if(c=c&&-1!==c.type.indexOf("fillsymbol")?null:c)if(c=P.fromJson(c.toJson()),b||e)-1!==c.type.indexOf("linesymbol")?c.setColor(new x(this.sizeRampDarkColor)):(c.setColor(new x(this.sizeRampLightColor)),c.setOutline&&(a=new aa,a.setColor(new x(this.sizeRampDarkColor)),a.setWidth(1.5),c.setOutline(a)));return c},_getDataValues:function(a,b,c,e,g){if(g){var d;f.some([5,3,2],function(g){g=this._getDataValuesByCount(a,
b,c,e,g);this._hasFractionalValues(g)||(d=g);return!!d},this);return d}return this._getDataValuesByCount(a,b,c,e,5)},_getDataValuesByCount:function(a,b,c,e,g,d){g=null==g?5:g;d=null==d?20:d;var h=a.getSizeRangeAtScale(c,this.map.getScale());g=this._interpolateSizeRange(h,g);var k=this._getDataRange(c),n=f.map(g,function(a){return this._getDataValueFromSize(a,k,h)},this);if(!e){var l,n=E.round(n);for(e=1;e<n.length-1;e++)if(l=this._roundDataValue(a,b,c,n[e],n[e-1],d))n[e]=l[0],g[e]=l[1]}return n},
_hasFractionalValues:function(a){return f.some(a,function(a){return a!==Math.floor(a)})},_getDataRange:function(a){var b=a.stops;return b?{min:b[0].value,max:b[b.length-1].value}:{min:a.minDataValue,max:a.maxDataValue}},_interpolateSizeRange:function(a,b){var c=a.minSize;a=(a.maxSize-c)/(b-1);var e,g=[];for(e=0;e<b;e++)g.push(c+a*e);return g},_getDataValueFromSize:function(a,b,c){var e=c.minSize;c=c.maxSize;var g=b.min;b=b.max;return a<=e?g:a>=c?b:(a-e)/(c-e)*(b-g)+g},_roundDataValue:function(a,b,
c,e,g,d){var f=this._getSize(b,a,c,e);g=this._getSize(b,a,c,g);var h,k=E.getDigits(e),l=k.integer,k=k.fractional,n,m,p,q,t,u,v,x,w,y,z;0<e&&1>e&&(h=Math.pow(10,k),e*=h,l=E.getDigits(e).integer);for(--l;0<=l&&(n=Math.pow(10,l),k=Math.floor(e/n)*n,n*=Math.ceil(e/n),null!=h&&(k/=h,n/=h),m=(k+n)/2,m=E.round([k,m,n],{indexes:[1]})[1],p=this._getSize(b,a,c,k),q=this._getSize(b,a,c,n),t=this._getSize(b,a,c,m),u=E.getPctChange(f,p,g,null),v=E.getPctChange(f,q,g,null),x=E.getPctChange(f,t,g,null),w=u.prev<=
d,y=v.prev<=d,w&&y&&(u.prev<=v.prev?(w=!0,y=!1):(y=!0,w=!1)),w?z=[k,p]:y?z=[n,q]:x.prev<=d&&(z=[m,t]),!z);l--);return z},_applySize:function(a,b,c,e){var g=a.type;b=this._getSize(a,b,c,e);switch(g){case "simplemarkersymbol":a.setSize(b);break;case "picturemarkersymbol":g=a.width;c=a.height;a.setHeight(b);a.setWidth(g/c*b);break;case "simplelinesymbol":case "cartographiclinesymbol":a.setWidth(b);break;case "textsymbol":a.font&&a.font.setSize(b)}},_getSize:function(a,b,c,e){return b.getSize(e,{sizeInfo:c,
scale:this.map.getScale(),shape:-1!==a.type.indexOf("markersymbol")?a.style:null})},_buildRow_Renderer:function(a,b,c,e,g,f,h,k){var n=!!k,l=d.create("tr",{},f),m;if(this.alignRight){if(f=d.create("td",{align:this._isRightToLeft?"left":"right"},l),b||n)m=d.create("td",{align:this._isRightToLeft?"left":"right",width:35},l)}else{if(b||n)m=d.create("td",{width:35,align:"center"},l);f=d.create("td",{},l)}var p=l=30,q;if(b)if("simplemarkersymbol"==b.type)l=Math.min(Math.max(l,b.size+12),125),p=Math.min(Math.max(p,
b.size+12),125);else if("picturemarkersymbol"==b.type)l=Math.min(Math.max(l,b.width),125),p=Math.min(b.height||p,125);else if("textsymbol"==b.type){var t,u;b.text||(t=b.text,u=!0,b.setText(this.defaultText));l=Math.min(Math.max(l,b.getWidth()+12),125);p=Math.min(Math.max(p,b.getHeight()+12),125);u&&b.setText(t)}if(b||n)q=d.create("div",{style:"width:"+l+"px;height:"+p+"px;"},m);K.isDefined(e)&&"number"===typeof e&&(e=""+e);d.create("td",{innerHTML:e||"",align:this._align},d.create("tr",{},d.create("tbody",
{},d.create("table",{width:"95%"},f))));if(b||n)a=this._drawSymbol(q,b,c,l,p,g,a,h,k),this._surfaceItems.push(a)},_addSubHeader:function(a,b){a=d.create("tr",{},a);a=d.create("td",{align:this._align,colspan:2},a);d.create("td",{innerHTML:A.encode(b)||"",align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%"},a))))},_drawSymbol:function(a,b,c,e,g,d,f,h,p){var l=b&&P.fromJson(b.toJson()),n=f.opacity;b=!!p;if(l)if(c&&l.setColor(new x(c.toRgba())),"simplelinesymbol"===l.type||
"cartographiclinesymbol"===l.type||"textsymbol"===l.type){if(!l.color)return;c=l.color.toRgba();c[3]*=n;l.color.setColor(c)}else"simplemarkersymbol"===l.type||"simplefillsymbol"===l.type?(l.color&&(c=l.color.toRgba(),c[3]*=n,l.color.setColor(c)),l.outline&&l.outline.color&&(c=l.outline.color.toRgba(),c[3]*=n,l.outline.color.setColor(c))):"picturemarkersymbol"===l.type&&(a.style.opacity=n,a.style.filter="alpha(opacity\x3d("+100*n+"))");a=O.createSurface(a,e,g);9>k("ie")&&(c=a.getEventSource(),w.set(c,
"position","relative"),w.set(c.parentNode,"position","relative"));d=b?p.shapeDescriptor:this._getDrawingToolShape(l,d)||P.getShapeDescriptors(l);var r,n=(c=d.defaultShape)&&"text"===c.type;try{n&&!c.text&&(c.text=this.defaultText),r=a.createShape(h||c).setFill(d.fill).setStroke(d.stroke),n&&r.setFont(d.font)}catch(oa){a.clear();a.destroy();return}var q=r.getBoundingBox();h=q.width;d=q.height;var n=-(q.x+h/2),t=-(q.y+d/2);c=a.getDimensions();n={dx:n+c.width/2,dy:t+c.height/2};if(l&&"simplemarkersymbol"===
l.type&&"path"===l.style)e=f._getScaleMatrix(q,l.size),r.applyTransform(J.scaleAt(e.xx,e.yy,{x:c.width/2,y:c.height/2}));else if(h>e||d>g)f=h/e>d/g,e=((f?e:g)-5)/(f?h:d),m.mixin(n,{xx:e,yy:e});r.applyTransform(n);b&&r.applyTransform(J.rotategAt(p.rotation,h/2,d/2));return a},_getDrawingToolShape:function(a,b){switch(b?b.drawingTool||null:null){case "esriFeatureEditToolArrow":b={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 Z"};break;case "esriFeatureEditToolTriangle":b=
{type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 Z"};break;case "esriFeatureEditToolRectangle":b={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 Z"};break;case "esriFeatureEditToolCircle":b={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":b={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:b,fill:a.getFill(),stroke:a.getStroke()}},_drawRelationshipLegend:function(a,b){var c=b.focus,e=b.numClasses,g=ea[e],d=!!c,f=Math.sqrt(Math.pow(75,
2)+Math.pow(75,2)),h={};b.uvInfos.forEach(function(a){h[a.value]={label:a.label,fill:this._getSymbolColor(a.symbol)}},this);b=[];for(var k=0;k<e;k++){for(var l=[],m=0;m<e;m++)l.push(h[g[k][m]].fill);b.push(l)}g=this._getRelationshipCornerLabels(c,h);a=this._drawRampLayout(a,g,f,d);a=O.createSurface(a,f,f);d||(a.rawNode.style.margin="-15px -15px -18px -15px");b=ba.create2DColorRamp({surface:a,colors:b,numClasses:e,size:75});e=(f-75)/2;f=(f-75)/2;b.applyTransform(J.translate(e,f));d&&b.applyTransform(J.rotategAt(this._getRotationAngleForFocus(c),
37.5,37.5));b=a.createGroup();g={width:1,color:"#555555"};k=a.defNode;this._createArrowMarker(k,"start");this._createArrowMarker(k,"end");k=b.createLine({x1:-10,y1:60,x2:-10,y2:15}).setStroke(g);g=b.createLine({x1:15,y1:85,x2:60,y2:85}).setStroke(g);this._setLineArrow(k.rawNode,"left",c);this._setLineArrow(g.rawNode,"right",c);b.applyTransform(J.translate(e,f));d&&b.applyTransform(J.rotategAt(-45,37.5,37.5));this._surfaceItems.push(a)},_drawRampLayout:function(a,b,c,e){var g=d.create("div",{style:{padding:"10px"}},
a);a=c+"px";c+="px";e?(e=d.create("div",{style:{display:"flex"}},g),d.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a,textAlign:"right"},innerHTML:b.left},e),g=d.create("div",{style:{display:"flex",flexDirection:"column",textAlign:"center"}},e),d.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.right},e),e=d.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.top},
g),e=d.create("div",{style:{height:c,width:c}},g),g=d.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.bottom},g)):(g=d.create("div",{style:{display:"table",color:"#555555"}},g),e=d.create("div",{style:{display:"table-row"}},g),c=d.create("div",{style:{display:"table-row"}},g),g=d.create("div",{style:{display:"table-row"}},g),d.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"right",verticalAlign:"bottom"},
innerHTML:b.left},e),d.create("div",{style:{display:"table-cell"}},e),d.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"left",verticalAlign:"bottom"},innerHTML:b.top},e),d.create("div",{style:{display:"table-cell"}},c),e=d.create("div",{style:{display:"table-cell"}},c),d.create("div",{style:{display:"table-cell"}},c),d.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"right",verticalAlign:"top"},
innerHTML:b.bottom},g),d.create("div",{style:{display:"table-cell"}},g),d.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"left",verticalAlign:"top"},innerHTML:b.right},g));return e},_getSymbolColor:function(a){if(a)return"simplelinesymbol"===a.type||"simplemarkersymbol"===a.type&&(a.style===V.STYLE_X||a.style===V.STYLE_CROSS)?(a=a.getStroke())&&a.color:a.getFill()},_getRotationAngleForFocus:function(a){var b=X[a];a&&null==b&&(b=X.HH);return b},_setLineArrow:function(a,
b,c){var e=this.id+"_arrowStart",d=this.id+"_arrowEnd";b="left"===b;switch(c){case "HL":a.setAttribute(b?"marker-start":"marker-end","url(#"+(b?d:e)+")");break;case "LL":a.setAttribute("marker-start","url(#"+d+")");break;case "LH":a.setAttribute(b?"marker-end":"marker-start","url(#"+(b?e:d)+")");break;default:a.setAttribute("marker-end","url(#"+e+")")}},_createArrowMarker:function(a,b){var c="start"===b,e=this.id+(c?"_arrowStart":"_arrowEnd");b=c?"0,0 5,5 0,10":"5,0 0,5 5,10";var d=c?5:0,c=document.createElementNS("http://www.w3.org/2000/svg",
"marker");c.setAttribute("id",e);c.setAttribute("markerWidth","10");c.setAttribute("markerHeight","10");c.setAttribute("refX",d);c.setAttribute("refY","5");c.setAttribute("markerUnits","strokeWidth");c.setAttribute("orient","auto");e=document.createElementNS("http://www.w3.org/2000/svg","polyline");e.setAttribute("points",b);e.setAttribute("fill","none");e.setAttribute("stroke","#555555");e.setAttribute("stroke-width","1");c.appendChild(e);a.appendChild(c)},_getRelationshipCornerLabels:function(a,
b){var c=b.HH.label,e=b.LL.label,d=b.HL.label;b=b.LH.label;switch(a){case "HH":return{top:c,bottom:e,left:d,right:b};case "HL":return{top:d,bottom:b,left:e,right:c};case "LL":return{top:e,bottom:c,left:b,right:d};case "LH":return{top:b,bottom:d,left:c,right:e};default:return{top:c,bottom:e,left:d,right:b}}},_repaintItems:function(){f.forEach(this._surfaceItems,function(a){this._repaint(a)},this)},_repaint:function(a){if(a){a.getStroke&&a.setStroke&&a.setStroke(a.getStroke());try{a.getFill&&a.setFill&&
a.setFill(a.getFill())}catch(b){}a.children&&m.isArray(a.children)&&f.forEach(a.children,this._repaint,this)}},_createHoverAction:function(a,b,c,e){if(e=b._hoverLabel||b._hoverLabels&&b._hoverLabels[c.id]||e)e=A.encode(e),b.mouseMoveHandler=b.mouseMoveHandler||{},b.mouseMoveHandler[c.id]=p.connect(a,"onmousemove",m.hitch(this,function(a,b){this.mouseX=b.clientX;this.mouseY=b.clientY;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,w.set(z.byId(this.id+"_hoverLabel"),"display","none"));setTimeout(m.hitch(this,
function(a,b,c){if(a==this.mouseX&&b==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=!0,z.byId(this.id+"_hoverLabel")){var e=z.byId(this.id+"_hoverLabel");e.innerHTML="\x3cspan\x3e"+c+"\x3c/span\x3e";w.set(e,"top",b+"px");w.set(e,"left",a+15+"px");w.set(e,"display","")}else d.create("div",{innerHTML:"\x3cspan\x3e"+c+"\x3c/span\x3e",id:this.id+"_hoverLabel","class":"esriLegendHoverLabel",style:{top:b+"px",left:a+15+"px"}},document.body)},b.clientX,b.clientY,a),500)},e)),b.mouseOutHandler=
b.mouseOutHandler||{},b.mouseOutHandler[c.id]=p.connect(a,"onmouseout",m.hitch(this,function(a){this.mouseY=this.mouseX=-1;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,w.set(z.byId(this.id+"_hoverLabel"),"display","none"))}))},_removeHoverHandlers:function(){var a;f.forEach(this.layers,function(b){if(b.mouseMoveHandler)for(a in b.mouseMoveHandler)p.disconnect(b.mouseMoveHandler[a]);if(b.mouseOutHandler)for(a in b.mouseOutHandler)p.disconnect(b.mouseOutHandler[a])})},_createDynamicLayers:function(a){var b=
[],c;f.forEach(a.dynamicLayerInfos||a.layerInfos,function(e){c={id:e.id};c.source=e.source&&e.source.toJson();var d;a.layerDefinitions&&a.layerDefinitions[e.id]&&(d=a.layerDefinitions[e.id]);d&&(c.definitionExpression=d);var f;a.layerDrawingOptions&&a.layerDrawingOptions[e.id]&&(f=a.layerDrawingOptions[e.id]);f&&(c.drawingInfo=f.toJson());c.minScale=e.minScale||0;c.maxScale=e.maxScale||0;b.push(c)});return b},_getTemplateFromTypes:function(a,b){var c;for(c=0;c<a.length;c++)if(a[c].id==b&&a[c].templates&&
0<a[c].templates.length)return a[c].templates[0];return null},_findParentGroup:function(a,b,c){var e,d=b.dynamicLayerInfos||b.layerInfos;for(e=0;e<d.length;e++)if(c==d[e].id){-1<d[e].parentLayerId&&(w.set(z.byId(this.id+"_"+a+"_"+d[e].parentLayerId+"_group"),"display","block"),this._findParentGroup(a,b,d[e].parentLayerId));break}},_addSubLayersToHide:function(a){function b(c,d){var e=a.layer.dynamicLayerInfos||a.layer.layerInfos,h,k;for(h=0;h<e.length;h++)if(e[h].id===c&&e[h].subLayerIds)for(k=0;k<
e[h].subLayerIds.length;k++){var m=e[h].subLayerIds[k];-1===f.indexOf(d,m)&&(d.push(m),b(m,d))}}a.layer.layerInfos&&f.forEach(this.hideLayersInLegend[a.layer.id],function(c){b(c,this.hideLayersInLegend[a.layer.id])},this)},_isLayerInScale:function(a,b,c){var d,g=!0;if(a.legendResponse&&a.legendResponse.layers)for(d=0;d<a.legendResponse.layers.length;d++){var f=a.legendResponse.layers[d];if(b.id==f.layerId){var h,k;!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale?(0==f.minScale&&a.tileInfo&&
(h=a.tileInfo.lods[0].scale),0==f.maxScale&&a.tileInfo&&(k=a.tileInfo.lods[a.tileInfo.lods.length-1].scale)):(h=Math.min(a.minScale,f.minScale)||a.minScale||f.minScale,k=Math.max(a.maxScale,f.maxScale));if(0<h&&h<c||k>c)g=!1;break}}else if(a.minScale||a.maxScale)if(a.minScale&&a.minScale<c||a.maxScale&&a.maxScale>c)g=!1;return g},_getServiceTitle:function(a){var b=a._titleForLegend;b||(b=a.url,a.url?-1<a.url.indexOf("/MapServer")?(b=a.url.substring(0,a.url.indexOf("/MapServer")),b=b.substring(b.lastIndexOf("/")+
1,b.length)):-1<a.url.indexOf("/ImageServer")?(b=a.url.substring(0,a.url.indexOf("/ImageServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/FeatureServer")&&(b=a.url.substring(0,a.url.indexOf("/FeatureServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):b="",a.name&&(b=0<b.length?b+(" - "+a.name):a.name));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&a.vectorFieldPixelFilter&&(a=a.vectorFieldPixelFilter.outputUnit?this["NLS_"+a.vectorFieldPixelFilter.outputUnit]:
this["NLS_"+a.vectorFieldPixelFilter.inputUnit],K.isDefined(a)&&(b+=" ("+a+")"));return A.encode(b)},_getEffectiveScale:function(a,b){var c=b.minScale,d=b.maxScale;if(K.isDefined(b.parentLayerId)){a=a.layerInfos;b=b.parentLayerId;var f;for(f=a.length-1;0<=f;f--)if(a[f].id==b)if(0==c&&0<a[f].minScale?c=a[f].minScale:0<c&&0==a[f].minScale||0<c&&0<a[f].minScale&&(c=Math.min(c,a[f].minScale)),d=Math.max(d||0,a[f].maxScale||0),-1<a[f].parentLayerId)b=a[f].parentLayerId;else break}return{minScale:c,maxScale:d}},
_isSupportedLayerType:function(a){return!(!a||!("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.2<=a.version||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass||"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass||"esri.layers.KMLLayer"===a.declaredClass||"esri.layers.GeoRSSLayer"===a.declaredClass||"esri.layers.WMSLayer"===
a.declaredClass||"esri.layers.WFSLayer"===a.declaredClass||"esri.layers.CSVLayer"===a.declaredClass))},isHostedTileService:function(a){var b=/(https?:)?\/\/services.*\.arcgis\.com/i;return!("esri.layers.ArcGISTiledMapServiceLayer"!==a.declaredClass||!b.test(a.url))},getField:function(a,b,c){if(a.getField)return a.getField(b);if(c&&c.fields){var d;f.forEach(c.fields,function(a){a.name===b&&(d=a)});return d}return null}});m.mixin(F,{ALIGN_LEFT:0,ALIGN_RIGHT:1});k("extend-esri")&&m.setObject("dijit.Legend",
F,Y);return F});