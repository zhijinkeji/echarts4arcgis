// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterLib/function/ColormapFunction","dojo/_base/declare dojo/_base/lang ../../../renderers/colorRampGenerator ./RasterFunctionX ./pixelShaders ./RasterFunctionWebGLMixin ./rasterUtils".split(" "),function(m,n,k,p,q,r,l){return m([p,r],{declaredClass:"esri.layers.rasterLib.function.ColormapFunction",functionName:"Colormap",pixelType:"U8",renderTexture:!1,supportWebGL:!0,support2D:!0,constructor:function(a){this.functionArguments=this.mixinIgnoreCase({colormap:null,colorRampName:null,
colorRamp:null,colorMapName:null,raster:null},a);this.invert=a&&a.invert;a=a.colormap||a.Colormap;var d,b,e,c,f,h,g;if(a){if(a.features||a[0].attributes){a=a.features||a;d=Object.keys(a[0].attributes);e=d.filter(function(a){return"alpha"===a.toLowerCase()})[0];b=d.filter(function(a){return"value"===a.toLowerCase()})[0];c=d.filter(function(a){return"red"===a.toLowerCase()})[0];f=d.filter(function(a){return"green"===a.toLowerCase()})[0];h=d.filter(function(a){return"blue"===a.toLowerCase()})[0];if(!(b&&
c&&f&&h))throw"invalid colormap";a=a.map(function(a){return e?[a.attributes[b],a.attributes[c],a.attributes[f],a.attributes[h],a.attributes[e]]:[a.attributes[b],a.attributes[c],a.attributes[f],a.attributes[h]]});g=1.1>Math.max.apply(null,a.map(function(a){return a[1]}));d=e&&1.1>Math.max.apply(null,a.map(function(a){return a[4]}));if(g)for(g=0;g<a.length;g++)a[g][1]=Math.round(255*a[g][1]),a[g][2]=Math.round(255*a[g][2]),a[g][3]=Math.round(255*a[g][3]),d&&(a[g][4]=Math.round(255*a[g][4]))}this.functionArguments.colormap=
this._sortClr(a)}this._initialize()},bind:function(a){this._initialize();a=this.getSourceRasterInfo(a);if(!a.raster||"F32"===a.raster.pixelType)return Error("The raster input to colormap function is invalid. It must be integer type.");this.rasterInfo=n.mixin(a.raster,{bandCount:3,pixelType:this._calculatePixelType(this.pixelType,"U8"),statistics:null,histogram:null});this.rasterInfo.keyProperties=this.rasterInfo.keyProperties||{};this.rasterInfo.keyProperties.DataType="Processed";return!0},read2D:function(a){return this._colorize(a.raster)},
readGL:function(a){return this._colorizeGL(a.raster)},_colorize:function(a){this._performance.start();var d=l.colorize(a.pixelBlock,{indexedColormap:this._indexedColormap,indexedColormapOffset:this._indexedColormapOffset,indexed2DColormap:this._indexed2DColormap,alphaSpecified:this._alphaSpecified});this._addPerformanceMetric(this._performance.elapsed());return{extent:a.extent,pixelBlock:d}},_binarySearchClr:function(a,d){for(var b=0,e=a.length-1,c=0,f=0;b<e;)if(c=Math.floor((b+e)/2),f=a[c],f[0]<
d)b=c;else if(f[0]>d)e=c;else return f.slice(1);return null},_sortClr:function(a,d){var b,e,c=[];for(b=0;b<a.length;b++)c.push(a[b]);for(b=0;b<c.length-1;b++)for(e=c[b],a=b+1;a<c.length;a++)e[0]>c[a][0]&&(e=c[a],c[a]=c[b],c[b]=e);if(d)for(b=0;b<c.length/2;b++)e=c[b],c[c.length-1-b]=c[b],c[b]=e;return c},_invertColorRamp:function(a){if(!a)return a;var d={type:a.type};"random"===a.type?d=a:"multipart"===a.type?d.colorRamps=a.colorRamps.map(function(a){return{fromColor:a.toColor,toColor:a.fromColor}}).reverse():
(d.fromColor=a.toColor,d.toColor=a.fromColor);return d},_initialize:function(){this._indexedColormapOffset=0;if(this.functionArguments.colormap){var a=l.buildIndexedColormap(this.functionArguments.colormap);this._alphaSpecified=a&&a.alphaSpecified;this._indexedColormap=a&&a.indexedColormap;this._indexedColormapOffset=a&&a.offset;this._indexedColormap||(this._indexed2DColormap=this._getIndexed2DColormap())}else this.functionArguments.colorRamp?this._indexedColormap="multipart"===this.functionArguments.colorRamp.type?
this.invert?k.createMultiPartColorRamp(this._invertColorRamp(this.functionArguments.colorRamp)):k.createMultiPartColorRamp(this.functionArguments.colorRamp):this.invert?k.createAlgorithmicColorRamp(this._invertColorRamp(this.functionArguments.colorRamp)):k.createAlgorithmicColorRamp(this.functionArguments.colorRamp):this.functionArguments.colormapName&&"random"===this.functionArguments.colormapName.toLowerCase()&&(this._indexedColormap=k.createRandomColorRamp())},_getIndexed2DColormap:function(){var a=
this.functionArguments.colormap;if(!a)return null;var d=0;0>a[0][0]&&(d=a[0][0]);var b=[],e=5===a[0].length,c;for(c=0;c<a.length;c++)b[a[c][0]-d]=e?a[c].slice(1):a[c].slice(1).concat([255]);return b},_colorizeGL:function(a){this._performance.start();this._initializeProgram({fragment:q.colormap,fragmentName:"Colormap"});var d=this._indexedColormap,b=this._indexedColormapOffset;this._clrTexture||(this._clrTexture=this._setupColormapTexture(d));var e=this._clrTexture,c=this.bindFrameBuffer();a=this._setupTextureData(a);
this._setUniforms({u_indexedColormapOffset:b,u_indexedColormapMaxIndex:d.length/4-1});this._bindTexture(e,"u_image1");this._bindTexture(a.texture,"u_image");this._drawGL();return{extent:a.extent,texture:c.texture}},_setupColormapTexture:function(a){var d=this._createTexture(),b=this.gl,e=a.length/4,c=new Float32Array(a.length),f,h=this.renderTexture?255:1;for(f=0;f<a.length;f++)c[f]=a[f]/h;b.getExtension("OES_texture_float");b.texImage2D(b.TEXTURE_2D,0,b.RGBA,e,1,0,b.RGBA,b.FLOAT,c);return d}})});