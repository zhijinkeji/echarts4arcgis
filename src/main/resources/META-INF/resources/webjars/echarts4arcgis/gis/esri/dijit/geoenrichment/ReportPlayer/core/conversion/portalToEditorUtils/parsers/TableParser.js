// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/conversion/portalToEditorUtils/parsers/TableParser","dojo/_base/lang esri/dijit/geoenrichment/utils/JsonXmlConverter esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/templateJsonUtils/fieldInfo/FieldInfoBuilder esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/templateJsonUtils/fieldInfo/RichTextJsonUtil ../../../supportClasses/DocumentOptions ../../ConversionUtil ../../../sections/SectionTypes ./AlignParser ./_HiddenCellsCollector esri/dijit/geoenrichment/utils/ColorUtil".split(" "),
function(z,r,A,B,C,e,k,D,x,E){var w={parseTableCellAttributes:function(a,c,b){b=b.tableDefaultStyles;c=c||{};a.overrideStyle&&(c.overrideStyle=a.overrideStyle);a.pad&&(c.horizontalPadding=e.ptToPx(a.pad));a.vpad&&(c.verticalPadding=e.ptToPx(a.vpad));a.angle&&(c.angle=Number(a.angle)||0);D.parseAlign(a,c);a.width&&(c.width=e.ptToPx(a.width));a.height&&(c.height=e.ptToPx(a.height));z.mixin(c,e.ptToPxObj(e.parseStyleString(a.style)));if(c.overrideStyle&&b){b=b.getStyle(c.overrideStyle);for(var g in b)delete c[g]}w._parseBorderProperties(a,
c);return c},_SIDES:["Top","Right","Bottom","Left"],_parseBorderProperties:function(a,c){w._SIDES.forEach(function(b){if(a["border"+b+"Width"]){a["border"+b+"Color"]&&(c["border"+b+"Color"]=a["border"+b+"Color"]);a["border"+b+"Width"]&&(c["border"+b+"Width"]=e.ptToPx(a["border"+b+"Width"]));a["border"+b+"Style"]&&(c["border"+b+"Style"]=a["border"+b+"Style"]);var g=a["border"+b+"Opacity"];c["border"+b+"Opacity"]=g?Number(g):1}})}},p={getElement:function(a,c,b){var g=p._processTableColumns(a,c.templateJson,
b),f=Number(a.attributes.fixedColumns)||0,m=Number(a.attributes.dynamicColumns)||0,d=p._getTableOuterTags(a,c);b=d.trTags;var l=d.bgTag,q=d.fgTag,h=d.backgroundFloatingPanelsTag,k=d.foregroundFloatingPanelsTag,n=d.filterTag,d=d.sortingTag;if(b){var u=b.map(function(){return{style:{fields:{}},fieldInfos:{}}}),r=x.collectHiddenCells(b,c);b.forEach(function(a,b){var h=u[b];a.attributes&&a.attributes.height&&(h.style.height=e.ptToPx(a.attributes.height));if(a.tags&&a.tags.length){var d=0;if(m){var l=
[],q=[],k=0;a.tags.forEach(function(a){for(;x.isHidden(r,k,b);)k++;k<f?l.push(a):q.push(a);k++});var n=Math.round((g.length-f)/m);a.tags=l;for(var t=0;t<n;t++)a.tags=a.tags.concat(q)}a.tags.forEach(function(a){for(;x.isHidden(r,d,b);)d++;if(g[d]){var l=g[d].field,f=a.attributes||{},m=h.style.fields[l]={};w.parseTableCellAttributes(f,m,c);f.width&&p._parseSpannedCellsDimentions(f,u,g,b,d);var e=Number(f.colspan),f=Number(f.rowspan);e&&(h.columnSpans=h.columnSpans||{},h.columnSpans[l]=e);f&&(h.rowSpans=
h.rowSpans||{},h.rowSpans[l]=f);try{p._parseCellContent(a,h,l,m,c)}catch(F){console.log(F)}d++}})}})}b={id:"table",customName:a.attributes.customName,backgroundSectionJson:l&&p._parseTableBackgroundForeground(l,c,!0),foregroundSectionJson:q&&p._parseTableBackgroundForeground(q,c,!1),backgroundFloatingTablesSectionJson:h&&p._parseFloatingPanels(h,c,!0),foregroundFloatingTablesSectionJson:k&&p._parseFloatingPanels(k,c,!1),data:{columns:g,data:u||[]},style:{width:e.ptToPx(a.attributes.width),left:e.ptToPx(a.attributes.left),
top:e.ptToPx(a.attributes.spaceBefore),spaceAfter:e.ptToPx(a.attributes.spaceAfter),alternatingStyle:a.attributes.alternatingStyle,opacity:a.attributes.opacity?Number(a.attributes.opacity):void 0,fixedCellsOpacity:a.attributes.fixedCellsOpacity?Number(a.attributes.fixedCellsOpacity):void 0},attributes:{},presetFilter:n&&c.parsers.getParser("filter").getFilter(n)};var v=d&&c.parsers.getParser("sorting").getSorting(d);if(v){var y;g.some(function(a,b){if(b===v.columnIndex)return y=a.field,!0});y&&(v.field=
y,delete v.columnIndex,b.presetSorting=v)}f&&(b.attributes.fixedColumns=f);m&&(b.attributes.dynamicColumns=m);a.attributes.fixedRows&&(b.attributes.fixedRows=Number(a.attributes.fixedRows)||0);a.attributes.dynamicRows&&(b.attributes.dynamicRows=Number(a.attributes.dynamicRows)||0);b.attributes.inSectionRole=a.attributes.inSectionRole;return b},_processTableColumns:function(a,c,b){if(b&&b.fixTableWidthsForPage&&(c=e.pxToPt(C.getPageBox(c.documentOptions).contentW),a.attributes.widths&&Number(a.attributes.width)>
c)){b=e.splitTrim(a.attributes.widths,";",!0);var g=Number(a.attributes.width)-c,f=Number(b[b.length-1]);f>g&&(b[b.length-1]=f-g,a.attributes.widths=b.join(";"),a.attributes.width=c)}var m=0;return a.attributes.widths?e.splitTrim(a.attributes.widths,";",!0).map(function(a){return{field:"field"+m++,style:{width:e.ptToPx(a)}}}):[]},_getTableOuterTags:function(a,c){var b=[],g,f,m,d,l,e;1.1<=c.revisionVersion?a.tags&&a.tags.forEach(function(a){if("tr"===a.name)b.push(a);else if("filter"===a.name)l=a;
else if("sorting"===a.name)e=a;else switch(a.attributes.type){case k.TABLE_BACKGROUND:g=a;break;case k.TABLE_FOREGROUND:f=a;break;case k.TABLE_BACKGROUND_FLOATING_PANELS:m=a;break;case k.TABLE_FOREGROUND_FLOATING_PANELS:case k.TABLE_FLOATING_PANELS:d=a}}):a.tags&&a.tags.forEach(function(a){"tr"===a.name?b.push(a):"background"===a.name?g=a:"foreground"===a.name?f=a:"floatingElements"===a.name&&(d=a)});return{trTags:b,bgTag:g,fgTag:f,backgroundFloatingPanelsTag:m,foregroundFloatingPanelsTag:d,filterTag:l,
sortingTag:e}},_processTdContent:function(a,c){function b(a){a=a.tags&&1===a.tags.length&&a.tags[0];if(!a||!a.tags)return null;"b"===a.name?c.fontWeight="bold":"i"===a.name?c.fontStyle="italic":"u"===a.name&&(c.textDecoration="underline");return"b"===a.name||"i"===a.name||"u"===a.name?b(a)||{tag:a.tags[0],parentTag:a}:null}var g,f,e;if(a.tags&&a.tags.length)if(e=a.tags.filter(function(a){return"br"!==a.name}),(f=e[0])&&"trigger"===f.name&&e[1]&&"d"===e[1].name)g=f,f=e[1];else{var d=b(a);f=d&&d.tag||
e[0];a=d&&d.parentTag||a}return{firstTag:f,triggerTag:g,parentTag:a,hasMultipleTags:e&&1<e.length}},_parseSpannedCellsDimentions:function(a,c,b,g,f){if(a.spannedWidths||a.spannedHeights){var m=a.spannedWidths?a.spannedWidths.split(";").map(function(a){return e.ptToPx(a)}):[e.ptToPx(a.width)];a=a.spannedHeights?a.spannedHeights.split(";").map(function(a){return e.ptToPx(a)}):[e.ptToPx(a.height)];for(var d=0;d<m.length;d++)for(var l=0;l<a.length;l++){var k=b[f+d],h=c[g+l],k=h.style.fields[k.field]=
h.style.fields[k.field]||{};k.width=m[d];k.height=a[l]}}},_parseCellContent:function(a,c,b,g,f){function k(a){r.isRichText(a)?c.fieldInfos[b]=B.createFieldInfoFromRichText(a):c[b]=r.unrichHTML(a)}var d=p._processTdContent(a,g);a=d.firstTag;var l=d.parentTag,q=d.triggerTag,d=d.hasMultipleTags,h;if(d&&!q){var t=f.parsers.getParser("field").parseRichTextTag(l,f);t&&(c.fieldInfos[b]=t,h=!0)}if(a&&!h){f.isGraphicReport&&"section"===a.name&&!a.attributes.style&&g.backgroundColor&&!E.isTransparent(g.backgroundColor)&&
(a.attributes.style=e.composeStyleString({backgroundColor:g.backgroundColor}),delete g.backgroundColor);var n;try{n=f.parsers.getParser("field").parseField(a,l,q,f)}catch(u){console.log(u),n=A.createFieldInfoForUnsupportedContent()}if(!1===n)h=!0;else if("number"===typeof n)c[b]=n+"",h=!0;else if(n)c.fieldInfos[b]=n,h=!0;else if("chart"===a.name)h=!0;else if("img"===a.name)h=!0;else if("mapImage"===a.name)h=!0;else if("text"===a.name)c[b]=a.attributes.name,h=!0;else if("a"===a.name&&a.tags&&a.tags[0].text){if(g=
a.attributes.href)c.urls=c.urls||{},c.urls[b]=g,c[b]=a.tags[0].text,h=!0}else a.text&&!d&&(k(a.text),h=!0)}h||k(r.getInnerHTML(l))},_parseTableBackgroundForeground:function(a,c,b){a.attributes=a.attributes||{};a.attributes.type=b?k.TABLE_BACKGROUND:k.TABLE_FOREGROUND;return c.parsers.getParser("section").parseSection(a,c)},_parseFloatingPanels:function(a,c,b){a.attributes=a.attributes||{};a.attributes.type=b?k.TABLE_BACKGROUND_FLOATING_PANELS:k.TABLE_FOREGROUND_FLOATING_PANELS;return c.parsers.getParser("section").parseSection(a,
c)}};p.parseTableCellAttributes=w.parseTableCellAttributes;return p});