// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/_SerializationSupport","require dojo/_base/declare dojo/_base/lang esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when esri/dijit/geoenrichment/promise/all ./supportClasses/areas/AnalysisAreaJsonUtil ./supportClasses/areas/AnalysisAreaUtil ../core/infographics/InfographicTypes ../core/supportClasses/templateJsonUtils/query/TemplateJsonQueryUtil esri/dijit/geoenrichment/ReportPlayer/countryConfig".split(" "),function(C,D,h,k,g,
l,f,E,n,F,t){function u(){var a=new k;C("./supportClasses/attachments/AttachmentsStoreSerializer ./supportClasses/GEUtil ../core/supportClasses/templateJsonUtils/TemplateJsonSerializer ../core/supportClasses/templateJsonUtils/TemplateJsonAnalyzer ../core/infographics/simpleInfographic/dataDrilling/EnrichUtil ../core/infographics/utils/InfographicJsonUtil ../core/conversion/portalToEditorUtils/variables/PlayerVariableProvider ../core/infographics/InfographicTypes ../core/infographics/simpleInfographic/dataDrilling/DataDrillingLibrary ./commands/mapToImage/MapToURLUtil esri/dijit/geoenrichment/utils/ProjectionUtil".split(" "),
function(c,b,e,d,m,G,f,g,h,k,l){p=c;v=b;q=e;w=d;x=m;r=G;y=f;n=g;z=h;A=k;B=l;a.resolve()});return a.promise}var p,v,q,w,x,r,y,z,A,B;return D(null,{reportDataToJson:function(a,c){var b=this;c=c||{};var e=!1;F.processTemplateFieldInfos(a.templateJson,function(a){a.isInfographic&&a.infographicJson.type===n.ATTACHMENTS&&(e=!0)});return u().then(function(){return g(c.loadDataDrillingData&&b._serializeDataDrilling(a),function(){return g(a.attachmentsStore&&p.getAttachmentsStoreJson(a.attachmentsStore,{numAreas:a.analysisAreas.length,
saveImages:e}),function(d){var m=h.mixin({},a.config);!1!==c.forceFixedDataMode&&delete m.geoenrichmentUrl;d={isClassic:a.isClassic,isMultiFeature:a.isMultiFeature,reportType:a.reportType,reportTitle:a.reportTitle,templateJson:q.serialize(a.templateJson),reportObject:b._prepareReportObjectJson(a.reportObject),fieldData:a.fieldData,analysisAreas:f.areasToJson(a.analysisAreas),combinedAreasInfo:a.combinedAreasInfo&&f.combinedAreasInfoToJson(a.combinedAreasInfo),reverseAnalysisAreasOnMap:a.reverseAnalysisAreasOnMap,
infographicOptions:a.infographicOptions&&a.infographicOptions.toJson(),attachmentsStore:d,templateVariableProvider:a.templateVariableProvider&&a.templateVariableProvider.toJson(),config:m,countryConfig:t.toJson(),mapImageInfos:c.mapImageInfos,customLogo:a.customLogo};console.log("_SerializationSupport.js \x3d\x3e reportDataJson");console.log(d);return d})})})},_prepareReportObjectJson:function(a){var c={},b;for(b in a)a[b]&&"object"!==typeof a[b]&&(c[b]=a[b]);return c},_serializeDataDrilling:function(a){var c=
x.getEnrichInfosForTemplateJson(a.infographicOptions.countryID,a.templateJson),b=[];b.push(this.enrichFieldData(c,h.mixin({analysisAreas:a.analysisAreas,fieldData:a.fieldData},a.config)));b.push(this._enrichInfographicVariables(a,c));var e={};c&&c.forEach(function(a){a.isChart||a.isGeneral?a.fields.forEach(function(a){a.mapTo&&(e[a.mapTo]=1)}):a.isInfographic&&(a.fieldInfos?a.fieldInfos.forEach(function(a){a.hasVariable&&a.fullName&&(e[a.fullName]=1)}):a.variables&&a.variables.forEach(function(a){e[a]=
1}))});var c=w.collectVariablesStats(a.templateJson),d;for(d in c)e[d]=1;(d=z.getSubstitutionVariables(a.config.countryID))&&d.forEach(function(a){e[a]=1});b.push(a.templateVariableProvider.tryFetchDataVintageInfo(a.config,e));return l(b)},_enrichInfographicVariables:function(a,c){var b=a.infographicOptions;return g(b.getOptions().getItems(b.countryID),function(){var e=[];c.forEach(function(c){c.isInfographic&&c.variables&&a.analysisAreas.forEach(function(a,d){b.setCurrentAnalysisAreaIndex(d);var f=
new k;a=b.createGeoenrichment({currentFeatureIndex:d});a.onDone=function(){f.resolve()};a.country=b.countryID;d=n.supportsComparison(c.type);a.setGeoLevels(d?r.getSubLevels(c):null,d?r.getHighestLevel(c):null);a.setVariables(c.variables);a.setStudyArea(b.studyArea);e.push(f.promise)})});return l(e)})},reportDataFromJson:function(a){var c=this;return u().then(function(){var b=a.fieldData;b.featureData&&(b.areaData=b.featureData.map(function(a){return{mainCalculator:{data:a}}}),delete b.featureData);
b={isClassic:a.isClassic,isMultiFeature:a.isMultiFeature,reportType:a.reportType,reportTitle:a.reportTitle,templateJson:q.deserialize(a.templateJson),reportObject:a.reportObject,fieldData:b,analysisAreas:f.areasFromJson(a.analysisAreas),combinedAreasInfo:a.combinedAreasInfo&&f.combinedAreasInfoFromJson(a.combinedAreasInfo)||{},reverseAnalysisAreasOnMap:a.reverseAnalysisAreasOnMap,infographicOptions:a.infographicOptions&&c._infographicOptionsProvider.getInfographicOptionsFromJson(a.infographicOptions),
attachmentsStore:a.attachmentsStore&&p.getAttachmentsStoreFromJson(a.attachmentsStore),templateVariableProvider:a.templateVariableProvider&&new y(a.templateVariableProvider),config:a.config||{},mapImageInfos:a.mapImageInfos,customLogo:a.customLogo};E.populateCombinedAreasInfo(b.combinedAreasInfo,b.analysisAreas);v.setGeoenrichmentUrl(b.config.geoenrichmentUrl);b.config.geometryServiceUrl&&B.setGeometryServiceUrl(b.config.geometryServiceUrl);b.config.printMapTaskUrl&&A.setPrintMapTaskUrl(b.config.printMapTaskUrl);
t.fromJson(a.countryConfig);return b})}})});