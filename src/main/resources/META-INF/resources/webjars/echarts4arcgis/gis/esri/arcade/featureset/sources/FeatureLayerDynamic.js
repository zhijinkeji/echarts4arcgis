// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
var __extends=this&&this.__extends||function(){var z=function(t,m){z=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(m,v){m.__proto__=v}||function(m,v){for(var t in v)v.hasOwnProperty(t)&&(m[t]=v[t])};return z(t,m)};return function(t,m){function A(){this.constructor=t}z(t,m);t.prototype=null===m?Object.create(m):(A.prototype=m.prototype,new A)}}(),__assign=this&&this.__assign||function(){__assign=Object.assign||function(z){for(var t,m=1,A=arguments.length;m<A;m++){t=arguments[m];for(var v in t)Object.prototype.hasOwnProperty.call(t,
v)&&(z[v]=t[v])}return z};return __assign.apply(this,arguments)};
define("esri/arcade/featureset/sources/FeatureLayerDynamic","require exports dojox/encoding/digests/_base dojox/encoding/digests/MD5 ../../../graphic ../../../request ../../../sniff ../../../SpatialReference ../../../urlUtils ../../Attachment ../support/cache ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../support/stats ../../polyfill/promiseUtils ../../../geometry/Extent ../../../geometry/jsonUtils ../../../layers/FeatureType ../../../layers/Field ../../../tasks/query ../../../tasks/QueryTask ../../../tasks/StatisticDefinition".split(" "),function(z,
t,m,A,v,F,I,K,L,M,C,N,D,y,w,O,n,P,Q,R,G,x,H,J){var S=!!I("esri-pbf"),T=!!I("esri-featurelayer-pbf"),V=function(){function m(c,a,b){void 0===b&&(b=null);this.url=c;this.outFields=a;this.spatialReference=b;this._url=null;this.supportsQuantizationEditMode=this.supportsFormatPBF=!1;this.metadata=null;this.supportsAttachments=!1;this.relationships=[];this._queryTask=this._loadPromise=null;this.currentVersion=0;this.useStandardizedQueries=!1;this.fields=[];this._url=L.urlToObject(c)}m.prototype._canFetchPBFForQuery=
function(c){return S&&T&&this.supportsFormatPBF&&!c.outStatistics&&this.supportsQuantizationEditMode};m.prototype._loadMetaData=function(c){if(null!==C.applicationCache){var a=C.applicationCache.getLayerInfo(c);if(null!==a)return a}a=n.create(function(a,h){F({url:c,content:{f:"json"},callbackParamName:"callback",load:function(b){a(b)},error:function(a){h(a)}})});null!==C.applicationCache&&(C.applicationCache.setLayerInfo(c,a),a=a.catch(function(a){C.applicationCache.clearLayerInfo(c);throw a;}));
return a};m.prototype.load=function(){var c=this;null===this._loadPromise&&(this._loadPromise=n.create(function(a,b){var h=c._url.path;c._loadMetaData(h).then(function(d){try{c.metadata=d;c.relationships=d.relationships;c._queryTask=new H(h);c.objectIdField=d.objectIdField;c.supportsAttachments=!0===d.hasAttachments;if(!c.objectIdField)for(var k=d.fields,e=0;e<k.length;e++){var l=k[e];if("esriFieldTypeOID"===l.type){c.objectIdField=l.name;break}}c.globalIdField=d.globalIdField;c.geometryType=d.geometryType;
c.typeIdField=d.typeIdField;c.fullExtent=new P(d.fullExtent);c.advancedQueryCapabilities=d.advancedQueryCapabilities||{supportsStatistics:d.supportsStatistics,supportsOrderBy:d.supportsAdvancedQueries,supportsDistinct:d.supportsAdvancedQueries};if(d.supportedQueryFormats)for(var k=0,f=d.supportedQueryFormats.split(",");k<f.length;k++)if("pbf"===f[k].replace(/^\s+|\s+$/gm,"").toLowerCase()){c.supportsFormatPBF=!0;break}!0===d.supportsQuantizationEditMode&&(c.supportsQuantizationEditMode=!0);!0===d.useStandardizedQueries&&
(c.useStandardizedQueries=!0);void 0!==d.currentVersion&&(c.currentVersion=d.currentVersion);if(d.types){c.types=[];for(var f=0,r=d.types;f<r.length;f++){var g=r[f],E=new R(g);c.types.push(E)}}d.spatialReference&&!c.spatialReference&&(c.spatialReference=new K(d.spatialReference));if(1===c.outFields.length&&"*"===c.outFields[0])for(var q=0,p=d.fields;q<p.length;q++){var g=p[q],u=new G(g);c.fields.push(u)}else for(p=0,q=d.fields;p<q.length;p++)if(g=q[p],"esriFieldTypeOID"===g.type)u=new G(g),c.fields.push(u);
else{d=!1;for(var r=0,B=c.outFields;r<B.length;r++){var m=B[r];if(g.name.toUpperCase()===m.toUpperCase()){d=!0;break}}d&&(u=new G(g),c.fields.push(u))}c.definitionExpression="";a(c)}catch(U){b(U)}},b)}));return this._loadPromise};m.prototype.queryIds=function(c){var a=this;return n.create(function(b,h){a._queryTask.executeForIds(c,b,h)})};m.prototype.queryAttachments=function(c){var a=this,b=__assign({},c,{f:"json"});0<b.objectIds.length&&(b.objectIds=b.objectIds.join(","));b.size&&(b.size=b.size.join(","));
b.attachmentTypes&&(b.attachmentTypes=b.attachmentTypes.join(","));return n.create(function(c,d){F({url:a._url.path+"/queryAttachments",content:b,callbackParamName:"callback",load:function(a){var b={};if(a&&a.attachmentGroups){var d=0;for(a=a.attachmentGroups;d<a.length;d++){var f=a[d];void 0===b[f.parentObjectId]&&(b[f.parentObjectId]=[]);for(var h=0,g=f.attachmentInfos;h<g.length;h++){var k=g[h];b[f.parentObjectId].push({id:k.id,globalId:k.globalId,name:k.name,contentType:k.contentType,size:k.size})}}}c(b)},
error:function(a){d(a)}})})};return m}();return function(t){function c(a){var b=t.call(this,a)||this;b._layer=null;b._removeGeometry=!1;b.formulaCredential=null;b._pageJustIds=!1;b._requestStandardised=!1;a.spatialReference&&(b.spatialReference=a.spatialReference);b._layer=new V(a.url,a.outFields,b.spatialReference);b._transparent=!0;b._maxProcessing=1E3;b._wset=null;void 0!==a.includeGeometry&&(b._removeGeometry=!1===a.includeGeometry);return b}__extends(c,t);c.prototype.optimisePagingFeatureQueries=
function(a){this._pageJustIds=a};c.prototype._maxQueryRate=function(){return y.defaultMaxRecords};c.prototype.convertQueryToLruCacheKey=function(a){a=y.stableStringify(a.toJson());return A(a,m.outputTypes.String)};c.prototype.load=function(){var a=this;null===this._loadPromise&&(this._loadPromise=n.create(function(b,c){a._layer.load().then(function(){try{a._initialiseFeatureSet(),b(a)}catch(d){c(d)}},function(a){c(a)})}));return this._loadPromise};c.prototype._initialiseFeatureSet=function(){null==
this.spatialReference&&(this.spatialReference=this._layer.spatialReference);this.geometryType=this._layer.geometryType;void 0===this.geometryType&&(this.geometryType="");this.fields=this._layer.fields.slice(0);var a=this._layer.currentVersion;!0===this._layer.useStandardizedQueries?(this._databaseType=y.FeatureServiceDatabaseType.StandardisedNoInterval,void 0!==a&&null!==a&&10.7<=a&&(this._databaseType=y.FeatureServiceDatabaseType.Standardised)):void 0!==a&&null!==a&&(10.5<=a&&(this._databaseType=
y.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),10.7<=a&&(this._databaseType=y.FeatureServiceDatabaseType.Standardised));this.objectIdField=this._layer.objectIdField;this.typeIdField=this._layer.typeIdField;this.types=this._layer.types};c.prototype._isInFeatureSet=function(a){return y.IdState.InFeatureSet};c.prototype._refineSetBlock=function(a,b){return n.resolve(a)};c.prototype._candidateIdTransform=function(a){return a};c.prototype._transformSetWithIdChanges=function(a){};
c.prototype._getSet=function(a){var b=this;return null===this._wset?this._ensureLoaded().then(function(){return b._getFilteredSet("",null,null,null,a)}).then(function(a){return b._wset=a}):n.resolve(this._wset)};c.prototype.nativeCapabilities=function(){return{title:this._layer.metadata.name,source:this,canQueryRelated:!0,capabilities:{query:{maxRecordCount:this._layer.maxRecordCount},queryRelated:{supportsOrderBy:this._layer.metadata.advancedQueryCapabilities&&this._layer.metadata.advancedQueryCapabilities.supportsAdvancedQueryRelated,
supportsPagination:this._layer.metadata.advancedQueryCapabilities&&this._layer.metadata.advancedQueryCapabilities.supportsQueryRelatedPagination}},databaseType:this._databaseType,requestStandardised:this._requestStandardised}};c.prototype._runDatabaseProbe=function(a){var b=this;return n.create(function(c,d){try{b._ensureLoaded().then(function(){try{var h=new x;h.where=a.replace("OBJECTID",b._layer.objectIdField);b._layer.queryIds(h).then(function(a){c(!0)},function(a){try{c(!1)}catch(l){d(l)}})}catch(e){d(e)}})}catch(k){d(k)}})};
c.prototype._canUsePagination=function(){return void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsPagination?!0:!1};c.prototype._cacheableFeatureSetSourceKey=function(){return this._layer.url};c.prototype._getFilteredSet=function(a,b,c,d,k){var e=this;return this.databaseType().then(function(l){if(e.isTable()&&b&&null!==a&&""!==a)return new D([],[],!0,null);if(e._canUsePagination())return e._getFilteredSetUsingPaging(a,
b,c,d,k);var f="",h=!1;null!==d&&void 0!==e._layer.advancedQueryCapabilities&&null!==e._layer.advancedQueryCapabilities&&!0===e._layer.advancedQueryCapabilities.supportsOrderBy&&(f=d.constructClause(),h=!0);var g=new x;e._requestStandardised&&(g.sqlFormat="standard");g.where=null===c?null===b?"1\x3d1":"":w.toWhereClause(c,l);g.spatialRelationship=e._makeRelationshipEnum(a);g.outSpatialReference=e.spatialReference;g.orderByFields=""!==f?f.split(","):null;g.geometry=null===b?null:b;g.relationParam=
e._makeRelationshipParam(a);return e.executeQuery(g,"executeForIds").then(function(a){null===a&&(a=[]);e._checkCancelled(k);return new D([],a,h,null)})})};c.prototype._expandPagedSet=function(a,b,c,d,k){return this._expandPagedSetFeatureSet(a,b,c,d,k)};c.prototype._getFilteredSetUsingPaging=function(a,b,c,d,k){var e=this;try{var l="",f=!1;null!==d&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&
(l=d.constructClause(),f=!0);return this.databaseType().then(function(d){d=null===c?null===b?"1\x3d1":"":w.toWhereClause(c,d);e._layer.definitionExpression&&(d=""!==d?"(("+e._layer.definitionExpression+") AND ("+d+"))":e._layer.definitionExpression);var g=e._maxQueryRate();void 0!==e._layer.maxRecordCount&&e._layer.maxRecordCount<g&&(g=e._layer.maxRecordCount);var h=null;if(!0===e._pageJustIds)h=new D([],["GETPAGES"],f,{spatialRel:e._makeRelationshipEnum(a),relationParam:e._makeRelationshipParam(a),
outFields:e._layer.objectIdField,resultRecordCount:g,resultOffset:0,geometry:null===b?"":b,where:d,orderByFields:l,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}});else{var r=!0;!0===e._removeGeometry&&(r=!1);var p=e._fieldsIncludingObjectId(e._layer.outFields),h=new D([],["GETPAGES"],f,{spatialRel:e._makeRelationshipEnum(a),relationParam:e._makeRelationshipParam(a),outFields:p.join(","),resultRecordCount:g,resultOffset:0,geometry:null===b?"":b,where:d,
orderByFields:l,returnGeometry:r,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}})}return e._expandPagedSet(h,g,0,1,k).then(function(a){return h})})}catch(r){return n.reject(r)}};c.prototype._clonePageDefinition=function(a){return null===a?null:!0!==a.groupbypage?{groupbypage:!1,spatialRel:a.spatialRel,relationParam:a.relationParam,outFields:a.outFields,resultRecordCount:a.resultRecordCount,resultOffset:a.resultOffset,geometry:a.geometry,where:a.where,orderByFields:a.orderByFields,
returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,internal:a.internal}:{groupbypage:!0,spatialRel:a.spatialRel,relationParam:a.relationParam,outFields:a.outFields,resultRecordCount:a.resultRecordCount,useOIDpagination:a.useOIDpagination,generatedOid:a.generatedOid,groupByFieldsForStatistics:a.groupByFieldsForStatistics,resultOffset:a.resultOffset,outStatistics:a.outStatistics,geometry:a.geometry,where:a.where,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,
internal:a.internal}};c.prototype._getPhysicalPage=function(a,b,c){var d=this;try{var h=a.pagesDefinition.internal.lastRetrieved,e=new x;this._requestStandardised&&(e.sqlFormat="standard");e.spatialRelationship=a.pagesDefinition.spatialRel;e.relationParam=a.pagesDefinition.relationParam;e.outFields=a.pagesDefinition.outFields.split(",");e.num=a.pagesDefinition.resultRecordCount;e.start=a.pagesDefinition.internal.lastRetrieved;e.geometry=a.pagesDefinition.geometry;e.where=a.pagesDefinition.where;e.orderByFields=
""!==a.pagesDefinition.orderByFields?a.pagesDefinition.orderByFields.split(","):null;e.returnGeometry=a.pagesDefinition.returnGeometry;e.outSpatialReference=this.spatialReference;return this.executeQuery(e,"execute").then(function(b){d._checkCancelled(c);if(a.pagesDefinition.internal.lastRetrieved!==h)return"done";for(var f=0;f<b.features.length;f++)void 0===b.features[f].geometry&&(b.features[f].geometry=null),a.pagesDefinition.internal.set[h+f]=b.features[f].attributes[d._layer.objectIdField];if(!1===
d._pageJustIds)for(f=0;f<b.features.length;f++)d._featureCache[b.features[f].attributes[d._layer.objectIdField]]=b.features[f];b.features.length!==a.pagesDefinition.resultRecordCount&&(a.pagesDefinition.internal.fullyResolved=!0);a.pagesDefinition.internal.lastRetrieved=h+a.pagesDefinition.resultRecordCount;return"done"})}catch(l){return n.reject(l)}};c.prototype._fieldsIncludingObjectId=function(a){if(null===a)return[this.objectIdField];a=a.slice(0);if(-1<a.indexOf("*"))return a;for(var b=!1,c=0;c<
a.length;c++)if(a[c].toUpperCase()===this.objectIdField.toUpperCase()){b=!0;break}!1===b&&a.push(this.objectIdField);return a};c.prototype._getFeatures=function(a,b,c,d){var h=this,e=[];try{-1!==b&&void 0===this._featureCache[b]&&e.push(b);if(!0===this._checkIfNeedToExpandKnownPage(a,this._maxProcessingRate()))return this._expandPagedSet(a,this._maxProcessingRate(),0,0,d).then(function(f){return h._getFeatures(a,b,c,d)});for(var l=0,f=a._lastFetchedIndex;f<a._known.length;f++){a._lastFetchedIndex+=
1;l++;if(void 0===this._featureCache[a._known[f]]){var r=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){var g=this._layer._mode;if(void 0!==g._featureMap[a._known[f]]){var E=g._featureMap[a._known[f]];null!==E&&(r=!0,this._featureCache[a._known[f]]=E)}}if(!1===r&&(a._known[f]!==b&&e.push(a._known[f]),e.length>=this._maxProcessingRate()-1))break}if(l>=c&&0===e.length)break}if(0===e.length)return n.resolve("success");try{var q=new x;this._requestStandardised&&(q.sqlFormat="standard");q.objectIds=
e;q.outFields=this._fieldsIncludingObjectId(this._layer.outFields);q.returnGeometry=!0;!0===this._removeGeometry&&(q.returnGeometry=!1);q.outSpatialReference=this.spatialReference;return this.executeQuery(q,"execute").then(function(a){h._checkCancelled(d);if(void 0!==a.error)return n.reject(Error(a.error));for(var b=0;b<a.features.length;b++)void 0===a.features[b].geometry&&(a.features[b].geometry=null),h._featureCache[a.features[b].attributes[h._layer.objectIdField]]=a.features[b];return"success"})}catch(p){return n.reject(p)}}catch(p){return n.reject(p)}};
c.prototype._layerUrl=function(){return this._layer.url};c.prototype.pbfSupportedForQuery=function(a){return this._layer._canFetchPBFForQuery(a)};c.prototype.executeQuery=function(a,b){var c=new H(this._layerUrl()),d="execute"===b&&this.pbfSupportedForQuery(a);d&&(a.quantizationParameters={mode:"edit"});var k=null;if(this.recentlyUsedQueries){var e=this.convertQueryToLruCacheKey(a);(k=this.recentlyUsedQueries.getFromCache(e))&&k.isRejected()&&(k=null,this.recentlyUsedQueries.removeFromCache(e));null===
k&&(k=!0!==d?c[b](a):c[b](a,null,null,{format:"pbf"}),this.recentlyUsedQueries.addToCache(e,k))}null===k&&(k=!0!==d?c[b](a):c[b](a,null,null,{format:"pbf"}));return k};c.prototype._getDistinctPages=function(a,b,c,d,k,e,l,f,r){var g=this;return this._ensureLoaded().then(function(){for(var h=c.parseTree.column,q=0;q<g._layer.fields.length;q++)if(g._layer.fields[q].name.toLowerCase()===h.toLowerCase()){h=g._layer.fields[q].name;break}return g.databaseType().then(function(p){var u=new x;g._requestStandardised&&
(u.sqlFormat="standard");p=null===e?null===k?"1\x3d1":"":w.toWhereClause(e,p);g._layer.definitionExpression&&(p=""!==p?"(("+g._layer.definitionExpression+") AND ("+p+"))":g._layer.definitionExpression);u.where=p;u.spatialRelationship=g._makeRelationshipEnum(d);u.relationParam=g._makeRelationshipParam(d);u.geometry=null===k?null:k;u.returnDistinctValues=!0;u.returnGeometry=!1;u.outFields=[h];return g.executeQuery(u,"execute").then(function(p){g._checkCancelled(r);if(!p.hasOwnProperty("features"))return n.reject(Error("Unnexected Result querying statistics from layer"));
for(var u=!1,q=0;q<g._layer.fields.length;q++)if(g._layer.fields[q].name===h){"esriFieldTypeDate"===g._layer.fields[q].type&&(u=!0);break}for(q=0;q<p.features.length;q++){if(u){var B=p.features[q].attributes[h];null!==B?f.push(new Date(B)):f.push(B)}else f.push(p.features[q].attributes[h]);if(f.length>=l)break}return 0===p.features.length?f:p.features.length===g._layer.maxRecordCount&&f.length<l?g._getDistinctPages(a+p.features.length,b,c,d,k,e,l,f,r).then(function(a){return{calculated:!0,result:a}}):
f})})})};c.prototype._distinctStat=function(a,b,c,d,k,e,l){return this._getDistinctPages(0,a,b,c,d,k,e,[],l).then(function(a){return{calculated:!0,result:a}})};c.prototype.isTable=function(){return null===this._layer.geometryType||""===this._layer.geometryType||void 0===this._layer.geometryType};c.prototype._countstat=function(a,b,c,d,k){var e=this;return this.databaseType().then(function(a){var f=new x;e._requestStandardised&&(f.sqlFormat="standard");if(e.isTable()&&c&&null!==b&&""!==b)return{calculated:!0,
result:0};a=null===d?null===c?"1\x3d1":"":w.toWhereClause(d,a);e._layer.definitionExpression&&(a=""!==a?"(("+e._layer.definitionExpression+") AND ("+a+"))":e._layer.definitionExpression);f.where=a;f.where=a;f.spatialRelationship=e._makeRelationshipEnum(b);f.relationParam=e._makeRelationshipParam(b);f.geometry=null===c?null:c;f.returnGeometry=!1;return e.executeQuery(f,"executeForCount").then(function(a){return{calculated:!0,result:a}})})};c.prototype._stats=function(a,b,c,d,k,e,l){var f=this;return this._ensureLoaded().then(function(){var h=
f._layer.advancedQueryCapabilities&&!0===f._layer.advancedQueryCapabilities.supportsSqlExpression,g=f._layer.advancedQueryCapabilities&&!0===f._layer.advancedQueryCapabilities.supportsStatistics,m=f._layer.advancedQueryCapabilities&&!0===f._layer.advancedQueryCapabilities.supportsDistinct;return"count"===a?m?f._countstat(a,c,d,k,l):{calculated:!1}:!1===g||!1===w.isSingleField(b)&&!1===h||!1===b.isStandardized?""!==c||null!==k?{calculated:!1}:f._manualStat(a,b,e,l):"distinct"===a?!1===m?""!==c||null!==
k?{calculated:!1}:f._manualStat(a,b,e,l):f._distinctStat(a,b,c,d,k,e,l):f.databaseType().then(function(e){if(f.isTable()&&d&&null!==c&&""!==c)return{calculated:!0,result:null};var g=new x;f._requestStandardised&&(g.sqlFormat="standard");var h=null===k?null===d?"1\x3d1":"":w.toWhereClause(k,e);f._layer.definitionExpression&&(h=""!==h?"(("+f._layer.definitionExpression+") AND ("+h+"))":f._layer.definitionExpression);g.where=h;g.spatialRelationship=f._makeRelationshipEnum(c);g.relationParam=f._makeRelationshipParam(c);
g.geometry=null===d?null:d;h=new J;h.statisticType=O.decodeStatType(a);h.onStatisticField=w.toWhereClause(b,e);var l=h.outStatisticFieldName="ARCADE_STAT_RESULT";g.returnGeometry=!1;g.outStatistics=[h];return f.executeQuery(g,"execute").then(function(a){if(!a.hasOwnProperty("features")||0===a.features.length)return n.reject(Error("Unnexected Result querying statistics from layer"));for(var b=!1,c=0;c<a.fields.length;c++)if("ARCADE_STAT_RESULT"===a.fields[c].name.toUpperCase()){l=a.fields[c].name;
"esriFieldTypeDate"===a.fields[c].type&&(b=!0);break}return b?(b=a.features[0].attributes[l],null!==b&&(b=new Date(a.features[0].attributes[l])),{calculated:!0,result:b}):{calculated:!0,result:a.features[0].attributes[l]}})})})};c.prototype._stat=function(a,b,c,d,k,e,l){return this._stats(a,b,c,d,k,e,l)};c.prototype._canDoAggregates=function(a,c,h,d,k){var b=this;return this._ensureLoaded().then(function(a){a=!1;var f=b._layer.advancedQueryCapabilities&&!0===b._layer.advancedQueryCapabilities.supportsSqlExpression;
void 0!==b._layer.advancedQueryCapabilities&&null!==b._layer.advancedQueryCapabilities&&!0===b._layer.advancedQueryCapabilities.supportsStatistics&&!0===b._layer.advancedQueryCapabilities.supportsOrderBy&&(a=!0);if(a)for(var d=0;d<c.length-1;d++)null!==c[d].workingexpr&&(!1===c[d].workingexpr.isStandardized?a=!1:!1===w.isSingleField(c[d].workingexpr)&&!1===f&&(a=!1));return!1===a?!1:!0})};c.prototype._makeRelationshipEnum=function(a){return 0<=a.indexOf("esriSpatialRelRelation")?"esriSpatialRelRelation":
a};c.prototype._makeRelationshipParam=function(a){return 0<=a.indexOf("esriSpatialRelRelation")?a.split(":")[1]:""};c.prototype._getAggregatePagesDataSourceDefinition=function(a,c,h,d,k,e,l){var b=this;return this._ensureLoaded().then(function(f){return b.databaseType().then(function(f){var g="",q=!1,p=!1;null!==e&&void 0!==b._layer.advancedQueryCapabilities&&null!==b._layer.advancedQueryCapabilities&&!0===b._layer.advancedQueryCapabilities.supportsOrderBy&&(g=e.constructClause(),p=!0);void 0!==b._layer.advancedQueryCapabilities&&
null!==b._layer.advancedQueryCapabilities&&!1===b._layer.advancedQueryCapabilities.supportsPagination&&(p=!1,q=!0,g=b._layer.objectIdField);for(var m=[],r=0;r<c.length;r++){var n=new J;n.onStatisticField=null!==c[r].workingexpr?w.toWhereClause(c[r].workingexpr,f):"";n.outStatisticFieldName=c[r].field;n.statisticType=c[r].toStatisticsName();m.push(n)}""===g&&(g=a.join(","));r=b._maxQueryRate();void 0!==b._layer.maxRecordCount&&b._layer.maxRecordCount<r&&(r=b._layer.maxRecordCount);f=null===k?null===
d?"1\x3d1":"":w.toWhereClause(k,f);b._layer.definitionExpression&&(f=""!==f?"(("+b._layer.definitionExpression+") AND ("+f+"))":b._layer.definitionExpression);return new D([],["GETPAGES"],p,{groupbypage:!0,spatialRel:b._makeRelationshipEnum(h),relationParam:b._makeRelationshipParam(h),outFields:["*"],useOIDpagination:q,generatedOid:l,resultRecordCount:r,resultOffset:0,groupByFieldsForStatistics:a,outStatistics:m,geometry:null===d?null:d,where:f,orderByFields:g,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,
set:[],lastRetrieved:0,fullyResolved:!1}})})})};c.prototype._getAgregagtePhysicalPage=function(a,b,c){var d=this;try{var h=a.pagesDefinition.where;!0===a.pagesDefinition.useOIDpagination&&(h=""!==h?"("+h+") AND ("+a.pagesDefinition.generatedOid+"\x3e"+a.pagesDefinition.internal.lastMaxId.toString()+")":a.pagesDefinition.generatedOid+"\x3e"+a.pagesDefinition.internal.lastMaxId.toString());var e=a.pagesDefinition.internal.lastRetrieved,l=new x;this._requestStandardised&&(l.sqlFormat="standard");l.where=
h;l.spatialRelationship=a.pagesDefinition.spatialRel;l.relationParam=a.pagesDefinition.relationParam;l.outFields=a.pagesDefinition.outFields;l.outStatistics=a.pagesDefinition.outStatistics;l.geometry=a.pagesDefinition.geometry;l.groupByFieldsForStatistics=a.pagesDefinition.groupByFieldsForStatistics;l.num=a.pagesDefinition.resultRecordCount;l.start=a.pagesDefinition.internal.lastRetrieved;l.returnGeometry=a.pagesDefinition.returnGeometry;l.orderByFields=""!==a.pagesDefinition.orderByFields?a.pagesDefinition.orderByFields.split(","):
null;return this.isTable()&&l.geometry&&l.spatialRelationship?n.resolve([]):this.executeQuery(l,"execute").then(function(b){d._checkCancelled(c);if(!b.hasOwnProperty("features"))return n.reject(Error("Unnexected Result querying aggregates from layer"));var f=[];if(a.pagesDefinition.internal.lastRetrieved!==e)return n.resolve([]);for(var g=0;g<b.features.length;g++)void 0===b.features[g].geometry&&(b.features[g].geometry=null),a.pagesDefinition.internal.set[e+g]=b.features[g].attributes[a.pagesDefinition.generatedOid];
for(g=0;g<b.features.length;g++)f.push(new v({attributes:b.features[g].attributes,geometry:null}));!0===a.pagesDefinition.useOIDpagination?0===b.features.length?a.pagesDefinition.internal.fullyResolved=!0:a.pagesDefinition.internal.lastMaxId=b.features[b.features.length-1].attributes[a.pagesDefinition.generatedOid]:b.features.length!==a.pagesDefinition.resultRecordCount&&(a.pagesDefinition.internal.fullyResolved=!0);a.pagesDefinition.internal.lastRetrieved=e+a.pagesDefinition.resultRecordCount;return f})}catch(f){return n.reject(f)}};
c.create=function(a,b,h){return new c({url:a,outFields:null===b?["*"]:b,spatialReference:h})};c.prototype.queryAttachments=function(a,b,c,d){var h=this;if(this._layer.supportsAttachments){var e={objectIds:[a]};if(b&&0<b||c&&0<c)e.size=[b&&0<b?b:0,c&&0<c?c:b+1];d&&0<d.length&&(e.attachmentTypes=d);return this._layer.queryAttachments(e).then(function(b){var c=[];if(b&&b[a]){var d=h._layer._url.path;b[a].forEach(function(b){c.push(new M(b.id,b.name,b.contentType,b.size,d+"/"+a.toString()+"/attachments/"+
b.id.toString()))})}return c})}return n.resolve([])};c.prototype.serviceUrl=function(){return y.extractServiceUrl(this._layer._url.path)};c.prototype.relationshipMetaData=function(){return this._layer.relationships};c.prototype.queryRelatedFeatures=function(a){var b=this,c={f:"json",relationshipId:a.relationshipId.toString(),definitionExpression:a.definitionExpression,outFields:a.outFields.join(","),returnGeometry:a.returnGeometry.toString()};void 0!==a.resultOffset&&null!==a.resultOffset&&(c.resultOffset=
a.resultOffset.toString());void 0!==a.resultRecordCount&&null!==a.resultRecordCount&&(c.resultRecordCount=a.resultRecordCount.toString());a.orderByFields&&(c.orderByFields=a.orderByFields.join(","));0<a.objectIds.length&&(c.objectIds=a.objectIds.join(","));a.outSpatialReference&&(c.outSR=JSON.stringify(a.outSpatialReference.toJson()));return n.create(function(a,h){F({url:b._layer._url.path+"/queryRelatedRecords",content:c,callbackParamName:"callback",load:function(b){var c={};if(b&&b.relatedRecordGroups)for(var d=
b.spatialReference,e=0,g=b.relatedRecordGroups;e<g.length;e++){for(var h=g[e],k=h.objectId,p=[],m=0,h=h.relatedRecords;m<h.length;m++){var n=h[m];n.geometry&&(n.geometry.spatialReference=d);n=new v({geometry:n.geometry?Q.fromJson(n.geometry):null,attributes:n.attributes});p.push(n)}c[k]={features:p,exceededTransferLimit:!0===b.exceededTransferLimit}}a(c)},error:function(a){h(a)}})})};c.prototype.getFeatureByObjectId=function(a,b){var c=new H(this._layer._url.path),d=new x;d.outFields=b;d.returnGeometry=
!1;d.outSpatialReference=this.spatialReference;d.where=this.objectIdField+"\x3d"+a.toString();return c.execute(d).then(function(a){return 1===a.features.length?a.features[0]:null})};return c}(N)});