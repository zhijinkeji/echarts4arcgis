// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
var __extends=this&&this.__extends||function(){var x=function(h,l){x=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(h,l){h.__proto__=l}||function(h,l){for(var p in l)l.hasOwnProperty(p)&&(h[p]=l[p])};return x(h,l)};return function(h,l){function p(){this.constructor=h}x(h,l);h.prototype=null===l?Object.create(l):(p.prototype=l.prototype,new p)}}();
define("esri/arcade/featureSetUtils","require exports ../request ./featureSetCollection ./featureset/sources/FeatureLayerDynamic ./featureset/sources/FeatureLayerDynamicMap ./featureset/sources/FeatureLayerMemoryMap ./featureset/sources/FeatureSetRelated ./featureset/support/cache ./featureset/support/shared ./polyfill/promiseUtils ../arcgis/Portal ../layers/FeatureLayer ./featureset/actions/GroupBy".split(" "),function(x,h,l,p,C,D,E,F,k,A,q,G,t){function B(c){if(null!==k.applicationCache){var b=
k.applicationCache.getLayerInfo(c);if(null!==b)return b}b=l({url:c,content:{f:"json"},callbackParamName:"callback",handleAs:"json"}).then(function(d){return d?(d.layers||(d.layers=[]),d.tables||(d.tables=[]),q.resolve(d)):q.resolve({layers:[],tables:[]})});null!==k.applicationCache&&(k.applicationCache.setLayerInfo(c,b),b=b.catch(function(d){k.applicationCache.clearLayerInfo(c);throw d;}));return b}function H(c){if(null!==k.applicationCache){var b=k.applicationCache.getLayerInfo(c);if(null!==b)return b}b=
l({url:c,content:{f:"json"},callbackParamName:"callback",handleAs:"json"}).then(function(d){return d?q.resolve(d):q.resolve(null)});null!==k.applicationCache&&(k.applicationCache.setLayerInfo(c,b),b=b.catch(function(d){k.applicationCache.clearLayerInfo(c);throw d;}));return b}function I(c,b){var d="QUERYDATAELEMTS:"+b.toString()+":"+c;if(null!==k.applicationCache){var e=k.applicationCache.getLayerInfo(d);if(null!==e)return e}c=l({url:c+"/queryDataElements",usePost:!0,handleAs:"json",content:{layers:JSON.stringify([b.toString()]),
f:"json"}}).then(function(a){if(a&&a.layerDataElements&&a.layerDataElements[0])return a.layerDataElements[0];throw Error("Not Found");});null!==k.applicationCache&&(k.applicationCache.setLayerInfo(d,c),c=c.catch(function(a){k.applicationCache.clearLayerInfo(d);throw a;}));return c}function u(c,b,d,e,a){void 0===d&&(d=null);void 0===e&&(e=!0);void 0===a&&(a=null);null===d&&(d=["*"]);return new C({url:c,outFields:d,spatialReference:b,includeGeometry:e,lrucache:a})}function v(c,b,d,e,a){void 0===d&&
(d=null);void 0===e&&(e=!0);void 0===a&&(a=null);return q.resolve(u(c,b,d,e,a))}function y(c,b,d,e,a){void 0===b&&(b=null);void 0===d&&(d=null);void 0===e&&(e=!0);void 0===a&&(a=null);if(!c.getMap()){if(c.url)return u(c.url,b,d,e,a);throw Error("FeatureSets can only be used once the layer is added to a Map");}if(c.mode===t.MODE_SNAPSHOT&&!c.url)return new E({layer:c,spatialReference:b,outFields:d,includeGeometry:e});if(c.mode===t.MODE_SNAPSHOT||c.mode===t.MODE_ONDEMAND||c.mode===t.MODE_AUTO)return new D({layer:c,
spatialReference:b,outFields:d,includeGeometry:e,lrucache:a});throw Error("FeatureSets only support for Snapshot or OnDemand FeatureSet");}function J(c,b){var d=b.portalUrl+(b.portalUrl.match(/\/$/)?"":"/")+"content/items/"+c;return q.create(function(e,a){return l({url:d,content:{f:"json"},callbackParamName:"callback",load:function(a){e({item:a})},error:function(d){a(d)}})})}Object.defineProperty(h,"__esModule",{value:!0});h.initialiseMetaDataCache=function(){null===k.applicationCache&&(k.applicationCache=
new k)};h.constructFeatureSetFromUrlRaw=u;h.constructFeatureSetFromUrl=v;h.constructFeatureSet=y;var K=function(c){function b(d,e,a){void 0===e&&(e=null);void 0===a&&(a=null);var b=c.call(this)||this;b._map=d;b._overridespref=e;b.lrucache=a;b._instantLayers=[];return b}__extends(b,c);b.prototype.makeAndAddFeatureSet=function(d,e,a){void 0===e&&(e=!0);void 0===a&&(a=null);var b=y(d,this._overridespref,null===a?["*"]:a,e,this.lrucache);this._instantLayers.push({featureset:b,opitem:d,includeGeometry:e,
outFields:JSON.stringify(a)});return b};b.prototype.makeAndAddFeatureSetTable=function(d,e,a){void 0===e&&(e=!0);void 0===a&&(a=null);var b=u(d.url,this._overridespref,a,e,this.lrucache);this._instantLayers.push({featureset:b,opitem:{name:d.title,id:d.id},includeGeometry:e,outFields:JSON.stringify(a)});return b};b.prototype.featureSetByName=function(d,e,a){void 0===e&&(e=!0);void 0===a&&(a=null);null===a&&(a=["*"]);a=a.slice(0);a=a.sort();for(var b=JSON.stringify(a),c=0;c<this._instantLayers.length;c++){var f=
this._instantLayers[c];if(f.opitem.name===d&&f.includeGeometry===e&&f.outFields===b)return this.resolvePromise(this._instantLayers[c].featureset)}b=null;c=0;for(f=this._map.graphicsLayerIds;c<f.length;c++){var g=this._map.getLayer(f[c]);if(g instanceof t&&g.name===d){b=g;break}}return b?this.resolvePromise(this.makeAndAddFeatureSet(b,e,a)):this._map.tables&&(b=this._map.tables.find(function(a){return a.title&&a.title===d||a.title&&a.title===d?!0:!1}))?this.resolvePromise(this.makeAndAddFeatureSetTable(b,
e,a)):this.resolvePromise(null)};b.prototype.featureSetById=function(d,b,a){void 0===b&&(b=!0);void 0===a&&(a=["*"]);null===a&&(a=["*"]);a=a.slice(0);a=a.sort();for(var e=JSON.stringify(a),c=0;c<this._instantLayers.length;c++){var f=this._instantLayers[c];if(f.opitem.id===d&&f.includeGeometry===b&&f.outFields===e)return this.resolvePromise(this._instantLayers[c].featureset)}e=null;c=0;for(f=this._map.graphicsLayerIds;c<f.length;c++){var g=this._map.getLayer(f[c]);if(g instanceof t&&g.id===d){e=g;
break}}return e?this.resolvePromise(this.makeAndAddFeatureSet(e,b,a)):this._map.tables&&(e=this._map.tables.find(function(a){return a.id&&a.id===d||a.id&&a.id===d?!0:!1}))?this.resolvePromise(this.makeAndAddFeatureSetTable(e,b,a)):this.resolvePromise(null)};return b}(p);h.createFeatureSetCollectionFromMap=function(c,b,d){void 0===d&&(d=null);return new K(c,b,d)};var L=function(c){function b(d,b,a){void 0===b&&(b=null);void 0===a&&(a=null);var e=c.call(this)||this;e._url=d;e._overridespref=b;e.lrucache=
a;e.metadata=null;e._instantLayers=[];return e}__extends(b,c);Object.defineProperty(b.prototype,"url",{get:function(){return this._url},enumerable:!0,configurable:!0});b.prototype._loadMetaData=function(){var b=this;return B(this._url).then(function(d){return b.metadata=d})};b.prototype.makeAndAddFeatureSet=function(b,e,a){void 0===e&&(e=!0);void 0===a&&(a=null);var d=y(b,this._overridespref,null===a?["*"]:a,e,this.lrucache);this._instantLayers.push({featureset:d,opitem:b,includeGeometry:e,outFields:JSON.stringify(a)});
return d};b.prototype.load=function(){return this._loadMetaData()};b.prototype.clone=function(){return new b(this._url,this._overridespref,this.lrucache)};b.prototype.featureSetByName=function(b,e,a){var d=this;void 0===e&&(e=!0);void 0===a&&(a=null);null===a&&(a=["*"]);a=a.slice(0);a=a.sort();for(var c=JSON.stringify(a),f=0;f<this._instantLayers.length;f++){var g=this._instantLayers[f];if(g.opitem.name===b&&g.includeGeometry===e&&g.outFields===c)return this.resolvePromise(this._instantLayers[f].featureset)}return this._loadMetaData().then(function(c){for(var f=
null,r=0,g=c.layers?c.layers:[];r<g.length;r++){var n=g[r];n.name===b&&(f=n)}if(!f)for(r=0,c=c.tables?c.tables:[];r<c.length;r++)n=c[r],n.name===b&&(f=n);return f?d.resolvePromise(u(d._url+"/"+f.id,d._overridespref,a,e,d.lrucache)):d.resolvePromise(null)})};b.prototype.featureSetById=function(b,c,a){var d=this;void 0===c&&(c=!0);void 0===a&&(a=["*"]);null===a&&(a=["*"]);a=a.slice(0);a=a.sort();var e=JSON.stringify(a);b=null!==b&&void 0!==b?b.toString():"";for(var f=0;f<this._instantLayers.length;f++){var g=
this._instantLayers[f];if(g.opitem.id===b&&g.includeGeometry===c&&g.outFields===e)return this.resolvePromise(this._instantLayers[f].featureset)}return this._loadMetaData().then(function(e){for(var f=null,g=0,k=e.layers?e.layers:[];g<k.length;g++){var n=k[g];null!==n.id&&void 0!==n.id&&n.id.toString()===b&&(f=n)}if(!f)for(g=0,e=e.tables?e.tables:[];g<e.length;g++)n=e[g],null!==n.id&&void 0!==n.id&&n.id.toString()===b&&(f=n);return f?d.resolvePromise(u(d._url+"/"+f.id,d._overridespref,a,c,d.lrucache)):
d.resolvePromise(null)})};return b}(p);h.createFeatureSetCollectionFromService=function(c,b,d){void 0===d&&(d=null);return new L(c,b,d)};h.getPortal=function(c,b){return null===c?b:new G.Portal(c.field("url"))};h.constructFeatureSetFromPortalItem=function(c,b,d,e,a,h,l){return q.create(function(f,g){if(k.applicationCache){var w=k.applicationCache.getLayerInfo(c+":"+h.url);if(w){w.then(function(c){try{var k=v(A.extractServiceUrl(c.item.url)+"/"+b,d,e,a,l);f(k)}catch(z){g(z)}},function(a){g(a)});return}}w=
J(c,h);k.applicationCache&&k.applicationCache.setLayerInfo(c+":"+h.url,w);w.then(function(c){try{var k=v(A.extractServiceUrl(c.item.url)+"/"+b,d,e,a,l);f(k)}catch(z){g(z)}},function(a){k.applicationCache&&k.applicationCache.clearLayerInfo(c+":"+h.url);g(a)})})};h.constructFeatureSetFromRelationship=function(c,b,d,e,a,k,h){void 0===e&&(e=null);void 0===a&&(a=null);void 0===k&&(k=!0);void 0===h&&(h=null);var f=c.serviceUrl();if(!f)return null;f="/"===f.charAt(f.length-1)?f+b.relatedTableId.toString():
f+"/"+b.relatedTableId.toString();return v(f,e,a,k,h).then(function(f){return new F({layer:c,relatedLayer:f,relationship:b,objectId:d,spatialReference:e,outFields:a,includeGeometry:k,lrucache:h})})};h.constructAssociationMetaDataFeatureSetFromUrl=function(c,b){var d=[],e=null,a={},k=null;return B(c).then(function(h){if(h.controllerDatasetLayers&&void 0!==h.controllerDatasetLayers.utilityNetworkLayerId&&null!==h.controllerDatasetLayers.utilityNetworkLayerId){if(h.layers)for(var f=0,g=h.layers;f<g.length;f++){var l=
g[f];a[l.id]=l.name}if(h.tables)for(f=0,g=h.tables;f<g.length;f++)l=g[f],a[l.id]=l.name;var p=h.controllerDatasetLayers.utilityNetworkLayerId;return I(c,p).then(function(f){if(f){e=f;k={};e.dataElement.domainNetworks||(e.dataElement.domainNetworks=[]);f=0;for(var h=e.dataElement.domainNetworks;f<h.length;f++){for(var g=h[f],l=0,q=g.edgeSources?g.edgeSources:[];l<q.length;l++){var m=q[l],m={layerId:m.layerId,sourceId:m.sourceId,className:a[m.layerId]?a[m.layerId]:null};m.className&&(k[m.className]=
m)}l=0;for(g=g.junctionSources?g.junctionSources:[];l<g.length;l++)m=g[l],m={layerId:m.layerId,sourceId:m.sourceId,className:a[m.layerId]?a[m.layerId]:null},m.className&&(k[m.className]=m)}if(e.dataElement.terminalConfigurations)for(f=0,h=e.dataElement.terminalConfigurations;f<h.length;f++)for(g=0,m=h[f].terminals;g<m.length;g++)l=m[g],d.push({terminalId:l.terminalId,terminalName:l.terminalName});return H(c+"/"+p).then(function(a){return a.systemLayers&&void 0!==a.systemLayers.associationsTableId&&
null!==a.systemLayers.associationsTableId?v(c+"/"+a.systemLayers.associationsTableId.toString(),b,"OBJECTID FROMNETWORKSOURCEID TONETWORKSOURCEID FROMGLOBALID TOGLOBALID TOTERMINALID FROMTERMINALID ASSOCIATIONTYPE ISCONTENTVISIBLE GLOBALID".split(" "),!1,null).then(function(a){return a.load()}).then(function(a){return{lkp:k,associations:a,terminals:d}}):{associations:null,lkp:null,terminals:[]}})}return{associations:null,lkp:null,terminals:[]}})}return{associations:null,lkp:null,terminals:[]}})}});