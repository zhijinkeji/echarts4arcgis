// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/map/_LiveMapSupport","dojo/_base/declare dojo/aspect dojo/string esri/dijit/geoenrichment/when dojo/dom-construct dojo/query esri/geometry/Extent ../supportClasses/map/legend/LegendController ../supportClasses/templateJsonUtils/query/TemplateJsonQueryUtil ../reportContainerGrid/utils/PageQueryUtil esri/dijit/geoenrichment/utils/DomUtil esri/dijit/geoenrichment/utils/InvokeUtil esri/dijit/geoenrichment/utils/WaitingUtil esri/dijit/geoenrichment/ReportPlayer/PlayerViewModes esri/dijit/geoenrichment/ReportPlayer/config dojo/i18n!esri/nls/jsapi".split(" "),
function(r,t,u,l,m,n,v,w,x,y,z,A,p,q,h,k){k=k.geoenrichment.dijit.ReportPlayer.ReportPlayer;return r(null,{_isPlacingMapFlag:!1,_placeMapPromise:null,_currentMap:null,_locatorPointsControllers:null,_stdPolygonsControllers:null,_legendController:null,_limitedPlacingInfo:null,postCreate:function(){var b=this;if(this.viewModel.dynamicReportInfo){var a=y.getParentReportPlayer(this),c=-1,d=0,f=x.calcNumberOfMaps(this.viewModel.dynamicReportInfo.templateJson,function(a){b.mapJson.calculatorFieldName===
a.calculatorFieldName&&(c=d);d++}),g=this.viewModel.dynamicReportInfo.analysisAreas.filter(function(a){return!a.hidden}).length;(a.viewMode===q.FULL_PAGES||a.viewMode===q.PANELS_IN_STACK)&&g*f>h.maps.maxNumberOfMapsShownAtTheSameTime&&(this._limitedPlacingInfo={numMapsPerArea:f,numVisibleAreas:g,currentIndex:c})}this.inherited(arguments)},getCurrentMap:function(){return this._currentMap},getRenderPromise:function(){return this._placeMapPromise},_placeMap:function(){if(this._limitedPlacingInfo){var b=
0;this.viewModel.dynamicReportInfo.analysisAreas.some(function(a,c){if(this.currentFeatureIndex===c)return!0;!a.hidden&&b++},this);if(1===this._limitedPlacingInfo.numVisibleAreas){if(this._limitedPlacingInfo.currentIndex>=h.maps.maxNumberOfMapsShownAtTheSameTime)return this._showLimitMessage(),null}else if((b+1)*this._limitedPlacingInfo.numMapsPerArea>h.maps.maxNumberOfMapsShownAtTheSameTime)return this._showLimitMessage(),null}return this._placeMapPromise=A.invoke(this,"_doPlaceMap")},_doPlaceMap:function(){function b(){p.removeProgress(a.content);
a._finalizePlaceMap();a._showErrorMessage(!0);a.onMapLoadError()}var a=this;this._showErrorMessage(!1);this._isPlacingMapFlag&&this._finalizePlaceMap();m.empty(this.content);this._destroyMap();p.showProgress(this.content);this.onContentLoadingStart();this._isPlacingMapFlag=!0;this._legendController=new w;this._legendController.addCallback(function(c){a.showMapLegend=c;a.onLegendVisibilityChanged()},"mapContainer");this.viewModel.dynamicReportInfo&&this.own(this.viewModel.registerLegendController(this._legendController,
this._calculatorFieldName,this.currentFeatureIndex));this._additionalLayerInfos&&this.viewModel.dynamicReportInfo&&!this._locatorPointsControllers&&(this._locatorPointsControllers=[],this._additionalLayerInfos.forEach(function(a,b){a.index=b;if(a.isLocatorLayer){var c=this.viewModel.getLocatorPointsController(a.calculatorInfo,this.currentFeatureIndex);a.layerName&&c.setLayerName(this._calculatorFieldName,a.layerName);c.setRendererJson(this._calculatorFieldName,a.rendererJson);c.setLayerIndex(this._calculatorFieldName,
b);this.own(c);this._locatorPointsControllers.push(c)}},this),this._stdPolygonsControllers=[],this._additionalLayerInfos.forEach(function(b,d){b.index=d;if(b.isComparisonLayer){var c=function(c){c=a.viewModel.getStdPolygonsController(b.calculatorName,c);c.setRendererJson(a._calculatorFieldName,b.rendererJson);b.labelRendererJson&&c.setLabelRendererJson(a._calculatorFieldName,b.labelRendererJson);c.setLayerIndex(a._calculatorFieldName,d);a.own(c);a._stdPolygonsControllers.push(c)};this.viewModel.dynamicReportInfo.isMultiFeature?
this.viewModel.dynamicReportInfo.analysisAreas.forEach(function(a,b){c(b)}):c(this.currentFeatureIndex)}},this));return l(this._createMapFunc(this.content,{areaIndex:this.currentFeatureIndex,defaultBasemapId:this._defaultBasemapId,webMapId:this._webMapId,additionalLayerInfos:this._additionalLayerInfos&&this._additionalLayerInfos.filter(function(a){return!!a.url}),locatorPointsControllers:this._locatorPointsControllers,stdPolygonsControllers:this._stdPolygonsControllers,thisAreasHighlightController:this.viewModel.getThisAreasHighlightController(),
legendController:this._legendController,waitForLoad:!0,extent:this._mapExtentPending,pinSymbolJson:this._pinSymbolJson,areaSymbolJsons:this._areaSymbolJsons,areaSymbolRamp:this._areaSymbolRamp,calculatorFieldName:this._calculatorFieldName}),function(c){a.showMapLegend&&a._legendController.setLegendVisible(!0);a._locatorPointsControllers&&a._locatorPointsControllers.forEach(function(b){b.setMapInfo(a._calculatorFieldName,c)});a._stdPolygonsControllers&&a._stdPolygonsControllers.forEach(function(b){b.setMapInfo(a._calculatorFieldName,
c)});var d=c&&c.map;a._destroyMap();if(!a.domNode&&d)d.destroy();else{a._currentMap=d;a._syncWithPanelScale();for(var f=n("svg",a.domNode),g=0;g<f.length;g++)f[g].style.willChange="auto";d?(a.own(d),p.removeProgress(a.content),a._finalizePlaceMap()):b()}},b)},_finalizePlaceMap:function(){this._isPlacingMapFlag&&(this._isPlacingMapFlag=!1,this.onContentLoadingEnd())},_showLimitMessage:function(){if(this.domNode){var b=m.create("div",{"class":"esriGEReportPlayerPanelErrorMessage",innerHTML:1===this._limitedPlacingInfo.numVisibleAreas?
u.substitute(k.mapLimitErrorSingle,[h.maps.maxNumberOfMapsShownAtTheSameTime]):k.mapLimitErrorMulti},this.domNode);b.style.color=this.viewModel.getDocumentDefaultStyles().color;b.style.paddingTop=this.getHeight()/2-20+"px";z.hide(this.contentBlock)}},isLegendVisible:function(){return this.showMapLegend},setLegendVisible:function(b,a){this.showMapLegend=b;return this._legendController&&this._legendController.setLegendVisible(b,a)},_mapExtentPending:null,getVisualState:function(){return{type:"map",
mapExtent:this._currentMap&&this._currentMap.extent&&this._currentMap.extent.toJson(),showLegend:this.isLegendVisible()}},setVisualState:function(b){var a=this;this._mapExtentPending=null;if(b)return l(this.getRenderPromise(),function(){b.mapExtent&&(a._currentMap&&a._currentMap.setExtent?a._currentMap.setExtent(new v(b.mapExtent)):a._mapExtentPending=b.mapExtent);a._syncWithPanelScale();return l(a._currentMap&&a._currentMap._extentDfd&&a._currentMap._extentDfd.promise,function(){if(void 0!==b.showLegend)return a.setLegendVisible(b.showLegend)})})},
notifyShown:function(){},_panelScale:null,_toolbarCreateH:null,notifyPanelScaleChanged:function(b){this._panelScale=b;this._syncWithPanelScale()},_syncWithPanelScale:function(){if(this._currentMap){for(var b,a=this.parentWidget;a&&!a.isSection;)(a=a.parentWidget)&&a.isSection&&(b=a);var c=b&&n(".sectionDynamicSettings_toolbar",b.domNode)[0],d=c?1:1/this._panelScale,f=32*d+8;this._toolbarCreateH&&this._toolbarCreateH.remove();b&&!c&&(this._toolbarCreateH=t.after(b,"onDynamicSettingsButtonsCreated",
this._syncWithPanelScale.bind(this)));[".esriSimpleSliderTR",".HomeButton",".mapNavigationLockButton"].forEach(function(a){var e=n(a,b&&b.domNode||this.domNode)[0];e&&(c&&e.parentNode!==c&&m.place(e,c),".mapNavigationLockButton"===a&&50<this._currentMap.root.clientHeight-(f+e.clientHeight*d)&&(f+=20),c&&(e.style.right="0px"),e.style.top=f+"px",e.style.transformOrigin="100% 0%",e.style.transform="scale("+d+")",e.style["webkit-transform"]="scale("+d+")",f+=(e.clientHeight+(".esriSimpleSliderTR"===a?
2:0))*d+5)},this)}},onLegendVisibilityChanged:function(){},destroy:function(){this._finalizePlaceMap();this._destroyMap();this.inherited(arguments)},_destroyMap:function(){this._currentMap&&(this._currentMap.destroy(),this._currentMap=null)}})});