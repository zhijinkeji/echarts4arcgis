// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/_ServerSerializationSupport","require dojo/_base/declare dojo/_base/lang esri/dijit/geoenrichment/promise/all esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when ./supportClasses/ReportDataProcessor ./supportClasses/tasks/parsers/DataXMLParser ./supportClasses/tasks/RunReportTask ./supportClasses/areas/AnalysisAreaUtil ./supportClasses/areas/AnalysisAreaJsonUtil ./supportClasses/CustomReportsManager ./supportClasses/GEUtil ../core/supportClasses/ReportTemplateTypes ../core/conversion/PortalToEditorConverter".split(" "),
function(x,y,z,A,B,k,n,C,D,p,h,E,F,G,H){function q(){var b=new B;x(["./supportClasses/attachments/AttachmentsStoreSerializer","../core/supportClasses/templateJsonUtils/TemplateJsonSerializer","../core/conversion/portalToEditorUtils/variables/PlayerVariableProvider","./commands/mapToImage/MapToURLUtil","esri/dijit/geoenrichment/utils/ProjectionUtil"],function(a,l,f,g,d){m=a;r=l;t=f;u=g;v=d;b.resolve()});return b.promise}var m,r,t,u,v;return y(null,{reportDataToServerData:function(b){var a=b.getReportData();
return q().then(function(){return A({files:a.reportObject.templateData.getFiles(),attachmentsProvider:a.attachmentsStore&&m.getAttachmentsStoreJson(a.attachmentsStore,{numAreas:a.analysisAreas.length,saveImages:!0})}).then(function(b){var f=D.CreateReportResultCache.getResults()[0].originalXMLs[0];b.files.push({name:"data.xml",data:f});var f={reportItem:{properties:{isMultiFeature:a.reportObject.isMultiFeature?"true":"false"},resources:b.files},customLogo:a.customLogo,portalUrl:a.config.portalUrl,
geometryServiceUrl:a.config.geometryServiceUrl,printMapTaskUrl:a.config.printMapTaskUrl,reverseAnalysisAreasOnMap:a.reverseAnalysisAreasOnMap},g=h.areasToJson(a.analysisAreas),d=a.combinedAreasInfo&&h.combinedAreasInfoToJson(a.combinedAreasInfo);f.sites=d.groups.map(function(a,d){var c=z.mixin({},a);c.areas=a.indexes.map(function(a){return g[a]});delete c.indexes;if(b.attachmentsProvider&&b.attachmentsProvider.supportsMultipleAreas||0===d)if(a=b.attachmentsProvider.areaAttachments[a.indexes[0]])c.images=
a.images,c.attributes=a.attributes,c.notes=a.notes;return c});console.log(f);return f})})},reportDataFromServerData:function(b){function a(a){var c=E.prepareCustomReportFromItem(b.reportItem);c.isGraphicReport=!0;c.portalJson={files:d};return k(H.provideEditorJson(c,{variableProvider:a}),function(){c.templateJson=r.deserialize(c.templateJson);delete c.portalJson;return c})}function l(a,b){var c=d.filter(function(a){return"data.xml"===a.name})[0],e=/.*\.(png|jpg|jpeg|json)$/i,f={};d.forEach(function(a){e.test(a.name)&&
(f[a.name]=a.data)});a={selectedReport:a,areaData:C.parse(c.data,function(a,b){return f[b]||b})};n.applyRunReportAndGetDataResults(a,b)}var f=this,g=b.reportItem.resources,d;if(Array.isArray(g))d=g;else{d=[];for(var w in g)d.push({name:w,data:g[w]})}return q().then(function(){var d=new t;return k(a(d),function(a){p.parseSites(b);var c=h.areasFromJson(b.analysisAreas),e={isClassic:!1,isMultiFeature:a.isMultiFeature&&1<c.length,reportType:a.type||G.STANDARD,reportTitle:a.title||"",templateJson:a.templateJson,
reportObject:a,fieldData:{metadata:{},areaData:[],errors:[]},analysisAreas:c,combinedAreasInfo:b.combinedAreasInfo&&h.combinedAreasInfoFromJson(b.combinedAreasInfo)||{},reverseAnalysisAreasOnMap:b.reverseAnalysisAreasOnMap,infographicOptions:f._infographicOptionsProvider.getInfographicOptions({geoenrichmentUrl:"",countryID:"",reportID:"",analysisAreas:c}),attachmentsStore:b.attachmentsProvider&&m.getAttachmentsStoreFromJson(b.attachmentsProvider),geClient:null,templateVariableProvider:d,config:{portalUrl:b.portalUrl,
geoenrichmentUrl:null,geometryServiceUrl:b.geometryServiceUrl,printMapTaskUrl:b.printMapTaskUrl,countryID:null,hierarchy:null,reportID:a.reportID,variables:null},customLogo:b.customLogo};p.populateCombinedAreasInfo(e.combinedAreasInfo,e.analysisAreas);l(a,e);F.setGeoenrichmentUrl(e.config.geoenrichmentUrl);e.config.geometryServiceUrl&&v.setGeometryServiceUrl(e.config.geometryServiceUrl);e.config.printMapTaskUrl&&u.setPrintMapTaskUrl(e.config.printMapTaskUrl);return k(e.attachmentsStore&&n.populateReportDataFromAttachmentsStore(e,
e.attachmentsStore),function(){return e})})})}})});